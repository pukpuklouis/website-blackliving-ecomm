---
import { PRODUCT_TYPE_TEMPLATES } from "@blackliving/types";
import Breadcrumbs from "../components/blog/Breadcrumbs.astro";
import CategoryImageBanner from "../components/CategoryImageBanner.astro";
import CTA from "../components/CTA.astro";
import ProductCard from "../components/ProductCard.astro";
// Base layout for all Black Living product category pages
import BaseLayout from "../layouts/BaseLayout.astro";
import type { CategoryConfig } from "../types/category.ts";

export type Props = {
  categoryConfig: CategoryConfig;
};

type ApiProduct = {
  id: string;
  name: string;
  slug: string;
  images?: string[];
  features?: string[];
  variants?: { price?: number; originalPrice?: number }[];
  inStock?: boolean;
  featured?: boolean;
};

const { categoryConfig } = Astro.props;

const categorySlug = categoryConfig.slug || categoryConfig.category;
const categoryUrlPath = categoryConfig.urlPath || `/${categorySlug}`;
const features = Array.isArray(categoryConfig.features)
  ? categoryConfig.features
  : [];
const [
  primaryFeature = "品質保證",
  secondaryFeature = "優質價格，物超所值",
  tertiaryFeature = "貼心服務",
] = features;
const ACCESSORY_SUBTYPE_LABELS: Record<string, string> = {
  pillow: "枕頭",
  "sheet-set": "寢具組",
  protector: "保潔墊",
  duvet: "羽絨被",
  topper: "記憶床墊／Topper",
  "adjustable-base": "電動床架",
  foundation: "下墊",
};

const accessorySubtypeSet = new Set(
  Object.values(PRODUCT_TYPE_TEMPLATES)
    .filter((template) => template.category === "accessories")
    .map((template) => template.id)
);

const subtypeSlugPattern = /^[a-z0-9,-]+$/;
const isAccessoriesCategory = categorySlug === "accessories";
const rawSubtypeParam = Astro.url?.searchParams?.get("type") ?? null;
const normalizedSubtype =
  rawSubtypeParam && subtypeSlugPattern.test(rawSubtypeParam)
    ? rawSubtypeParam.toLowerCase()
    : null;
// Validate that all comma-separated types are valid
const hasValidSubtype = Boolean(
  isAccessoriesCategory &&
    normalizedSubtype &&
    normalizedSubtype
      .split(",")
      .every((type) => accessorySubtypeSet.has(type.trim()))
);
const appliedSubtype = hasValidSubtype ? normalizedSubtype : null;
// Generate label for multiple types
const activeSubtypeLabel = (() => {
  if (!isAccessoriesCategory) {
    return null;
  }
  if (!appliedSubtype) {
    return "全部精選周邊";
  }
  return appliedSubtype
    .split(",")
    .map((type) => ACCESSORY_SUBTYPE_LABELS[type.trim()] || type)
    .join("、");
})();
const invalidSubtypeQuery =
  isAccessoriesCategory && rawSubtypeParam && !appliedSubtype
    ? rawSubtypeParam
    : null;

// API configuration
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || "http://localhost:8787";

// SEO and page metadata
const pageTitle = categoryConfig.title;
const pageDescription = categoryConfig.description;
const canonicalUrl = new URL(
  categoryUrlPath,
  Astro.site || "https://www.blackliving.tw"
);

// Fetch products from API
let products: ApiProduct[] = [];
let error: string | null = null;
let isLoading = false;

try {
  isLoading = true;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10_000); // 10s timeout

  const productApiUrl = new URL("/api/products", API_BASE);
  productApiUrl.searchParams.set("category", categorySlug);
  if (appliedSubtype) {
    productApiUrl.searchParams.set("subCategory", appliedSubtype);
  }

  const response = await fetch(productApiUrl.toString(), {
    signal: controller.signal,
    headers: {
      Accept: "application/json",
      "User-Agent": "BlackLiving-Web/1.0",
    },
  });

  clearTimeout(timeoutId);

  if (!response.ok) {
    throw new Error(`API請求失敗 (${response.status}): ${response.statusText}`);
  }

  const data = await response.json();

  // Extract products from the API response structure
  if (data?.success && Array.isArray(data.data?.products)) {
    products = data.data.products;
  } else {
    console.error("API未返回正確的產品陣列格式:", data);
    products = [];
  }
} catch (err) {
  console.error(`獲取${categoryConfig.series}產品時發生錯誤:`, err);
  if (err instanceof Error && err.name === "AbortError") {
    error = "請求逾時，請稍後再試";
  } else if (err instanceof Error) {
    error = err.message;
  } else {
    error = "發生未知錯誤";
  }
} finally {
  isLoading = false;
}

// Transform products for ProductCard component with enhanced data
const transformedProducts = Array.isArray(products)
  ? products.map((product) => ({
      id: product.id,
      name: product.name,
      series: categoryConfig.series,
      image: product.images?.[0] || "/images/placeholder-mattress.jpg",
      features: product.features || [],
      priceFrom: product.variants?.[0]?.price || null,
      originalPrice: product.variants?.[0]?.originalPrice || null,
      href: `${categoryUrlPath}/${product.slug}`,
      inStock: product.inStock ?? true,
      featured: product.featured ?? false,
    }))
  : [];

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: pageTitle,
  description: pageDescription,
  url: canonicalUrl.toString(),
  breadcrumb: {
    "@type": "BreadcrumbList",
    itemListElement: [
      {
        "@type": "ListItem",
        position: 1,
        name: "首頁",
        item: Astro.site?.toString() || "https://www.blackliving.tw",
      },
      {
        "@type": "ListItem",
        position: 2,
        name: categoryConfig.series,
        item: canonicalUrl.toString(),
      },
    ],
  },
  mainEntity: {
    "@type": "ItemList",
    numberOfItems: transformedProducts.length,
    itemListElement: transformedProducts.map((product, index) => ({
      "@type": "Product",
      position: index + 1,
      name: product.name,
      description: `${categoryConfig.series} - ${product.name}`,
      image: product.image,
      url: new URL(
        product.href,
        Astro.site || "https://www.blackliving.tw"
      ).toString(),
      brand: {
        "@type": "Brand",
        name: categoryConfig.brand,
      },
      category: "床墊",
      ...(product.priceFrom && {
        offers: {
          "@type": "Offer",
          price: product.priceFrom,
          priceCurrency: "TWD",
          availability: product.inStock
            ? "https://schema.org/InStock"
            : "https://schema.org/OutOfStock",
        },
      }),
    })),
  },
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl.toString()}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)}/>

  <!-- Enhanced Meta Tags -->
  <meta slot="head" property="og:title" content={pageTitle}>
  <meta slot="head" property="og:description" content={pageDescription}>
  <meta slot="head" property="og:url" content={canonicalUrl.toString()}>
  <meta slot="head" property="og:type" content="website">
  <meta slot="head" property="og:locale" content="zh_TW">
  <meta slot="head" name="twitter:card" content="summary_large_image">
  <meta slot="head" name="twitter:title" content={pageTitle}>
  <meta slot="head" name="twitter:description" content={pageDescription}>
  <meta slot="head" name="keywords" content={categoryConfig.seoKeywords}>
  <meta slot="head" name="robots" content="index,follow">
  <link slot="head" rel="canonical" href={canonicalUrl.toString()}>

  <main class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <Breadcrumbs
      category={{ name: categoryConfig.series, slug: categoryConfig.slug }}
    />
    <!-- Hero Section -->
    <CategoryImageBanner
      categoryConfig={categoryConfig}
      className="hidden md:block mb-12 rounded-xl overflow-hidden"
      aspectRatio="11/3"
    />
    <CategoryImageBanner
      categoryConfig={categoryConfig}
      className="block md:hidden mb-12 rounded-xl overflow-hidden"
      aspectRatio="11/6"
    />
    <!-- Error State -->
    {error && (
        <div
          class="bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg mb-8"
          role="alert"
        >
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <div>
              <h3 class="font-semibold">載入產品時發生錯誤</h3>
              <p class="mt-1">{error}</p>
              <p class="mt-2 text-sm">
                請
                <a href="javascript:location.reload()" class="underline hover:no-underline">
                  重新整理頁面
                </a>
                或稍後再試
              </p>
            </div>
          </div>
        </div>
      )}

    <!-- Loading State -->
    {isLoading && (
        <div class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black" />
          <p class="mt-4 text-gray-600">載入產品中...</p>
        </div>
      )}

    <!-- Products Grid -->
    {!isLoading && (
        <section aria-labelledby="products-heading">
          <h2 id="products-heading" class="sr-only">
            {categoryConfig.series}產品列表
          </h2>

          {transformedProducts.length > 0 ? (
            <>
              <div class="flex justify-between items-center mb-6">
                <p class="text-gray-600">
                  找到 {transformedProducts.length} 項產品
                  {isAccessoriesCategory && activeSubtypeLabel && (
                    <span class="ml-3 text-sm text-gray-500">已篩選：{activeSubtypeLabel}</span>
                  )}
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8" role="list">
                {transformedProducts.map((product: any) => (
                  <div role="listitem">
                    <ProductCard product={product} />
                  </div>
                ))}
              </div>
            </>
          ) : (
            !error && (
              <div class="text-center py-16">
                <svg
                  class="w-16 h-16 mx-auto text-gray-300 mb-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                  />
                </svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">目前沒有可用的產品</h3>
                <p class="text-gray-600 mb-6">我們正在更新產品資訊，請稍後再回來查看</p>
                <a
                  href="/"
                  class="bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition-colors"
                >
                  返回首頁
                </a>
              </div>
            )
          )}
        </section>
      )}
    <!-- CTA Section -->
  </main>
  <CTA
    title="準備好體驗頂級睡眠了嗎？"
    description="歡迎蒞臨我們的實體展間，親自體驗席夢思黑標床墊的舒適感受。"
    primaryButtonText="立即預約試躺"
    primaryButtonHref="/appointment"
    secondaryButtonText="Line 線上諮詢"
    secondaryButtonHref="https://line.me/R/ti/p/@blackking"
    secondaryButtonTarget="_blank"
  />
  {invalidSubtypeQuery && (
      <script
        type="module"
        set:html={`(function(){const invalidValue=${JSON.stringify(
          invalidSubtypeQuery
        )};console.warn('Unknown accessories subtype filter:',invalidValue);if(typeof window!=='undefined' && typeof gtag!=='undefined'){gtag('event','invalid_accessory_filter',{event_category:'accessories',event_label:invalidValue});}})();`}
      />
    )}
</BaseLayout>
