---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/blog/Breadcrumbs.astro';
import PostHeader from '../components/blog/PostHeader.astro';
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkGfm from 'remark-gfm';
import remarkSmartypants from 'remark-smartypants';
import remarkRehype from 'remark-rehype';
import rehypeStringify from 'rehype-stringify';

interface BlogPost {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  content: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
  seoTitle?: string;
  seoDescription?: string;
}

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

export interface Props {
  post: BlogPost;
  category?: PostCategory | null;
  relatedPosts?: BlogPost[];
  seoTitle: string;
  seoDescription: string;
  ogImage: string;
}

const { post, category, relatedPosts = [], seoTitle, seoDescription, ogImage } = Astro.props;

// Process markdown content using Astro's internal processing approach
const processor = unified()
  .use(remarkParse)
  .use(remarkGfm) // GitHub-flavored markdown (enabled by default in Astro)
  .use(remarkSmartypants) // Smart punctuation (enabled by default in Astro)
  .use(remarkRehype)
  .use(rehypeStringify);

const processedContent = await processor.process(post.content);
const htmlContent = processedContent.toString();
---

<BaseLayout title={seoTitle} description={seoDescription} image={ogImage} type="article" publishedTime={post.publishedAt} class="blog">
  <main class='container mx-auto px-4 py-8'>
    <!-- Breadcrumb -->
    <Breadcrumbs post={post} category={category} />

    <article class='max-w-4xl mx-auto'>
      <!-- Article Header -->
      <PostHeader post={post} category={category} />

      <!-- Article Content -->
      <div class='blog-content prose prose-lg max-w-none mb-12'>
        <div set:html={htmlContent} />
      </div>

      <!-- Tags -->
      {
        post.tags && post.tags.length > 0 && (
          <div class='mb-8'>
            <h3 class='text-lg font-semibold text-gray-900 mb-3'>標籤</h3>
            <div class='flex flex-wrap gap-2'>
              {post.tags.map(tag => (
                <span class='blog-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700'>
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )
      }
    </article>

    <!-- Related Posts -->
    {
      relatedPosts.length > 0 && (
        <section class='max-w-4xl mx-auto'>
          <h2 class='text-2xl font-bold text-gray-900 mb-8'>相關文章</h2>
          <div class='grid grid-cols-1 md:grid-cols-3 gap-6'>
            {relatedPosts.map(relatedPost => (
              <article class='blog-related-post bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow'>
                {relatedPost.featuredImage && (
                  <img
                    src={relatedPost.featuredImage}
                    alt={relatedPost.title}
                    class='w-full h-32 object-cover'
                  />
                )}
                <div class='p-4'>
                  <div class='flex items-center mb-2'>
                    <span class='inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'>
                      {relatedPost.category}
                    </span>
                  </div>
                  <h3 class='text-lg font-semibold text-gray-900 mb-2'>
                    <a href={`/posts/${relatedPost.slug}`} class='hover:text-blue-600'>
                      {relatedPost.title}
                    </a>
                  </h3>
                  <p class='text-gray-600 text-sm line-clamp-2'>
                    {relatedPost.excerpt || relatedPost.description}
                  </p>
                </div>
              </article>
            ))}
          </div>
        </section>
      )
    }
  </main>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
