---
import type { BlogPost, PostCategory } from "@blackliving/types";

export type Props = {
  // Make post optional for category-only breadcrumbs
  post?: Pick<BlogPost, "title">;
  // Allow flexible category input - can be full PostCategory or simple object
  category?:
    | PostCategory
    | { name: string; slug: string; color?: string; icon?: string }
    | string
    | null;
};

const { post, category } = Astro.props as Props;

type NormalizedCategory = {
  slug: string;
  name: string;
  color?: string;
  icon?: string;
} | null;

// Category slug/name mappings for known categories
const CATEGORY_MAPPINGS: Record<string, { slug: string; name: string }> = {
  "customer-reviews": { slug: "customer-reviews", name: "部落格推薦" },
  顧客好評: { slug: "customer-reviews", name: "部落格推薦" },
  "Customer Reviews": { slug: "customer-reviews", name: "部落格推薦" },
  部落格推薦: { slug: "customer-reviews", name: "部落格推薦" },
  "simmons-knowledge": { slug: "simmons-knowledge", name: "席夢思小知識" },
  席夢思小知識: { slug: "simmons-knowledge", name: "席夢思小知識" },
  "Simmons Knowledge": { slug: "simmons-knowledge", name: "席夢思小知識" },
  "blog-post": { slug: "blog-post", name: "好文分享" },
  好文分享: { slug: "blog-post", name: "好文分享" },
  部落格文章: { slug: "blog-post", name: "好文分享" },
  Blog: { slug: "blog-post", name: "好文分享" },
  cat_001: { slug: "blog-post", name: "好文分享" },
  cat_002: { slug: "customer-reviews", name: "部落格推薦" },
  cat_003: { slug: "simmons-knowledge", name: "席夢思小知識" },
};

function normalizeObjectCategory(
  input: Record<string, unknown>
): NormalizedCategory {
  const inputSlug = typeof input.slug === "string" ? input.slug : undefined;
  const inputName = typeof input.name === "string" ? input.name : undefined;
  const slug =
    inputSlug ||
    (inputName ? inputName.toLowerCase().replace(/\s+/g, "-") : undefined);
  const name = inputName || inputSlug || "";
  if (!(slug && name)) {
    return null;
  }
  return {
    slug,
    name,
    color: typeof input.color === "string" ? input.color : undefined,
    icon: typeof input.icon === "string" ? input.icon : undefined,
  };
}

function normalizeStringCategory(input: string): NormalizedCategory {
  const raw = input.trim();
  const mapped = CATEGORY_MAPPINGS[raw];
  if (mapped) {
    return mapped;
  }
  // Handle unknown cat_ prefixes
  if (raw.startsWith("cat_")) {
    return { slug: raw.slice(4), name: raw };
  }
  // Generic fallback
  const slug = raw.toLowerCase().replace(/\s+/g, "-");
  return { slug, name: raw || "好文分享" };
}

function normalizeCategory(input: unknown): NormalizedCategory {
  if (!input) {
    return null;
  }
  if (typeof input === "object" && input !== null) {
    return normalizeObjectCategory(input as Record<string, unknown>);
  }
  if (typeof input === "string") {
    return normalizeStringCategory(input);
  }
  return null;
}

const normalized = normalizeCategory(category);
const isBlogCategory =
  normalized &&
  ["blog-post", "customer-reviews", "simmons-knowledge"].includes(
    normalized.slug
  );
const basePath = normalized
  ? `${isBlogCategory ? "/blog" : "/shop"}/${normalized.slug}`
  : "";
---

<nav class="blog-breadcrumb mb-8" aria-label="麵包屑">
  <ol class="flex items-center space-x-2 text-sm text-gray-500">
    <li><a href="/" class="hover:text-gray-700">首頁</a></li>
    {normalized && (
        <>
          <li>/</li>
          <li>
            {post ? (
              <a href={`${basePath}`} class="hover:text-gray-700">
                {normalized.name}
              </a>
            ) : (
              <span class="font-semibold text-gray-900" aria-current="page">
                {normalized.name}
              </span>
            )}
          </li>
        </>
      )}
    {post && (
        <>
          <li>/</li>
          <li class="text-gray-900 font-semibold" aria-current="page">
            {post.title}
          </li>
        </>
      )}
  </ol>
</nav>
