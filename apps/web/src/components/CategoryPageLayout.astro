---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProductCard from './ProductCard.astro';
import type { CategoryConfig } from '../config/categories.ts';

export interface Props {
  categoryConfig: CategoryConfig;
}

const { categoryConfig } = Astro.props;

// API configuration
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

// SEO and page metadata
const pageTitle = categoryConfig.title;
const pageDescription = categoryConfig.description;
const canonicalUrl = new URL(categoryConfig.urlPath, Astro.site || 'https://blackliving.com.tw');

// Fetch products from API
let products: any[] = [];
let error: string | null = null;
let isLoading = false;

try {
  isLoading = true;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
  
  const response = await fetch(`${API_BASE}/api/products?category=${categoryConfig.category}`, {
    signal: controller.signal,
    headers: {
      'Accept': 'application/json',
      'User-Agent': 'BlackLiving-Web/1.0'
    }
  });
  
  clearTimeout(timeoutId);
  
  if (!response.ok) {
    throw new Error(`API請求失敗 (${response.status}): ${response.statusText}`);
  }
  
  const data = await response.json();
  
  // Extract products from the API response structure
  if (data && data.success && data.data && data.data.products && Array.isArray(data.data.products)) {
    products = data.data.products;
  } else {
    console.error('API未返回正確的產品陣列格式:', data);
    products = [];
  }
} catch (err) {
  console.error(`獲取${categoryConfig.series}產品時發生錯誤:`, err);
  if (err.name === 'AbortError') {
    error = '請求逾時，請稍後再試';
  } else {
    error = err instanceof Error ? err.message : '發生未知錯誤';
  }
} finally {
  isLoading = false;
}

// Transform products for ProductCard component with enhanced data
const transformedProducts = Array.isArray(products) ? products.map((product: any) => ({
  id: product.id,
  name: product.name,
  series: categoryConfig.series,
  image: product.images?.[0] || '/images/placeholder-mattress.jpg',
  features: product.features || [],
  priceFrom: product.variants?.[0]?.price || null,
  originalPrice: product.variants?.[0]?.originalPrice || null,
  href: `${categoryConfig.urlPath}/${product.slug}`,
  inStock: product.inStock ?? true,
  featured: product.featured ?? false
})) : [];

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": pageTitle,
  "description": pageDescription,
  "url": canonicalUrl.toString(),
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "首頁",
        "item": Astro.site?.toString() || 'https://blackliving.com.tw'
      },
      {
        "@type": "ListItem", 
        "position": 2,
        "name": categoryConfig.series,
        "item": canonicalUrl.toString()
      }
    ]
  },
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": transformedProducts.length,
    "itemListElement": transformedProducts.map((product, index) => ({
      "@type": "Product",
      "position": index + 1,
      "name": product.name,
      "description": `${categoryConfig.series} - ${product.name}`,
      "image": product.image,
      "url": new URL(product.href, Astro.site || 'https://blackliving.com.tw').toString(),
      "brand": {
        "@type": "Brand",
        "name": categoryConfig.brand
      },
      "category": "床墊",
      ...(product.priceFrom && {
        "offers": {
          "@type": "Offer",
          "price": product.priceFrom,
          "priceCurrency": "TWD",
          "availability": product.inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock"
        }
      })
    }))
  }
};
---

<BaseLayout 
  title={pageTitle} 
  description={pageDescription}
  canonical={canonicalUrl.toString()}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <!-- Enhanced Meta Tags -->
  <meta slot="head" property="og:title" content={pageTitle} />
  <meta slot="head" property="og:description" content={pageDescription} />
  <meta slot="head" property="og:url" content={canonicalUrl.toString()} />
  <meta slot="head" property="og:type" content="website" />
  <meta slot="head" property="og:locale" content="zh_TW" />
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={pageTitle} />
  <meta slot="head" name="twitter:description" content={pageDescription} />
  <meta slot="head" name="keywords" content={categoryConfig.seoKeywords} />
  <meta slot="head" name="robots" content="index,follow" />
  <link slot="head" rel="canonical" href={canonicalUrl.toString()} />

  <!-- Breadcrumb Navigation -->
  <nav class="bg-gray-50 py-3" aria-label="breadcrumb">
    <div class="container mx-auto px-4">
      <ol class="flex items-center space-x-2 text-sm text-gray-600" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" class="hover:text-black transition-colors" itemprop="item">
            <span itemprop="name">首頁</span>
          </a>
          <meta itemprop="position" content="1" />
        </li>
        <li class="before:content-['/'] before:mx-2 before:text-gray-400">
          <span class="font-semibold text-black" itemprop="name">{categoryConfig.series}</span>
          <meta itemprop="position" content="2" />
        </li>
      </ol>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <!-- Hero Section -->
    <header class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">{categoryConfig.series}</h1>
      <p class="text-xl text-gray-600 mb-6">{categoryConfig.description.split('。')[0]}。</p>
      <div class="flex flex-wrap justify-center gap-4 text-sm">
        {categoryConfig.features.map((feature) => (
          <span class="bg-black text-white px-3 py-1 rounded-full">{feature}</span>
        ))}
      </div>
    </header>
    
    <!-- Error State -->
    {error && (
      <div class="bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg mb-8" role="alert">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <div>
            <h3 class="font-semibold">載入產品時發生錯誤</h3>
            <p class="mt-1">{error}</p>
            <p class="mt-2 text-sm">請<a href="javascript:location.reload()" class="underline hover:no-underline">重新整理頁面</a>或稍後再試</p>
          </div>
        </div>
      </div>
    )}
    
    <!-- Loading State -->
    {isLoading && (
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
        <p class="mt-4 text-gray-600">載入產品中...</p>
      </div>
    )}
    
    <!-- Products Grid -->
    {!isLoading && (
      <section aria-labelledby="products-heading">
        <h2 id="products-heading" class="sr-only">{categoryConfig.series}產品列表</h2>
        
        {transformedProducts.length > 0 ? (
          <>
            <div class="flex justify-between items-center mb-6">
              <p class="text-gray-600">找到 {transformedProducts.length} 項產品</p>
              <button class="text-sm text-gray-500 hover:text-black transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                </svg>
                篩選與排序
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" role="list">
              {transformedProducts.map((product: any) => (
                <div role="listitem">
                  <ProductCard product={product} />
                </div>
              ))}
            </div>
          </>
        ) : !error && (
          <div class="text-center py-16">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">目前沒有可用的產品</h3>
            <p class="text-gray-600 mb-6">我們正在更新產品資訊，請稍後再回來查看</p>
            <a href="/" class="bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition-colors">
              返回首頁
            </a>
          </div>
        )}
      </section>
    )}
    
    <!-- Value Propositions -->
    <section class="mt-16 py-12 bg-gray-50 rounded-xl" aria-labelledby="benefits-heading">
      <div class="text-center">
        <h2 id="benefits-heading" class="text-2xl font-bold text-gray-900 mb-8">為什麼選擇黑哥家居？</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="text-center">
            <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-lg mb-2">品質保證</h3>
            <p class="text-gray-600">美國原廠授權經銷商，{categoryConfig.features[0]}</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-lg mb-2">最優價格</h3>
            <p class="text-gray-600">{categoryConfig.features[1] || '優質價格，物超所值'}</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 3H5a2 2 0 00-2 2v1m2 0h10M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17M17 13v4a2 2 0 01-2 2H9a2 2 0 01-2-2v-4m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-lg mb-2">貼心服務</h3>
            <p class="text-gray-600">{categoryConfig.features[2] || '專業服務，用心守護'}</p>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>