---
import AddToCartSection from './AddToCartSection';
import type { CategoryConfig } from '../types/category';

export interface Props {
  product: {
    id: string;
    name: string;
    slug: string;
    description: string;
    images: string[];
    variants: Array<{
      id: string;
      name: string;
      size?: string;
      firmness?: string;
      price: number;
      originalPrice?: number;
      inStock: boolean;
      stock?: number;
      sku?: string;
    }>;
    inStock: boolean;
    category?: string;
  };
  selectedVariantId?: string;
  categoryConfig?: CategoryConfig;
  className?: string;
}

const { 
  product, 
  selectedVariantId, 
  categoryConfig,
  className = '' 
} = Astro.props;

// Server-side validation and data preparation
if (!product) {
  throw new Error('Product data is required for AddToCartWrapper');
}

// Ensure product has proper structure for cart operations
const processedProduct = {
  ...product,
  // Ensure images array exists
  images: product.images && product.images.length > 0 
    ? product.images 
    : ['/images/placeholder-mattress.jpg'],
  
  // Ensure variants array exists and is properly structured
  variants: product.variants && product.variants.length > 0 
    ? product.variants.map(variant => ({
        ...variant,
        // Ensure required fields have defaults
        name: variant.name || 'Standard',
        price: typeof variant.price === 'number' ? variant.price : 0,
        inStock: typeof variant.inStock === 'boolean' ? variant.inStock : false,
        // Add category context to variant name if available
        displayName: categoryConfig?.series ? `${categoryConfig.series} - ${variant.name}` : variant.name,
      }))
    : [{
        id: 'default',
        name: 'Standard',
        price: 0,
        inStock: product.inStock || false,
      }],
  
  // Add category info if available
  category: categoryConfig?.series || product.category,
};

// Determine initial selected variant
const initialVariantId = selectedVariantId || processedProduct.variants[0]?.id;

// Check if product has valid pricing
const hasValidPricing = processedProduct.variants.some(variant => variant.price > 0);

// Server-side logging for debugging (only in development)
if (import.meta.env.MODE === 'development') {
  console.log('AddToCartWrapper - Product processed:', {
    productId: processedProduct.id,
    productName: processedProduct.name,
    variantsCount: processedProduct.variants.length,
    hasValidPricing,
    initialVariantId,
  });
}
---

<!-- 
  Astro component that wraps the React AddToCartSection with proper hydration
  This follows Astro's island architecture pattern for optimal performance
-->
{hasValidPricing ? (
  <!-- Product with valid pricing - show full cart functionality -->
  <AddToCartSection
    product={processedProduct}
    selectedVariantId={initialVariantId}
    className={className}
    client:load
  />
) : (
  <!-- Fallback for products without pricing - show contact form -->
  <div class={`bg-white border rounded-xl shadow-sm p-6 ${className}`}>
    <!-- Product Info Header -->
    <div class="mb-6">
      {categoryConfig?.series && (
        <div class="inline-block bg-black text-white text-sm px-3 py-1 rounded mb-2">
          {categoryConfig.series}
        </div>
      )}
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">
        {processedProduct.name}
      </h2>
      {processedProduct.description && (
        <p class="text-gray-600">
          {processedProduct.description}
        </p>
      )}
    </div>

    <!-- Contact for Pricing Section -->
    <div class="space-y-4">
      <div class="p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border">
        <div class="text-center space-y-3">
          <div class="text-4xl">ğŸ’</div>
          <h3 class="text-lg font-semibold text-gray-900">
            å°ˆæ¥­å®¢è£½åŒ–æœå‹™
          </h3>
          <p class="text-sm text-gray-600">
            æ­¤å•†å“éœ€è¦å°ˆæ¥­é¡§å•è©•ä¼°æ‚¨çš„éœ€æ±‚å¾Œæä¾›æœ€é©åˆçš„æ–¹æ¡ˆèˆ‡å ±åƒ¹
          </p>
        </div>
      </div>

      <!-- Contact Options -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <a
          href="tel:+886-2-12345678"
          class="flex items-center justify-center space-x-2 px-6 py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors group"
        >
          <span class="text-lg">ğŸ“</span>
          <div class="text-left">
            <div class="text-sm opacity-90">ç«‹å³æ’¥æ‰“</div>
            <div>02-1234-5678</div>
          </div>
        </a>
        <a
          href="mailto:info@blackliving.com?subject=ç”¢å“è«®è©¢ - {processedProduct.name}"
          class="flex items-center justify-center space-x-2 px-6 py-4 border-2 border-black text-black font-semibold rounded-lg hover:bg-black hover:text-white transition-colors group"
        >
          <span class="text-lg">âœ‰ï¸</span>
          <div class="text-left">
            <div class="text-sm opacity-70 group-hover:opacity-90">ç™¼é€éƒµä»¶</div>
            <div>å°ˆæ¥­è«®è©¢</div>
          </div>
        </a>
      </div>

      <!-- Service Features -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-4 border-t">
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <span class="text-blue-600">ğŸš›</span>
          <span>å…è²»é…é€å®‰è£</span>
        </div>
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <span class="text-green-600">ğŸ›¡ï¸</span>
          <span>åŸå» å“è³ªä¿å›º</span>
        </div>
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <span class="text-purple-600">ğŸ’³</span>
          <span>åˆ†æœŸé›¶åˆ©ç‡</span>
        </div>
      </div>

      <!-- Additional Info -->
      <div class="text-xs text-gray-500 text-center pt-2 border-t">
        ğŸ’¡ æˆ‘å€‘çš„å°ˆæ¥­é¡§å•å°‡åœ¨ 24 å°æ™‚å…§èˆ‡æ‚¨è¯ç¹«ï¼Œæä¾›æœ€é©åˆæ‚¨çš„æ–¹æ¡ˆ
      </div>
    </div>
  </div>
)}

<!-- 
  Performance Optimization Notes for Astro:
  
  1. client:load directive ensures React component hydrates immediately
  2. Server-side data processing reduces client-side work
  3. Conditional rendering reduces bundle size for products without pricing
  4. Fallback UI is pure HTML/CSS for better performance
  5. Structured data preparation follows Astro's SSR best practices
-->