---
// Reusable featured products component with category filtering
import ProductCard from './ProductCard.astro';

export interface Props {
  title: string;
  category: 'simmons-black' | 'accessories' | 'us-imports';
  ctaText?: string;
  ctaHref?: string;
  image?: string;
  limit?: number;
  class?: string;
}

const {
  title,
  category,
  ctaText,
  ctaHref,
  image,
  limit = 6,
  class: className = ''
} = Astro.props;

// Map limit to valid Tailwind classes
const gridColsMap: Record<number, string> = {
  2: 'md:grid-cols-2',
  3: 'md:grid-cols-3',
  4: 'md:grid-cols-4',
  6: 'md:grid-cols-6',
};

const mdGridCols = gridColsMap[limit] || 'md:grid-cols-3';

// Fetch featured products from API
let products = [];
let error = null;

try {
  const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
  const apiUrl = `${apiBaseUrl}/api/products?category=${category}&featured=true&limit=${limit}`;
  const response = await fetch(apiUrl);

  if (!response.ok) {
    throw new Error(`Failed to fetch products: ${response.status}`);
  }

  const result = await response.json();

  if (result.success && result.data?.products) {
    // Map API data to ProductCard format
    products = result.data.products.map((product: any) => ({
      id: product.id,
      name: product.name,
      series: product.category === 'simmons-black' ? '席夢思黑標' :
             product.category === 'accessories' ? '周邊配件' :
             '美國進口',
      image: product.images?.[0] || '/products/placeholder.jpg',
      features: product.features || [],
      priceFrom: product.variants?.[0]?.price || null,
      href: `/${product.category}/${product.slug}`,
    }));
  }
} catch (err) {
  console.error('Error fetching featured products:', err);
  error = err instanceof Error ? err.message : 'Unknown error occurred';
}
---

<section class={`py-16 flex flex-col items-center mx-auto bg-white ${className}`}>
  <div class='container px-4'>
    <h3 class='text-3xl font-bold text-center mb-12'>{title}</h3>

    {error ? (
      <div class='text-center text-red-600 bg-red-50 p-4 rounded-lg'>
        載入產品時發生錯誤，請稍後再試。
      </div>
    ) : products.length === 0 ? (
      <div class='text-center text-gray-600 bg-gray-50 p-8 rounded-lg'>
        目前沒有精選產品，敬請期待。
      </div>
    ) : (
      <>
        <div class={`grid grid-cols-2 ${mdGridCols} gap-4 md:gap-8 mx-auto`}>
          {products.map((product: any) => <ProductCard product={product} />)}
        </div>

        <!-- {ctaText && ctaHref && (
          <div class='text-center mt-12'>
            <a
              href={ctaHref}
              class='inline-block bg-black text-white px-8 py-3 text-lg font-semibold rounded hover:bg-gray-800 transition-colors'
            >
              {ctaText}
            </a>
          </div>
        )} -->
      </>
    )}
  </div>
</section>
