---
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
const REDIRECT_FALLBACK = '/appointment';
---
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Black Living - 登入驗證</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: 'Noto Sans TC', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f6f6f6;
        color: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 24px;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 24px 48px -24px rgba(15, 23, 42, 0.25);
        padding: 32px;
        max-width: 420px;
        width: 100%;
      }
      .spinner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 4px solid #e5e7eb;
        border-top-color: #111827;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-top: 24px;
        padding: 12px 20px;
        border-radius: 9999px;
        border: none;
        background: #111827;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        text-decoration: none;
      }
      .btn:hover {
        background: #000;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <div id="status">
        <div class="spinner"></div>
        <h1>驗證連線中...</h1>
        <p>請稍候，我們正在確認您的登入資訊。</p>
      </div>
    </main>
    <script type="module">
      const statusEl = document.getElementById('status');
      const hash = window.location.hash || '';
      const params = new URLSearchParams(hash.startsWith('#') ? hash.slice(1) : hash);
      const token = params.get('token');

      const setStatus = (html) => {
        if (statusEl) {
          statusEl.innerHTML = html;
        }
      };

      async function completeMagicLink() {
        if (!token) {
          setStatus(`
            <h1>缺少驗證資訊</h1>
            <p>無法解析 Magic Link，請返回預約頁面重新請求。</p>
            <a class="btn" href="${REDIRECT_FALLBACK}">返回預約頁</a>
          `);
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/api/auth/callback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ token }),
          });

          const result = await response.json();

          if (!response.ok || !result?.success) {
            throw new Error(result?.error || 'Magic Link 驗證失敗');
          }

          const persisted = {
            state: {
              accessToken: result.tokens.accessToken,
              refreshToken: result.tokens.refreshToken,
              accessTokenExpiresAt: result.tokens.accessTokenExpiresAt,
              refreshTokenExpiresAt: result.tokens.refreshTokenExpiresAt,
              user: result.user,
              lastEmail: result.user?.email || '',
            },
            version: 0,
          };

          try {
            localStorage.setItem('reservation-auth', JSON.stringify(persisted));
          } catch (err) {
            console.warn('Failed to persist auth tokens', err);
          }

          const redirectTarget = result.redirectTo || REDIRECT_FALLBACK;

          setStatus(`
            <h1>登入成功！</h1>
            <p>已為您完成信箱驗證，正為您導回預約頁面。</p>
            <a class="btn" href="${redirectTarget}">立即返回預約</a>
          `);

          setTimeout(() => {
            window.location.replace(redirectTarget);
          }, 1500);
        } catch (error) {
          console.error(error);
          setStatus(`
            <h1>驗證失敗</h1>
            <p>${error instanceof Error ? error.message : 'Magic Link 驗證失敗，請重新請求登入連結。'}</p>
            <a class="btn" href="${REDIRECT_FALLBACK}">返回預約頁</a>
          `);
        }
      }

      completeMagicLink();
    </script>
  </body>
</html>