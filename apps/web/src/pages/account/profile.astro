---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AccountNav from '../../components/AccountNav.astro';
import ProfileTabs from '../../components/ui/ProfileTabs.tsx';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@blackliving/ui';
// This page will be protected by Better Auth middleware
---

<BaseLayout title="個人資料" description="管理您的帳號資訊、地址簿與偏好設定">
  <header>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight mb-2">個人資料</h1>
        <p class="text-muted-foreground">管理您的帳號資訊、地址簿與偏好設定</p>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <AccountNav currentPage="profile" />
        
        <div class="lg:col-span-3 min-w-0">
          <div class="min-w-[600px] min-h-[400px]">
            <ProfileTabs client:load />
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // Get API base URL
  const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

  // UI Elements
  const loading = document.getElementById('loading')!;
  const notAuthenticated = document.getElementById('not-authenticated')!;
  const profileForm = document.getElementById('profile-form') as HTMLFormElement;
  const updateBtn = document.getElementById('update-btn') as HTMLButtonElement;
  const updateText = document.getElementById('update-text')!;
  const updateSpinner = document.getElementById('update-spinner')!;
  const resetBtn = document.getElementById('reset-btn') as HTMLButtonElement;
  const message = document.getElementById('message')!;
  const syncIndicator = document.getElementById('sync-indicator')!;
  const analyticsSection = document.getElementById('analytics-section')!;

  // Form validation elements
  const nameError = document.getElementById('name-error')!;
  const phoneError = document.getElementById('phone-error')!;

  // Cache configuration for stale-while-revalidate pattern
  const profileCache = {
    basic: { data: null as any, timestamp: null as number | null, ttl: 300000 }, // 5 min
    full: { data: null as any, timestamp: null as number | null, ttl: 600000 },  // 10 min
    analytics: { data: null as any, timestamp: null as number | null, ttl: 900000 } // 15 min
  };

  let currentUser: any = null; // Used by auth check
  let originalFormData: any = null;
  let isFormDirty = false;

  // ======================
  // CACHING UTILITIES
  // ======================

  function isExpired(cacheEntry: typeof profileCache.basic): boolean {
    if (!cacheEntry.timestamp) return true;
    return Date.now() - cacheEntry.timestamp > cacheEntry.ttl;
  }

  function setCache(type: keyof typeof profileCache, data: any): void {
    profileCache[type] = {
      data,
      timestamp: Date.now(),
      ttl: profileCache[type].ttl
    };
  }

  function getCache(type: keyof typeof profileCache): any | null {
    const entry = profileCache[type];
    if (!entry.data || isExpired(entry)) return null;
    return entry.data;
  }

  async function refreshInBackground(type: keyof typeof profileCache): Promise<void> {
    try {
      const endpoint = type === 'basic' ? '/profile' : type === 'full' ? '/profile/full' : '/profile/analytics';
      const response = await fetch(`${API_BASE}/api/customers${endpoint}`, {
        credentials: 'include',
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          setCache(type, result.data);
          
          // Update UI if basic profile was refreshed
          if (type === 'basic' && result.data) {
            updateSyncIndicator(true);
          }
        }
      }
    } catch (error) {
      console.warn(`Background refresh failed for ${type}:`, error);
    }
  }

  // ======================
  // API FUNCTIONS
  // ======================

  async function checkAuth(): Promise<boolean> {
    try {
      const response = await fetch(`${API_BASE}/api/auth/session`, {
        credentials: 'include',
      });

      if (response.ok) {
        const data = await response.json();
        if (data.user) {
          currentUser = data.user;
          return true;
        }
      }
      return false;
    } catch (error) {
      console.error('Auth check failed:', error);
      return false;
    }
  }

  async function loadProfileData(type: 'basic' | 'full' | 'analytics'): Promise<any> {
    // Try cache first
    const cachedData = getCache(type);
    if (cachedData) {
      // Serve cached data immediately, refresh in background
      refreshInBackground(type);
      return cachedData;
    }

    // Fresh fetch if no cache
    try {
      const endpoint = type === 'basic' ? '/profile' : type === 'full' ? '/profile/full' : '/profile/analytics';
      const response = await fetch(`${API_BASE}/api/customers${endpoint}`, {
        credentials: 'include',
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          setCache(type, result.data);
          return result.data;
        }
      }
      throw new Error(`Failed to load ${type} profile`);
    } catch (error) {
      console.error(`Error loading ${type} profile:`, error);
      throw error;
    }
  }

  async function updateProfile(formData: Record<string, any>): Promise<any> {
    const response = await fetch(`${API_BASE}/api/customers/profile`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(formData),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Update failed');
    }

    const result = await response.json();
    
    // Clear cache to force fresh data
    profileCache.basic.data = null;
    profileCache.full.data = null;
    
    return result;
  }

  // ======================
  // VALIDATION FUNCTIONS
  // ======================

  function validateName(name: string): string | null {
    if (!name || name.trim().length === 0) {
      return '姓名為必填項目';
    }
    if (name.length > 100) {
      return '姓名不能超過 100 個字符';
    }
    return null;
  }

  function validatePhone(phone: string): string | null {
    if (!phone || phone.trim() === '') return null; // Phone is optional
    
    // Remove any spaces or dashes
    const cleanPhone = phone.replace(/[\s-]/g, '');
    
    // Taiwan mobile number validation: starts with 09 and has 10 digits total
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(cleanPhone)) {
      return '手機號碼格式不正確，請輸入 10 位數字（例：0912345678）';
    }
    return null;
  }

  // Email validation removed as email is read-only

  function showFieldError(errorElement: HTMLElement, error: string | null): void {
    if (error) {
      errorElement.textContent = error;
      errorElement.classList.remove('hidden');
    } else {
      errorElement.classList.add('hidden');
    }
  }

  function validateForm(): boolean {
    const formData = new FormData(profileForm);
    const name = formData.get('name') as string;
    const phone = formData.get('phone') as string;

    const nameErr = validateName(name);
    const phoneErr = validatePhone(phone);

    showFieldError(nameError, nameErr);
    showFieldError(phoneError, phoneErr);

    // Add visual feedback to form fields
    const nameField = document.getElementById('name') as HTMLInputElement;
    const phoneField = document.getElementById('phone') as HTMLInputElement;

    // Update field border colors based on validation with shadcn classes
    if (nameErr) {
      nameField.classList.add('border-destructive', 'focus-visible:ring-destructive');
      nameField.classList.remove('border-input', 'focus-visible:ring-ring');
    } else {
      nameField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      nameField.classList.add('border-input', 'focus-visible:ring-ring');
    }

    if (phoneErr) {
      phoneField.classList.add('border-destructive', 'focus-visible:ring-destructive');
      phoneField.classList.remove('border-input', 'focus-visible:ring-ring');
    } else {
      phoneField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      phoneField.classList.add('border-input', 'focus-visible:ring-ring');
    }

    return !nameErr && !phoneErr;
  }

  // ======================
  // UI FUNCTIONS
  // ======================

  function updateSyncIndicator(synced: boolean): void {
    if (synced) {
      syncIndicator.classList.remove('hidden');
      setTimeout(() => syncIndicator.classList.add('hidden'), 3000);
    }
  }

  function showProfile(): void {
    loading.classList.add('hidden');
    notAuthenticated.classList.add('hidden');
    profileForm.classList.remove('hidden');
  }

  function showNotAuthenticated(): void {
    loading.classList.add('hidden');
    profileForm.classList.add('hidden');
    notAuthenticated.classList.remove('hidden');
  }

  function showMessage(text: string, type: 'success' | 'error'): void {
    message.textContent = text;
    message.className = `p-4 rounded-lg border ${type === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`;
    message.classList.remove('hidden');
    
    setTimeout(() => {
      message.classList.add('hidden');
    }, 5000);
  }

  function setLoadingState(loading: boolean): void {
    updateBtn.disabled = loading;
    if (loading) {
      updateText.textContent = '更新中...';
      updateSpinner.classList.remove('hidden');
    } else {
      updateText.textContent = '更新資料';
      updateSpinner.classList.add('hidden');
    }
  }

  function populateForm(profileData: any): void {
    (document.getElementById('name') as HTMLInputElement).value = profileData.name || '';
    (document.getElementById('email') as HTMLInputElement).value = profileData.email || '';
    (document.getElementById('phone') as HTMLInputElement).value = profileData.phone || '';
    
    // Extended fields from customer profile
    if (profileData.customerProfile) {
      const cp = profileData.customerProfile;
      (document.getElementById('birthday') as HTMLInputElement).value = cp.birthday || '';
      
      // Handle shadcn Select components
      const genderTrigger = document.querySelector('[name="gender"] button[role="combobox"]');
      const contactTrigger = document.querySelector('[name="contactPreference"] button[role="combobox"]');
      
      if (cp.gender && genderTrigger) {
        const genderOptions: Record<string, string> = { 'male': '男性', 'female': '女性', 'other': '其他' };
        genderTrigger.textContent = genderOptions[cp.gender as string] || '請選擇性別';
      }
      
      if (cp.contactPreference && contactTrigger) {
        const contactOptions: Record<string, string> = { 'email': '電子郵件', 'phone': '電話', 'sms': '簡訊' };
        contactTrigger.textContent = contactOptions[cp.contactPreference as string] || '選擇聯絡方式';
      }
    }

    // Store original data for reset functionality
    originalFormData = new FormData(profileForm);
    isFormDirty = false;
  }

  function populateAnalytics(analyticsData: any): void {
    if (!analyticsData) return;

    document.getElementById('total-orders')!.textContent = analyticsData.orderCount || '0';
    document.getElementById('total-spent')!.textContent = analyticsData.totalSpent ? 
      `NT$ ${analyticsData.totalSpent.toLocaleString()}` : 'NT$ 0';
    document.getElementById('avg-order-value')!.textContent = analyticsData.avgOrderValue ? 
      `NT$ ${Math.round(analyticsData.avgOrderValue).toLocaleString()}` : 'NT$ 0';
    
    const segmentMap: Record<string, string> = {
      'vip': 'VIP 會員',
      'regular': '一般會員', 
      'new': '新會員',
      'dormant': '休眠會員'
    };
    
    const customerSegmentEl = document.getElementById('customer-segment')!;
    customerSegmentEl.textContent = segmentMap[analyticsData.segment] || '新會員';
    
    // Update styling based on segment
    customerSegmentEl.className = `text-lg font-semibold ${
      analyticsData.segment === 'vip' ? 'text-yellow-600' :
      analyticsData.segment === 'regular' ? 'text-blue-600' :
      'text-gray-600'
    }`;

    analyticsSection.classList.remove('hidden');
  }

  function resetForm(): void {
    if (originalFormData) {
      // Reset all form fields to original values
      for (const [key, value] of originalFormData.entries()) {
        const element = document.querySelector(`[name="${key}"]`) as HTMLInputElement | HTMLSelectElement;
        if (element) {
          element.value = value as string;
        }
      }
      isFormDirty = false;
    }
  }

  // ======================
  // EVENT HANDLERS
  // ======================

  // Track form changes for dirty state
  profileForm.addEventListener('input', () => {
    isFormDirty = true;
  });

  // Handle profile update with optimistic updates
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setLoadingState(true);

    const formData = new FormData(profileForm);
    const updateData: Record<string, any> = {};
    
    // Only include non-empty values
    formData.forEach((value, key) => {
      if (value && key !== 'email') { // Email is readonly
        if (key === 'phone') {
          // Clean phone number before sending
          const cleanPhone = (value as string).replace(/[\s-]/g, '');
          if (cleanPhone) {
            updateData[key] = cleanPhone;
          }
        } else if (key === 'gender' || key === 'contactPreference') {
          // Handle shadcn Select values
          const selectInput = document.querySelector(`[name="${key}"] input[type="hidden"]`) as HTMLInputElement;
          if (selectInput?.value) {
            updateData[key] = selectInput.value;
          }
        } else {
          updateData[key] = value;
        }
      }
    });

    try {
      // Optimistic update - show success immediately
      const currentData = getCache('basic');
      if (currentData) {
        Object.assign(currentData, updateData);
        updateSyncIndicator(true);
      }

      await updateProfile(updateData);
      
      showMessage('個人資料更新成功', 'success');
      isFormDirty = false;
      
      // Refresh profile data in background
      setTimeout(() => refreshInBackground('basic'), 1000);
      
    } catch (error) {
      console.error('Profile update failed:', error);
      showMessage(error instanceof Error ? error.message : '更新失敗，請稍後再試', 'error');
      
      // Revert optimistic update on error
      await loadBasicProfile();
    } finally {
      setLoadingState(false);
    }
  });

  // Reset button handler
  resetBtn.addEventListener('click', () => {
    if (isFormDirty) {
      if (confirm('確定要重設所有變更嗎？')) {
        resetForm();
        showMessage('表單已重設', 'success');
      }
    }
  });

  // Add real-time validation with enhanced visual feedback
  document.getElementById('name')!.addEventListener('blur', (e) => {
    const nameField = e.target as HTMLInputElement;
    const name = nameField.value;
    const error = validateName(name);
    
    showFieldError(nameError, error);
    
    // Visual feedback with shadcn classes
    if (error) {
      nameField.classList.add('border-destructive', 'focus-visible:ring-destructive');
      nameField.classList.remove('border-input', 'focus-visible:ring-ring');
    } else {
      nameField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      nameField.classList.add('border-input', 'focus-visible:ring-ring');
    }
  });

  document.getElementById('name')!.addEventListener('input', (e) => {
    const nameField = e.target as HTMLInputElement;
    // Clear error state on input
    if (nameField.classList.contains('border-destructive')) {
      nameField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      nameField.classList.add('border-input', 'focus-visible:ring-ring');
      nameError.classList.add('hidden');
    }
  });

  document.getElementById('phone')!.addEventListener('input', (e) => {
    const phoneField = e.target as HTMLInputElement;
    let value = phoneField.value;
    
    // Only allow numbers
    value = value.replace(/\D/g, '');
    
    // Limit to 10 digits
    if (value.length > 10) {
      value = value.substring(0, 10);
    }
    
    phoneField.value = value;
    
    // Clear error state on input
    if (phoneField.classList.contains('border-destructive')) {
      phoneField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      phoneField.classList.add('border-input', 'focus-visible:ring-ring');
      phoneError.classList.add('hidden');
    }
  });

  document.getElementById('phone')!.addEventListener('blur', (e) => {
    const phoneField = e.target as HTMLInputElement;
    const phone = phoneField.value;
    const error = validatePhone(phone);
    
    showFieldError(phoneError, error);
    
    // Visual feedback with shadcn classes
    if (error) {
      phoneField.classList.add('border-destructive', 'focus-visible:ring-destructive');
      phoneField.classList.remove('border-input', 'focus-visible:ring-ring');
    } else {
      phoneField.classList.remove('border-destructive', 'focus-visible:ring-destructive');
      phoneField.classList.add('border-input', 'focus-visible:ring-ring');
    }
  });

  // ======================
  // NEW FEATURE HANDLERS
  // ======================

  // Address Management
  document.getElementById('add-address-btn')?.addEventListener('click', () => {
    // TODO: Implement address management modal
    showMessage('地址管理功能開發中', 'success');
  });

  // Payment Methods
  document.getElementById('add-payment-btn')?.addEventListener('click', () => {
    // TODO: Implement payment method modal
    showMessage('付款方式管理功能開發中', 'success');
  });

  // Security Settings
  document.getElementById('change-password-btn')?.addEventListener('click', () => {
    // TODO: Implement password change modal
    showMessage('密碼變更功能開發中', 'success');
  });

  document.getElementById('login-history-btn')?.addEventListener('click', () => {
    // TODO: Implement login history modal
    showMessage('登入記錄功能開發中', 'success');
  });

  // ======================
  // INITIALIZATION
  // ======================

  async function loadBasicProfile(): Promise<void> {
    try {
      const profileData = await loadProfileData('basic');
      populateForm(profileData);
    } catch (error) {
      console.error('Failed to load basic profile:', error);
      showMessage('載入個人資料失敗', 'error');
    }
  }

  async function loadAnalytics(): Promise<void> {
    try {
      const analyticsData = await loadProfileData('analytics');
      populateAnalytics(analyticsData);
    } catch (error) {
      console.warn('Failed to load analytics:', error);
      // Analytics is optional, don't show error to user
    }
  }

  async function initialize(): Promise<void> {
    const isAuthenticated = await checkAuth();
    
    if (!isAuthenticated) {
      showNotAuthenticated();
      return;
    }

    showProfile();
    
    // Load basic profile first (essential)
    await loadBasicProfile();
    
    // Load analytics in background (optional)
    loadAnalytics();
  }

  // Start initialization
  initialize();

  // Auto-save functionality (optional enhancement)
  setInterval(() => {
    if (isFormDirty && validateForm()) {
      // Could implement auto-save here if desired
      console.log('Form has unsaved changes');
    }
  }, 30000); // Check every 30 seconds
  
  // Enhanced UI interactions
  document.addEventListener('DOMContentLoaded', () => {
    // Animate cards on load
    const cards = document.querySelectorAll('div[class*="space-y-6"] > div');
    cards.forEach((card, index) => {
      const htmlCard = card as HTMLElement;
      htmlCard.style.opacity = '0';
      htmlCard.style.transform = 'translateY(20px)';
      setTimeout(() => {
        htmlCard.style.transition = 'all 0.3s ease-out';
        htmlCard.style.opacity = '1';
        htmlCard.style.transform = 'translateY(0)';
      }, index * 100);
    });
    
    // Add subtle hover effects to interactive elements
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      const htmlButton = button as HTMLButtonElement;
      htmlButton.style.transition = 'transform 0.2s ease';
      htmlButton.addEventListener('mouseenter', () => {
        htmlButton.style.transform = 'translateY(-1px)';
      });
      htmlButton.addEventListener('mouseleave', () => {
        htmlButton.style.transform = 'translateY(0)';
      });
    });
  });
</script>