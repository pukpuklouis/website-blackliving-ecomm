---
import BaseLayout from '../../layouts/BaseLayout.astro';
// This page will be protected by Better Auth middleware
---

<BaseLayout>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">個人資料</h1>
        <p class="text-gray-600">管理您的帳號資訊</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="md:col-span-1">
          <nav class="space-y-2">
            <a href="/account/profile" class="block px-4 py-2 bg-black text-white rounded-lg">個人資料</a>
            <a href="/account/orders" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">訂單記錄</a>
            <a href="/account/appointments" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">預約記錄</a>
          </nav>
        </div>
        
        <div class="md:col-span-2">
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-semibold">基本資料</h2>
              <button id="logout-btn" class="text-gray-600 hover:text-red-600 text-sm">
                登出
              </button>
            </div>
            
            <div id="loading" class="text-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
              <p class="mt-2 text-gray-600">載入中...</p>
            </div>

            <div id="not-authenticated" class="text-center py-8 hidden">
              <p class="text-gray-600 mb-4">請先登入您的帳號</p>
              <a href="/login" class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 inline-block">
                前往登入
              </a>
            </div>
            
            <form id="profile-form" class="space-y-4 hidden">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                <input 
                  id="name" 
                  name="name"
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">電子郵件</label>
                <input 
                  id="email" 
                  name="email"
                  type="email" 
                  disabled
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">手機號碼</label>
                <input 
                  id="phone" 
                  name="phone"
                  type="tel" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                >
              </div>

              <div id="message" class="hidden p-3 rounded-lg"></div>
              
              <button type="submit" id="update-btn" class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 disabled:opacity-50">
                更新資料
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // Get API base URL
  const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

  const loading = document.getElementById('loading')!;
  const notAuthenticated = document.getElementById('not-authenticated')!;
  const profileForm = document.getElementById('profile-form') as HTMLFormElement;
  const logoutBtn = document.getElementById('logout-btn')!;
  const updateBtn = document.getElementById('update-btn') as HTMLButtonElement;
  const message = document.getElementById('message')!;

  let currentUser: any = null;

  async function checkAuth() {
    try {
      const response = await fetch(`${API_BASE}/api/auth/session`, {
        credentials: 'include',
      });

      if (response.ok) {
        const data = await response.json();
        if (data.user) {
          currentUser = data.user;
          showProfile();
          return;
        }
      }
      
      showNotAuthenticated();
    } catch (error) {
      console.error('Auth check failed:', error);
      showNotAuthenticated();
    }
  }

  function showProfile() {
    loading.classList.add('hidden');
    notAuthenticated.classList.add('hidden');
    profileForm.classList.remove('hidden');

    // Fill form with user data
    (document.getElementById('name') as HTMLInputElement).value = currentUser.name || '';
    (document.getElementById('email') as HTMLInputElement).value = currentUser.email || '';
    (document.getElementById('phone') as HTMLInputElement).value = currentUser.phone || '';
  }

  function showNotAuthenticated() {
    loading.classList.add('hidden');
    profileForm.classList.add('hidden');
    notAuthenticated.classList.remove('hidden');
  }

  function showMessage(text: string, type: 'success' | 'error') {
    message.textContent = text;
    message.className = `p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`;
    message.classList.remove('hidden');
    
    setTimeout(() => {
      message.classList.add('hidden');
    }, 5000);
  }

  // Handle logout
  logoutBtn.addEventListener('click', async () => {
    try {
      await fetch(`${API_BASE}/api/auth/sign-out`, {
        method: 'POST',
        credentials: 'include',
      });
      window.location.href = '/login';
    } catch (error) {
      console.error('Logout failed:', error);
    }
  });

  // Handle profile update
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    updateBtn.disabled = true;
    updateBtn.textContent = '更新中...';

    const formData = new FormData(profileForm);
    const name = formData.get('name') as string;
    const phone = formData.get('phone') as string;

    try {
      // Note: This would require implementing a user update endpoint in the API
      const response = await fetch(`${API_BASE}/api/user/profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({ name, phone }),
      });

      if (response.ok) {
        showMessage('個人資料更新成功', 'success');
        // Update current user data
        await checkAuth();
      } else {
        throw new Error('更新失敗');
      }
    } catch (error) {
      console.error('Profile update failed:', error);
      showMessage('更新失敗，請稍後再試', 'error');
    } finally {
      updateBtn.disabled = false;
      updateBtn.textContent = '更新資料';
    }
  });

  // Initialize
  checkAuth();
</script>