---
import AccountNav from "../../components/AccountNav.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const title = "訂單記錄 | Black Living";
const description = "查看您的購買記錄";
// This page will be protected by Better Auth middleware
---

<BaseLayout {title} {description}>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">訂單記錄</h1>
        <p class="text-gray-600">查看您的購買記錄</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <AccountNav currentPage="orders"/>

        <div class="md:col-span-2 min-w-0">
          <div class="w-full min-h-[400px]">
            <div id="loading" class="text-center py-8">
              <div
                class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"
              ></div>
              <p class="mt-2 text-gray-600">載入中...</p>
            </div>

            <div id="not-authenticated" class="text-center py-8 hidden">
              <p class="text-gray-600 mb-4">請先登入您的帳號</p>
              <a
                href="/login"
                class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 inline-block"
              >
                前往登入
              </a>
            </div>

            <div id="no-orders" class="text-center py-8 hidden">
              <p class="text-gray-600 mb-4">您目前沒有任何訂單</p>
              <a
                href="/simmons-black"
                class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 inline-block"
              >
                開始購物
              </a>
            </div>

            <div id="orders-container" class="space-y-6 hidden">
              <!-- Orders will be dynamically rendered here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // Get API base URL
  const API_BASE = import.meta.env.PUBLIC_API_URL || "http://localhost:8787";

  const loading = document.getElementById("loading");
  const notAuthenticated = document.getElementById("not-authenticated");
  const noOrders = document.getElementById("no-orders");
  const ordersContainer = document.getElementById("orders-container");

  function initOrdersPage(
    loadingEl: HTMLElement,
    notAuthEl: HTMLElement,
    noOrdersEl: HTMLElement,
    ordersEl: HTMLElement
  ) {
    type OrderItem = {
      name: string;
      size?: string;
      quantity: number;
      price: number;
    };

    type Order = {
      orderNumber: string;
      createdAt: string;
      customerInfo: {
        name: string;
      };
      status: string;
      paymentMethod: string;
      items: OrderItem[];
      totalAmount: number;
      notes?: string;
    };

    const GOMYPAY_METHODS = [
      "credit_card",
      "virtual_account",
      "apple_pay",
      "google_pay",
    ];

    type User = {
      email: string;
      name: string;
    };

    let currentUser: User | null = null;

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/api/auth/get-session`, {
          credentials: "include",
        });

        if (response.ok) {
          const data = await response.json();
          if (data.user) {
            currentUser = data.user;
            await loadOrders();
            return;
          }
        }

        showNotAuthenticated();
      } catch (error) {
        console.error("Auth check failed:", error);
        showNotAuthenticated();
      }
    }

    async function loadOrders() {
      if (!currentUser) {
        return;
      }

      try {
        const response = await fetch(
          `${API_BASE}/api/orders/customer/${currentUser.email}`,
          {
            credentials: "include",
          }
        );

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data.length > 0) {
            showOrders(data.data);
          } else {
            showNoOrders();
          }
        } else {
          throw new Error("Failed to load orders");
        }
      } catch (error) {
        console.error("Failed to load orders:", error);
        showNoOrders();
      }
    }

    function showNotAuthenticated() {
      loadingEl.classList.add("hidden");
      ordersEl.classList.add("hidden");
      noOrdersEl.classList.add("hidden");
      notAuthEl.classList.remove("hidden");
    }

    function showNoOrders() {
      loadingEl.classList.add("hidden");
      notAuthEl.classList.add("hidden");
      ordersEl.classList.add("hidden");
      noOrdersEl.classList.remove("hidden");
    }

    function showOrders(orders: Order[]) {
      loadingEl.classList.add("hidden");
      notAuthEl.classList.add("hidden");
      noOrdersEl.classList.add("hidden");
      ordersEl.classList.remove("hidden");

      // Attach payment listeners after rendering
      setTimeout(attachPaymentListeners, 0);

      ordersEl.innerHTML = orders
        .map((order) => {
          const customerInfo = order.customerInfo;
          const items = order.items;
          const statusColor = getStatusColor(order.status);
          const statusText = getStatusText(order.status);

          return `
          <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm transition-shadow hover:shadow-md sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-4">
              <div>
                <h3 class="font-semibold text-lg text-slate-900">訂單 #${order.orderNumber}</h3>
                <p class="text-sm text-slate-500">下單日期：${new Date(order.createdAt).toLocaleDateString("zh-TW")}</p>
                <p class="text-sm text-slate-500">收件人：${customerInfo.name}</p>
              </div>
              <span class="${statusColor} px-3 py-1 rounded-full text-sm font-medium self-start sm:self-auto">${statusText}</span>
            </div>
            
            <div class="border-t border-slate-100 pt-4 space-y-2">
              ${items
                .map(
                  (item) => `
                <div class="flex justify-between items-center gap-4">
                  <div>
                    <p class="text-slate-700 font-medium">${item.name}${item.size ? ` - ${item.size}` : ""}</p>
                    <p class="text-sm text-slate-500">數量：${item.quantity}</p>
                  </div>
                  <p class="text-slate-900 font-medium whitespace-nowrap">NT$ ${item.price.toLocaleString()}</p>
                </div>
              `
                )
                .join("")}
              
              <div class="border-t border-slate-100 pt-3 mt-4">
                <div class="flex justify-between items-center font-semibold text-lg text-slate-900">
                  <span>總計</span>
                  <span>NT$ ${order.totalAmount.toLocaleString()}</span>
                </div>
              </div>
              
              ${order.notes ? `<p class="text-sm text-slate-600 mt-2 bg-slate-50 p-3 rounded">備註：${order.notes}</p>` : ""}
              
              ${
                order.status === "pending_payment" &&
                GOMYPAY_METHODS.includes(order.paymentMethod)
                  ? `
                <div class="border-t border-slate-100 pt-4 mt-4">
                  <button
                    class="w-full sm:w-auto bg-slate-900 text-white px-6 py-2.5 rounded hover:bg-slate-800 font-medium transition-colors retry-payment-btn"
                    data-order="${order.orderNumber}"
                  >
                    立即付款
                  </button>
                </div>
              `
                  : ""
              }
            </div>
          </div>
        `;
        })
        .join("");
    }

    function getStatusColor(status: string) {
      const colors: { [key: string]: string } = {
        pending_payment: "bg-yellow-100 text-yellow-800",
        paid: "bg-blue-100 text-blue-800",
        processing: "bg-purple-100 text-purple-800",
        shipped: "bg-indigo-100 text-indigo-800",
        delivered: "bg-green-100 text-green-800",
        cancelled: "bg-red-100 text-red-800",
      };
      return colors[status] || "bg-gray-100 text-gray-800";
    }

    function getStatusText(status: string) {
      const texts: { [key: string]: string } = {
        pending_payment: "待付款",
        paid: "已付款",
        processing: "處理中",
        shipped: "已出貨",
        delivered: "已送達",
        cancelled: "已取消",
      };
      return texts[status] || status;
    }

    async function handleRetryPayment(orderNumber: string) {
      try {
        const response = await fetch(
          `${API_BASE}/api/payment/retry/${orderNumber}`,
          {
            method: "POST",
            credentials: "include",
          }
        );

        const result = await response.json();

        if (!result.success) {
          showPaymentError(result.error || "付款初始化失敗");
          return;
        }

        // Handle redirect type (Apple Pay, Google Pay)
        if (result.data.type === "redirect" && result.data.redirectUrl) {
          window.location.href = result.data.redirectUrl;
          return;
        }

        // Handle form type (Credit Card, Virtual Account)
        if (
          result.data.type === "form" &&
          result.data.submitUrl &&
          result.data.formData
        ) {
          const form = document.createElement("form");
          form.method = "POST";
          form.action = result.data.submitUrl;

          for (const [key, value] of Object.entries(result.data.formData)) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = value as string;
            form.appendChild(input);
          }

          document.body.appendChild(form);
          form.submit();
        }
      } catch (error) {
        console.error("Retry payment error:", error);
        showPaymentError("付款初始化失敗，請稍後再試");
      }
    }

    function showPaymentError(message: string) {
      // Create a toast-like error message
      const existingToast = document.getElementById("payment-error-toast");
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement("div");
      toast.id = "payment-error-toast";
      toast.className =
        "fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50";
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function attachPaymentListeners() {
      const buttons = document.querySelectorAll(".retry-payment-btn");
      for (const btn of buttons) {
        btn.addEventListener("click", () => {
          const orderNumber = btn.getAttribute("data-order");
          if (orderNumber) {
            handleRetryPayment(orderNumber);
          }
        });
      }
    }

    // Initialize
    checkAuth();
  }

  // Call init function with null checks
  if (loading && notAuthenticated && noOrders && ordersContainer) {
    initOrdersPage(loading, notAuthenticated, noOrders, ordersContainer);
  }
</script>
