---
import PostLayout from '../../layouts/PostLayout.astro';
import type { BlogPost, PostCategory } from '@blackliving/types';

export async function getStaticPaths() {
  try {
    // Fetch all published posts to generate static paths
    const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
    const response = await fetch(`${apiUrl}/api/posts/public?limit=100`);
    if (!response.ok) {
      console.error('Failed to fetch posts for static generation');
      return [];
    }

    const data = await response.json();
    const posts = data.data || [];

    return posts.map((post: BlogPost) => ({
      params: { postSlug: post.slug },
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

const { postSlug } = Astro.params;
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

// Fetch post data using enhanced API endpoint with embedded category
const postResponse = await fetch(`${apiUrl}/api/posts/${postSlug}?include=category`);
if (!postResponse.ok) {
  return Astro.redirect('/404');
}

const postData = await postResponse.json();
const post: BlogPost & { category?: PostCategory } = postData.data;
const category = post.category || null;

// Fetch related posts from same category (simplified)
let relatedPosts: BlogPost[] = [];
if (post.categoryId) {
  try {
    const relatedResponse = await fetch(
      `${apiUrl}/api/posts/public?category=${encodeURIComponent(post.category)}&limit=3`
    );
    if (relatedResponse.ok) {
      const relatedData = await relatedResponse.json();
      relatedPosts = (relatedData.data || []).filter((p: BlogPost) => p.slug !== postSlug);
    }
  } catch (error) {
    console.warn('Failed to fetch related posts:', error);
  }
}

// SEO data
const seoTitle = post.seoTitle || `${post.title} | 黑哥家居`;
const seoDescription = post.seoDescription || post.excerpt || post.description;
const ogImage = post.featuredImage || '/images/default-og.jpg';
---

<PostLayout 
  {post}
  {category}
  {relatedPosts}
  {seoTitle}
  {seoDescription}
  {ogImage}
/>
