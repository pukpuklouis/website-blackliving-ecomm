---
import PostLayout from '../../layouts/PostLayout.astro';

interface BlogPost {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  content: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
  seoTitle?: string;
  seoDescription?: string;
}

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

export async function getStaticPaths() {
  try {
    // Fetch all published posts to generate static paths
    const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
    const response = await fetch(`${apiUrl}/api/posts/public?limit=100`);
    if (!response.ok) {
      console.error('Failed to fetch posts for static generation');
      return [];
    }

    const data = await response.json();
    const posts = data.data || [];

    return posts.map((post: BlogPost) => ({
      params: { postSlug: post.slug },
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

const { postSlug } = Astro.params;

// Fetch post data
let post: BlogPost | null = null;
let category: PostCategory | null = null;
let relatedPosts: BlogPost[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch the post
  const postResponse = await fetch(`${apiUrl}/api/posts/${postSlug}`);
  if (postResponse.ok) {
    const postData = await postResponse.json();
    post = postData.data;

    // Fetch category information if categoryId exists
    if (post?.categoryId) {
      const categoryResponse = await fetch(`${apiUrl}/api/posts/categories`);
      if (categoryResponse.ok) {
        const categoriesData = await categoryResponse.json();
        const categories = categoriesData.data || [];
        category = categories.find((cat: PostCategory) => cat.id === post.categoryId);
      }
    }

    // Fetch related posts from the same category
    if (post?.categoryId) {
      const relatedResponse = await fetch(
        `${apiUrl}/api/posts/public?category=${encodeURIComponent(post.category)}&limit=3`
      );
      if (relatedResponse.ok) {
        const relatedData = await relatedResponse.json();
        relatedPosts = (relatedData.data || []).filter((p: BlogPost) => p.slug !== postSlug);
      }
    }
  }
} catch (error) {
  console.error('Error fetching post data:', error);
}

if (!post) {
  return Astro.redirect('/404');
}

// SEO data
const seoTitle = post.seoTitle || `${post.title} | 黑哥家居`;
const seoDescription = post.seoDescription || post.excerpt || post.description;
const ogImage = post.featuredImage || '/images/default-og.jpg';
---

<PostLayout 
  {post}
  {category}
  {relatedPosts}
  {seoTitle}
  {seoDescription}
  {ogImage}
/>
