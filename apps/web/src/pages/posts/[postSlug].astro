---
import PostLayout from '../../layouts/PostLayout.astro';
import type { BlogPost } from '@blackliving/types';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const apiUrl = process.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
  
  try {
    const response = await fetch(`${apiUrl}/api/posts/public?category=blog-post&include=category`);
    const { data: posts } = await response.json();
    
    return posts.map((post: any) => ({
      params: { postSlug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error fetching static paths:', error);
    return [];
  }
}

export const prerender = true;

const { post: basicPost } = Astro.props;
const apiUrl = process.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

// Fetch full post data with content using the slug
const fullPostResponse = await fetch(`${apiUrl}/api/posts/${basicPost.slug}`);
const { data: apiPost } = await fullPostResponse.json();

// Get related posts from API
const relatedResponse = await fetch(`${apiUrl}/api/posts/public?category=blog-post&include=category`);
const { data: allPosts } = await relatedResponse.json();
const relatedPosts = allPosts.filter((p: any) => p.id !== apiPost.id).slice(0, 3);

const post: BlogPost = {
  id: apiPost.id,
  title: apiPost.title,
  slug: apiPost.slug,
  description: apiPost.description || apiPost.excerpt,
  excerpt: apiPost.excerpt || apiPost.description,
  content: apiPost.content || apiPost.excerpt || apiPost.description || '',
  authorName: apiPost.authorName || 'Black Living 專業團隊',
  category: apiPost.category || 'Blog',
  categoryId: 'blog',
  tags: apiPost.tags || [],
  featuredImage: apiPost.featuredImage || '',
  publishedAt: apiPost.publishedAt,
  viewCount: apiPost.viewCount || 0,
  readingTime: apiPost.readingTime || 5,
  seoTitle: apiPost.seoTitle,
  seoDescription: apiPost.seoDescription,
};


const relatedBlogPosts: BlogPost[] = relatedPosts.map((p: any) => ({
  id: p.id,
  title: p.title,
  slug: p.slug,
  description: p.description || p.excerpt,
  excerpt: p.excerpt || p.description,
  content: p.content || p.excerpt || '',
  authorName: p.authorName || 'Black Living 專業團隊',
  category: p.category || 'Blog',
  categoryId: 'blog',
  tags: p.tags || [],
  featuredImage: p.featuredImage || '',
  publishedAt: p.publishedAt,
  viewCount: p.viewCount || 0,
  readingTime: p.readingTime || 5,
}));

const category = (apiPost && typeof apiPost.category === 'object')
  ? { slug: apiPost.category.slug || 'blog-post', name: apiPost.category.name || '好文分享', color: apiPost.category.color, icon: apiPost.category.icon }
  : { slug: 'blog-post', name: (typeof apiPost?.category === 'string' ? apiPost.category : '好文分享') };
const seoTitle = post.seoTitle || `${post.title} | 黑哥家居`;
const seoDescription = post.seoDescription || post.excerpt || post.description;
const ogImage = post.featuredImage || '/images/default-og.jpg';
---

<PostLayout 
  {post}
  {category}
  relatedPosts={relatedBlogPosts}
  {seoTitle}
  {seoDescription}
  {ogImage}
>
  <!-- Content rendered by BlogContent component in PostLayout -->
</PostLayout>
