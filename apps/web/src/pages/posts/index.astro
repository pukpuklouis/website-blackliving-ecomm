---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CTA from '../../components/CTA.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import type { BlogPost } from '@blackliving/ui';

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

interface ApiBlogPost {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
}

// Get categories and posts
let categories: PostCategory[] = [];
let apiPosts: ApiBlogPost[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch categories
  const categoriesResponse = await fetch(`${apiUrl}/api/posts/categories`);
  if (categoriesResponse.ok) {
    const categoriesData = await categoriesResponse.json();
    categories = categoriesData.data || [];
  }

  // Fetch only blog posts
  const postsResponse = await fetch(`${apiUrl}/api/posts/public?category=blog-post`);
  if (postsResponse.ok) {
    const postsData = await postsResponse.json();
    apiPosts = postsData.data || [];
  }
} catch (error) {
  console.error('Error fetching posts data:', error);
}

// Transform API posts to BlogPost format
const posts: BlogPost[] = apiPosts.map(post => ({
  slug: post.slug,
  title: post.title,
  excerpt: post.excerpt,
  description: post.description,
  featuredImage: post.featuredImage,
  category: post.category,
  readingTime: `${post.readingTime}`,
  authorName: post.authorName,
  publishedAt: post.publishedAt,
}));

---

<BaseLayout 
  title="好文分享 - Black Living 黑哥家居"
  description="睡眠知識與健康生活分享，專業床墊選購指南與使用心得"
>
  <main class='container mx-auto px-4 py-8 mb-12'>
    <div class='text-center mb-12'>
      <h1 class='text-4xl font-bold text-gray-900 mb-4'>好文分享</h1>
      <p class='text-xl text-gray-600'>睡眠知識與健康生活分享</p>
    </div>


    <div class='max-w-4xl mx-auto'>
      <div class='grid grid-cols-1 md:flex flex-col gap-8'>
        {posts.map(post => (
          <BlogPostCard post={post} variant="horizontal" />
        ))}
      </div>
      {
        posts.length === 0 && (
          <div class='text-center py-12'>
            <p class='text-gray-500'>目前尚無文章...</p>
          </div>
        )
      }
    </div>
  </main>
  <CTA />
</BaseLayout>
