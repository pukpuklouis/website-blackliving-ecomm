---
import BaseLayout from '../../layouts/BaseLayout.astro';

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

interface BlogPost {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
}

// Get categories and posts
let categories: PostCategory[] = [];
let posts: BlogPost[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch categories
  const categoriesResponse = await fetch(`${apiUrl}/api/posts/categories`);
  if (categoriesResponse.ok) {
    const categoriesData = await categoriesResponse.json();
    categories = categoriesData.data || [];
  }

  // Fetch all published posts
  const postsResponse = await fetch(`${apiUrl}/api/posts/public`);
  if (postsResponse.ok) {
    const postsData = await postsResponse.json();
    posts = postsData.data || [];
  }
} catch (error) {
  console.error('Error fetching posts data:', error);
}

// Group posts by category
const postsByCategory = posts.reduce(
  (acc, post) => {
    const categoryName = post.category || '未分類';
    if (!acc[categoryName]) {
      acc[categoryName] = [];
    }
    acc[categoryName].push(post);
    return acc;
  },
  {} as Record<string, BlogPost[]>
);
---

<BaseLayout>
  <main class='container mx-auto px-4 py-8'>
    <div class='text-center mb-12'>
      <h1 class='text-4xl font-bold text-gray-900 mb-4'>好文分享</h1>
      <p class='text-xl text-gray-600'>睡眠知識與健康生活分享</p>
    </div>

    <!-- Category Filter Tabs -->
    <div class='max-w-4xl mx-auto mb-8'>
      <div class='border-b border-gray-200'>
        <nav class='-mb-px flex space-x-8' aria-label='文章分類'>
          <button
            class='category-tab active border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600'
            data-category='all'
          >
            全部文章
          </button>
          {
            categories.map(category => (
              <button
                class='category-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700'
                data-category={category.slug}
              >
                <span class='mr-2'>{category.icon}</span>
                {category.name}
              </button>
            ))
          }
        </nav>
      </div>
    </div>

    <div class='max-w-4xl mx-auto'>
      {/* Show all posts initially */}
      <div id='all-posts' class='category-content'>
        <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
          {
            posts.map(post => (
              <article class='bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow'>
                {post.featuredImage && (
                  <img src={post.featuredImage} alt={post.title} class='w-full h-48 object-cover' />
                )}
                <div class='p-6'>
                  <div class='flex items-center mb-3'>
                    <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'>
                      {post.category}
                    </span>
                    <span class='ml-2 text-sm text-gray-500'>{post.readingTime} 分鐘閱讀</span>
                  </div>
                  <h2 class='text-xl font-semibold text-gray-900 mb-3'>
                    <a href={`/posts/${post.slug}`} class='hover:text-blue-600'>
                      {post.title}
                    </a>
                  </h2>
                  <p class='text-gray-600 mb-4 line-clamp-3'>{post.excerpt || post.description}</p>
                  <div class='flex items-center justify-between text-sm text-gray-500'>
                    <span>作者：{post.authorName}</span>
                    <span>{new Date(post.publishedAt).toLocaleDateString('zh-TW')}</span>
                  </div>
                </div>
              </article>
            ))
          }
        </div>
        {
          posts.length === 0 && (
            <div class='text-center py-12'>
              <p class='text-gray-500'>目前尚無文章...</p>
            </div>
          )
        }
      </div>

      {/* Show posts by category */}
      {
        categories.map(category => (
          <div id={`${category.slug}-posts`} class='category-content hidden'>
            <div class='mb-6'>
              <h2 class='text-2xl font-bold text-gray-900 mb-2'>
                <span class='mr-2'>{category.icon}</span>
                {category.name}
              </h2>
              <p class='text-gray-600'>{category.description}</p>
            </div>
            <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
              {postsByCategory[category.name]?.map(post => (
                <article class='bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow'>
                  {post.featuredImage && (
                    <img
                      src={post.featuredImage}
                      alt={post.title}
                      class='w-full h-48 object-cover'
                    />
                  )}
                  <div class='p-6'>
                    <div class='flex items-center mb-3'>
                      <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'>
                        {post.category}
                      </span>
                      <span class='ml-2 text-sm text-gray-500'>{post.readingTime} 分鐘閱讀</span>
                    </div>
                    <h2 class='text-xl font-semibold text-gray-900 mb-3'>
                      <a href={`/posts/${post.slug}`} class='hover:text-blue-600'>
                        {post.title}
                      </a>
                    </h2>
                    <p class='text-gray-600 mb-4 line-clamp-3'>
                      {post.excerpt || post.description}
                    </p>
                    <div class='flex items-center justify-between text-sm text-gray-500'>
                      <span>作者：{post.authorName}</span>
                      <span>{new Date(post.publishedAt).toLocaleDateString('zh-TW')}</span>
                    </div>
                  </div>
                </article>
              )) || (
                <div class='col-span-2 text-center py-12'>
                  <p class='text-gray-500'>此分類目前尚無文章...</p>
                </div>
              )}
            </div>
          </div>
        ))
      }
    </div>
  </main>

  <script>
    // Category filtering functionality
    document.addEventListener('DOMContentLoaded', function () {
      const categoryTabs = document.querySelectorAll('.category-tab');
      const categoryContents = document.querySelectorAll('.category-content');

      categoryTabs.forEach(tab => {
        tab.addEventListener('click', function () {
          const targetCategory = this.getAttribute('data-category');

          // Update active tab
          categoryTabs.forEach(t => {
            t.classList.remove('active', 'border-blue-500', 'text-blue-600');
            t.classList.add('border-transparent', 'text-gray-500');
          });
          this.classList.add('active', 'border-blue-500', 'text-blue-600');
          this.classList.remove('border-transparent', 'text-gray-500');

          // Show/hide content
          categoryContents.forEach(content => {
            content.classList.add('hidden');
          });

          if (targetCategory === 'all') {
            document.getElementById('all-posts')?.classList.remove('hidden');
          } else {
            document.getElementById(`${targetCategory}-posts`)?.classList.remove('hidden');
          }
        });
      });
    });
  </script>

  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</BaseLayout>
