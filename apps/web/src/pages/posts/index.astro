---
import BaseLayout from '../../layouts/BaseLayout.astro';

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

interface BlogPost {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
}

// Get categories and posts
let categories: PostCategory[] = [];
let posts: BlogPost[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch categories
  const categoriesResponse = await fetch(`${apiUrl}/api/posts/categories`);
  if (categoriesResponse.ok) {
    const categoriesData = await categoriesResponse.json();
    categories = categoriesData.data || [];
  }

  // Fetch only blog posts
  const postsResponse = await fetch(`${apiUrl}/api/posts/public?category=blog-post`);
  if (postsResponse.ok) {
    const postsData = await postsResponse.json();
    posts = postsData.data || [];
  }
} catch (error) {
  console.error('Error fetching posts data:', error);
}

---

<BaseLayout>
  <main class='container mx-auto px-4 py-8'>
    <div class='text-center mb-12'>
      <h1 class='text-4xl font-bold text-gray-900 mb-4'>好文分享</h1>
      <p class='text-xl text-gray-600'>睡眠知識與健康生活分享</p>
    </div>


    <div class='max-w-4xl mx-auto'>
      <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
        {
          posts.map(post => (
            <article class='bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow'>
              {post.featuredImage && (
                <img src={post.featuredImage} alt={post.title} class='w-full h-48 object-cover' />
              )}
              <div class='p-6'>
                <div class='flex items-center mb-3'>
                  <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'>
                    {post.category}
                  </span>
                  <span class='ml-2 text-sm text-gray-500'>{post.readingTime} 分鐘閱讀</span>
                </div>
                <h2 class='text-xl font-semibold text-gray-900 mb-3'>
                  <a href={`/posts/${post.slug}`} class='hover:text-blue-600'>
                    {post.title}
                  </a>
                </h2>
                <p class='text-gray-600 mb-4 line-clamp-3'>{post.excerpt || post.description}</p>
                <div class='flex items-center justify-between text-sm text-gray-500'>
                  <span>作者：{post.authorName}</span>
                  <span>{new Date(post.publishedAt).toLocaleDateString('zh-TW')}</span>
                </div>
              </div>
            </article>
          ))
        }
      </div>
      {
        posts.length === 0 && (
          <div class='text-center py-12'>
            <p class='text-gray-500'>目前尚無文章...</p>
          </div>
        )
      }
    </div>
  </main>


  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</BaseLayout>
