---
import BaseLayout from '../layouts/BaseLayout.astro';

const query = Astro.url.searchParams.get('q') ?? '';
const title = query ? `搜尋「${query}」的結果` : '站內搜尋';
---

<BaseLayout title={title} description="搜尋 Black Living 商品、內容與頁面">
  <section class="container mx-auto px-4 py-12">
    <div class="mx-auto max-w-3xl">
      <header class="mb-8">
        <h1 class="text-3xl font-semibold tracking-tight text-gray-900">站內搜尋</h1>
        <p class="mt-2 text-base text-gray-600">輸入關鍵字，即可快速搜尋商品、部落格文章與重要頁面。</p>
      </header>

      <form data-search-form class="mb-10 flex flex-col gap-3 sm:flex-row" role="search">
        <label class="sr-only" for="search-query">站內搜尋</label>
        <input
          id="search-query"
          name="q"
          type="search"
          value={query}
          placeholder="搜尋商品、文章與頁面"
          class="flex-1 rounded-lg border border-gray-300 px-4 py-3 text-base shadow-sm focus:border-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400"
          required
        />
        <button
          type="submit"
          class="flex items-center justify-center rounded-lg bg-black px-6 py-3 text-base font-medium text-white transition-colors hover:bg-gray-800"
          aria-label="搜尋"
        >
          搜尋
        </button>
      </form>

      <div id="search-status" class="text-sm text-gray-500"></div>

      <div id="search-results" class="space-y-10" data-initial-query={query}></div>
    </div>
  </section>

  <script type="module">
    const resultsContainer = document.getElementById('search-results');
    const statusElement = document.getElementById('search-status');
    const searchForm = document.querySelector('[data-search-form]');
    const queryInput = document.getElementById('search-query');

    async function fetchResults(query) {
      if (!query.trim()) {
        resultsContainer.innerHTML = '';
        statusElement.textContent = '';
        return;
      }

      statusElement.textContent = `搜尋「${query}」中…`;
      resultsContainer.innerHTML = '';

      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=12`);
        if (!response.ok) {
          throw new Error(`Search failed with status ${response.status}`);
        }
        const payload = await response.json();
        if (!payload.success || !payload.data) {
          throw new Error(payload.error || 'Search failed');
        }

        renderResults(payload.data);
      } catch (error) {
        console.error('Search error', error);
        statusElement.textContent = '搜尋時發生錯誤，請稍後再試。';
      }
    }

    function renderResults(data) {
      const { results, total } = data;

      if (total === 0) {
        statusElement.textContent = '沒有符合的結果，試著使用不同關鍵字。';
        resultsContainer.innerHTML = '';
        return;
      }

      statusElement.textContent = `共找到 ${total} 筆結果。`;

      const sections = [];

      if (results.products.length) {
        sections.push(`
          <section data-testid="product-results" aria-label="商品搜尋結果">
            <h2 class="mb-4 text-2xl font-semibold text-gray-900">商品</h2>
            <div class="grid gap-4 sm:grid-cols-2">
              ${results.products
                .map(
                  product => `
                    <article class="rounded-lg border border-gray-200 p-4 shadow-sm transition hover:shadow-md" data-testid="search-result">
                      <h3 class="text-lg font-medium text-gray-900">
                        <a href="${product.href}" class="hover:underline">${product.title}</a>
                      </h3>
                      <p class="mt-2 text-sm text-gray-600">${product.description ?? ''}</p>
                      <span class="mt-3 inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-600">
                        ${product.category ?? '商品'}
                      </span>
                    </article>
                  `
                )
                .join('')}
            </div>
          </section>
        `);
      }

      if (results.posts.length) {
        sections.push(`
          <section data-testid="post-results" aria-label="文章搜尋結果">
            <h2 class="mb-4 text-2xl font-semibold text-gray-900">文章</h2>
            <div class="space-y-4">
              ${results.posts
                .map(
                  post => `
                    <article class="rounded-lg border border-gray-200 p-4 shadow-sm transition hover:shadow-md" data-testid="search-result">
                      <h3 class="text-lg font-medium text-gray-900">
                        <a href="${post.href}" class="hover:underline">${post.title}</a>
                      </h3>
                      <p class="mt-2 text-sm text-gray-600">${post.description ?? ''}</p>
                      <div class="mt-3 flex items-center gap-3 text-xs text-gray-500">
                        ${post.category ? `<span class="rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-600">${post.category}</span>` : ''}
                        ${post.metadata?.publishedAt ? `<time datetime="${post.metadata.publishedAt}">${new Date(post.metadata.publishedAt).toLocaleDateString('zh-TW')}</time>` : ''}
                      </div>
                    </article>
                  `
                )
                .join('')}
            </div>
          </section>
        `);
      }

      if (results.pages.length) {
        sections.push(`
          <section data-testid="page-results" aria-label="頁面搜尋結果">
            <h2 class="mb-4 text-2xl font-semibold text-gray-900">頁面</h2>
            <div class="space-y-3">
              ${results.pages
                .map(
                  page => `
                    <article class="rounded-lg border border-gray-200 p-4 shadow-sm transition hover:shadow-md" data-testid="search-result">
                      <h3 class="text-lg font-medium text-gray-900">
                        <a href="${page.href}" class="hover:underline">${page.title}</a>
                      </h3>
                      <p class="mt-2 text-sm text-gray-600">${page.description ?? ''}</p>
                    </article>
                  `
                )
                .join('')}
            </div>
          </section>
        `);
      }

      resultsContainer.innerHTML = sections.join('');
    }

    searchForm?.addEventListener('submit', event => {
      event.preventDefault();
      const formData = new FormData(searchForm);
      const queryValue = (formData.get('q') || '').toString();
      const url = new URL(window.location.href);
      url.searchParams.set('q', queryValue);
      window.history.replaceState({}, '', url);
      fetchResults(queryValue);
    });

    const initialQuery = resultsContainer?.dataset.initialQuery ?? '';
    if (initialQuery) {
      fetchResults(initialQuery);
    }
  </script>
</BaseLayout>
