---
import ProductLayout from '../../layouts/ProductLayout.astro';
import ProductTabs from '../../components/ProductTabs.tsx';
import ProductImageCarousel from '../../components/ProductImageCarousel.tsx';
import ProductDetail from '../../components/ProductDetail.tsx';
import { getEntry } from 'astro:content';
import { generateStaticPaths, fetchProduct } from '../../utils/productPaths.ts';

export async function getStaticPaths() {
  return await generateStaticPaths('accessories');
}

const { productSlug } = Astro.params;
const categoryEntry = await getEntry('categories', 'accessories');

if (!categoryEntry) {
  return Astro.redirect('/404');
}

const categoryConfig = categoryEntry.data;

// Fetch individual product data
const { product, error, notFound } = await fetchProduct(productSlug);

// If no product found or error occurred, redirect to 404
if (notFound) {
  return Astro.redirect('/404');
}
---

{
  error ? (
    <div class='min-h-screen flex items-center justify-center'>
      <div class='text-center'>
        <h1 class='text-2xl font-bold text-gray-900 mb-4'>載入產品時發生錯誤</h1>
        <p class='text-gray-600 mb-6'>{error}</p>
        <a
          href={categoryConfig.urlPath}
          class='bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800'
        >
          返回產品列表
        </a>
      </div>
    </div>
  ) : (
    product && (
      <ProductLayout
        title={product.name}
        description={product.description}
        image={product.images?.[0]}
      >
        {/* Product Images - Left Column */}
        <ProductImageCarousel
          images={product.images || []}
          productName={product.name}
          client:load
          slot="product-images"
        />

        {/* Product Details & Actions - Right Column */}
        <div slot="product-details">
          {/* Basic Product Info */}
          <div class='mb-6'>
            <span class='inline-block bg-black text-white text-sm px-3 py-1 rounded mb-2'>
              {categoryConfig.series}
            </span>
            <h1 class='text-2xl lg:text-3xl font-bold text-gray-900 mb-4'>{product.name}</h1>
            <p class='text-gray-600 mb-4'>{product.description}</p>
          </div>

          {/* Product Detail with Cart Functionality */}
          <ProductDetail
            product={product}
            categoryConfig={categoryConfig}
            className='mt-6'
            client:load
          />

          {/* Product Description & Specifications Tabs - Mobile below product details */}
          <div class='mt-8 lg:hidden'>
            <ProductTabs
              features={product.features || []}
              specifications={product.specifications}
              categoryFeatures={categoryConfig.features}
              categoryName={categoryConfig.category}
              client:load
            />
          </div>
        </div>

        {/* Product Features and Specifications Tabs - Desktop full width below */}
        <div class='hidden lg:block' slot="product-tabs">
          <ProductTabs
            features={product.features || []}
            specifications={product.specifications}
            categoryFeatures={categoryConfig.features}
            categoryName={categoryConfig.category}
            client:load
          />
        </div>
      </ProductLayout>
    )
  )
}
