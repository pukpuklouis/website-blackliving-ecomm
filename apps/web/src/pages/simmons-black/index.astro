---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/ProductCard.astro';

// API configuration
const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

// Fetch simmons-black products from API
let products: any[] = [];
let error: string | null = null;

try {
  const response = await fetch(`${API_BASE}/api/products?category=simmons-black`);
  
  if (!response.ok) {
    throw new Error(`Failed to fetch products: ${response.status}`);
  }
  
  const data = await response.json();
  
  // Extract products from the API response structure
  if (data && data.success && data.data && data.data.products && Array.isArray(data.data.products)) {
    products = data.data.products;
  } else {
    console.error('API did not return products array:', data);
    products = [];
  }
} catch (err) {
  console.error('Error fetching simmons-black products:', err);
  error = err instanceof Error ? err.message : 'Unknown error occurred';
}

// Transform products for ProductCard component
const transformedProducts = Array.isArray(products) ? products.map((product: any) => ({
  id: product.id,
  name: product.name,
  series: '席夢思黑標',
  image: product.images?.[0] || 'https://placehold.co/600x400?text=blackliving+mattress',
  features: product.features || [],
  priceFrom: product.variants?.[0]?.price || null,
  href: `/simmons-black/${product.slug}`
})) : [];
---

<BaseLayout title="席夢思黑標床墊" description="美國原裝進口席夢思黑標床墊，全台最低價保證">
  <main class="container mx-auto px-4 py-8">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">席夢思黑標床墊</h1>
      <p class="text-xl text-gray-600">美國原裝進口，全台最低價保證</p>
    </div>
    
    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-8">
        <p>載入產品時發生錯誤：{error}</p>
      </div>
    )}
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {transformedProducts.length > 0 ? (
        transformedProducts.map((product: any) => (
          <ProductCard product={product} />
        ))
      ) : !error && (
        <div class="col-span-full text-center py-12">
          <p class="text-gray-500 text-lg">目前沒有可用的席夢思黑標產品</p>
        </div>
      )}
    </div>
  </main>
</BaseLayout>