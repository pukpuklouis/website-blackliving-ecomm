---
import ProductLayout from '../../layouts/ProductLayout.astro';
import ProductTabs from '../../components/ProductTabs.tsx';
import ProductImageCarousel from '../../components/ProductImageCarousel.tsx';
import ProductDetail from '../../components/ProductDetail.tsx';
import type { CategoryConfig } from '../../types/category.ts';
import {
  fetchProduct,
  fetchCategoryConfig,
  generateProductStaticPaths,
} from '../../utils/productPaths.ts';

export const prerender = true;

interface StaticProps {
  categoryConfig?: CategoryConfig;
}

export async function getStaticPaths() {
  return await generateProductStaticPaths();
}

const { category, productSlug } = Astro.params;
const { categoryConfig: prefetchedCategory } = (Astro.props as StaticProps) ?? {};

const {
  categoryConfig,
  error: categoryError,
  notFound: categoryNotFound,
} = await fetchCategoryConfig(category, prefetchedCategory);

if (categoryNotFound || !categoryConfig) {
  return Astro.redirect('/404');
}

const { product, error: productError, notFound: productNotFound } = await fetchProduct(productSlug);

if (productNotFound || !product) {
  return Astro.redirect('/404');
}

if (product.category !== categoryConfig.slug) {
  console.warn(
    `Product slug "${productSlug}" does not match category "${categoryConfig.slug}"; redirecting to 404.`
  );
  return Astro.redirect('/404');
}

if (categoryError) {
  console.warn(`Category fallback used for slug "${category}":`, categoryError);
}

const error = productError;
---

{
  error ? (
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">載入產品時發生錯誤</h1>
        <p class="text-gray-600 mb-6">{error}</p>
        <a
          href={categoryConfig.urlPath || `/${categoryConfig.slug}`}
          class="bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800"
        >
          返回產品列表
        </a>
      </div>
    </div>
  ) : (
    product && (
      <ProductLayout
        title={product.name}
        description={product.description}
        image={product.images?.[0]}
      >
        <ProductImageCarousel
          images={product.images || []}
          productName={product.name}
          client:load
          slot="product-images"
        />

        <div slot="product-details">
          <ProductDetail
            product={product}
            categoryConfig={categoryConfig}
            className="mt-6"
            client:load
          />

          <div class="mt-8 lg:hidden">
            <ProductTabs
              features={product.features || []}
              specifications={product.specifications}
              categoryFeatures={categoryConfig.features}
              categoryName={categoryConfig.series}
              client:load
            />
          </div>
        </div>

        <div class="hidden lg:block" slot="product-tabs">
          <ProductTabs
            features={product.features || []}
            specifications={product.specifications}
            categoryFeatures={categoryConfig.features}
            categoryName={categoryConfig.series}
            client:load
          />
        </div>
      </ProductLayout>
    )
  )
}
