---
import PostLayout from '../../layouts/PostLayout.astro';
import type { BlogPost, PostCategory } from '@blackliving/types';

export async function getStaticPaths() {
  try {
    // Fetch all published customer reviews to generate static paths
    const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
    const response = await fetch(`${apiUrl}/api/posts/public?category=client-review&limit=100`);
    if (!response.ok) {
      console.error('Failed to fetch customer reviews for static generation');
      return [];
    }

    const data = await response.json();
    const reviews = data.data || [];

    return reviews.map((review: BlogPost) => ({
      params: { postSlug: review.slug },
    }));
  } catch (error) {
    console.error('Error generating static paths for customer reviews:', error);
    return [];
  }
}

const { postSlug } = Astro.params;
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

// Fetch customer review using enhanced API endpoint with embedded category
const postResponse = await fetch(`${apiUrl}/api/posts/${postSlug}?include=category`);
if (!postResponse.ok) {
  return Astro.redirect('/404');
}

const postData = await postResponse.json();
const post: BlogPost & { category?: PostCategory } = postData.data;

// Only show if it's actually a customer review  
const isCustomerReview = post.category?.slug === 'client-review' || 
  post.category?.includes('client') || post.category?.includes('review') ||
  post.category?.includes('客戶') || post.category?.includes('評價');

if (!isCustomerReview) {
  return Astro.redirect('/404');
}

const category = post.category || null;

// Fetch related customer reviews (simplified)
let relatedPosts: BlogPost[] = [];
try {
  const relatedResponse = await fetch(
    `${apiUrl}/api/posts/public?category=client-review&limit=3`
  );
  if (relatedResponse.ok) {
    const relatedData = await relatedResponse.json();
    relatedPosts = (relatedData.data || []).filter((p: BlogPost) => p.slug !== postSlug);
  }
} catch (error) {
  console.warn('Failed to fetch related customer reviews:', error);
}

// SEO data for customer reviews
const seoTitle = post.seoTitle || `${post.title} | 顧客好評 | 黑哥家居`;
const seoDescription = post.seoDescription || post.excerpt || post.description;
const ogImage = post.featuredImage || '/images/default-og.jpg';
---

<PostLayout 
  {post}
  {category}
  {relatedPosts}
  {seoTitle}
  {seoDescription}
  {ogImage}
/>