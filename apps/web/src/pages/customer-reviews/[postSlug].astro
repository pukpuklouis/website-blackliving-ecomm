---
import PostLayout from '../../layouts/PostLayout.astro';

interface CustomerReview {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  content: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
  seoTitle?: string;
  seoDescription?: string;
  rating?: number;
  product?: string;
  verified?: boolean;
}

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

export async function getStaticPaths() {
  try {
    // Fetch all published customer reviews to generate static paths
    const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';
    const response = await fetch(`${apiUrl}/api/posts/public?category=customer-review&limit=100`);
    if (!response.ok) {
      console.error('Failed to fetch customer reviews for static generation');
      return [];
    }

    const data = await response.json();
    const reviews = data.data || [];

    return reviews.map((review: CustomerReview) => ({
      params: { postSlug: review.slug },
    }));
  } catch (error) {
    console.error('Error generating static paths for customer reviews:', error);
    return [];
  }
}

const { postSlug } = Astro.params;

// Fetch review data
let post: CustomerReview | null = null;
let category: PostCategory | null = null;
let relatedPosts: CustomerReview[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch the customer review
  const postResponse = await fetch(`${apiUrl}/api/posts/${postSlug}`);
  if (postResponse.ok) {
    const postData = await postResponse.json();
    post = postData.data;

    // Only show if it's actually a customer review
    if (post && !post.category.includes('customer') && !post.category.includes('review') && !post.category.includes('顧客') && !post.category.includes('評價')) {
      return Astro.redirect('/404');
    }

    // Fetch category information if categoryId exists
    if (post?.categoryId) {
      const categoryResponse = await fetch(`${apiUrl}/api/posts/categories`);
      if (categoryResponse.ok) {
        const categoriesData = await categoryResponse.json();
        const categories = categoriesData.data || [];
        category = categories.find((cat: PostCategory) => cat.id === post.categoryId);
      }
    }

    // Fetch related customer reviews
    if (post?.categoryId) {
      const relatedResponse = await fetch(
        `${apiUrl}/api/posts/public?category=customer-review&limit=3`
      );
      if (relatedResponse.ok) {
        const relatedData = await relatedResponse.json();
        relatedPosts = (relatedData.data || []).filter((p: CustomerReview) => p.slug !== postSlug);
      }
    }
  }
} catch (error) {
  console.error('Error fetching customer review data:', error);
}

if (!post) {
  return Astro.redirect('/404');
}

// SEO data for customer reviews
const seoTitle = post.seoTitle || `${post.title} | 顧客好評 | 黑哥家居`;
const seoDescription = post.seoDescription || post.excerpt || post.description;
const ogImage = post.featuredImage || '/images/default-og.jpg';
---

<PostLayout 
  {post}
  {category}
  {relatedPosts}
  {seoTitle}
  {seoDescription}
  {ogImage}
/>