---
import BaseLayout from '../../layouts/BaseLayout.astro';

interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

interface CustomerReview {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
  rating?: number;
  product?: string;
  verified?: boolean;
}

// Get categories and customer reviews
let categories: PostCategory[] = [];
let reviews: CustomerReview[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch categories
  const categoriesResponse = await fetch(`${apiUrl}/api/posts/categories`);
  if (categoriesResponse.ok) {
    const categoriesData = await categoriesResponse.json();
    categories = categoriesData.data || [];
  }

  // Fetch customer reviews (filter by category)
  const reviewsResponse = await fetch(`${apiUrl}/api/posts/public?category=client-review`);
  if (reviewsResponse.ok) {
    const reviewsData = await reviewsResponse.json();
    reviews = reviewsData.data || [];
  }
} catch (error) {
  console.error('Error fetching customer reviews data:', error);
}

---

<BaseLayout>
  <main class='container mx-auto px-4 py-8'>
    <div class='text-center mb-12'>
      <h1 class='text-4xl font-bold text-gray-900 mb-4'>顧客好評</h1>
      <p class='text-xl text-gray-600'>來自真實客戶的睡眠體驗分享</p>
    </div>


    <div class='max-w-4xl mx-auto'>
      <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
        {
          reviews.map(review => (
            <article class='bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow'>
              {review.featuredImage && (
                <img src={review.featuredImage} alt={review.title} class='w-full h-48 object-cover' />
              )}
              <div class='p-6'>
                <div class='flex items-center justify-between mb-3'>
                  <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800'>
                    {review.category}
                  </span>
                  {review.rating && (
                    <div class='flex items-center'>
                      {Array.from({ length: 5 }, (_, i) => (
                        <svg
                          class={`w-4 h-4 ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                          fill='currentColor'
                          viewBox='0 0 20 20'
                        >
                          <path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' />
                        </svg>
                      ))}
                    </div>
                  )}
                </div>
                <h2 class='text-xl font-semibold text-gray-900 mb-3'>
                  <a href={`/posts/${review.slug}`} class='hover:text-blue-600'>
                    {review.title}
                  </a>
                </h2>
                <p class='text-gray-600 mb-4 line-clamp-3'>{review.excerpt || review.description}</p>
                
                {review.product && (
                  <div class='mb-4'>
                    <span class='text-sm text-gray-500'>使用產品：</span>
                    <span class='text-sm font-medium text-gray-700'>{review.product}</span>
                  </div>
                )}
                
                <div class='flex items-center justify-between text-sm text-gray-500'>
                  <div class='flex items-center'>
                    <span>顧客：{review.authorName}</span>
                    {review.verified && (
                      <span class='ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800'>
                        已驗證
                      </span>
                    )}
                  </div>
                  <span>{new Date(review.publishedAt).toLocaleDateString('zh-TW')}</span>
                </div>
              </div>
            </article>
          ))
        }
      </div>
      {
        reviews.length === 0 && (
          <div class='text-center py-12'>
            <p class='text-gray-500'>目前尚無顧客評價...</p>
          </div>
        )
      }

    </div>
  </main>


  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</BaseLayout>