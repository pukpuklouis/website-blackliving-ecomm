---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CTA from '../../components/CTA.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import type { BlogPost } from '@blackliving/ui';
interface PostCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  color: string;
  icon: string;
}

interface CustomerReview {
  id: string;
  title: string;
  slug: string;
  description: string;
  excerpt: string;
  authorName: string;
  category: string;
  categoryId: string;
  tags: string[];
  featuredImage: string;
  publishedAt: string;
  viewCount: number;
  readingTime: number;
  rating?: number;
  product?: string;
  verified?: boolean;
}

// Get categories and customer reviews
let categories: PostCategory[] = [];
let reviews: CustomerReview[] = [];

// Use appropriate API URL for both build-time and runtime
const apiUrl = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8787';

try {
  // Fetch categories
  const categoriesResponse = await fetch(`${apiUrl}/api/posts/categories`);
  if (categoriesResponse.ok) {
    const categoriesData = await categoriesResponse.json();
    categories = categoriesData.data || [];
  }

  // Fetch customer reviews (filter by category)
  const reviewsResponse = await fetch(`${apiUrl}/api/posts/public?category=client-review`);
  if (reviewsResponse.ok) {
    const reviewsData = await reviewsResponse.json();
    reviews = reviewsData.data || [];
  }
} catch (error) {
  console.error('Error fetching customer reviews data:', error);
}

// Transform customer reviews to BlogPost format
const posts: BlogPost[] = reviews.map(review => ({
  slug: review.slug,
  title: review.title,
  excerpt: review.excerpt,
  description: review.description,
  featuredImage: review.featuredImage,
  category: review.category,
  readingTime: `${review.readingTime}`,
  authorName: review.authorName,
  publishedAt: review.publishedAt,
}));

---

<BaseLayout 
  title="顧客好評 - Black Living 黑哥家居"
  description="來自真實客戶的睡眠體驗分享，了解 Simmons 黑牌床墊的實際使用心得與評價"
>
  <main class='container mx-auto px-4 py-8 mb-12'>
    <div class='text-center mb-12'>
      <h1 class='text-4xl font-bold text-gray-900 mb-4'>顧客好評</h1>
      <p class='text-xl text-gray-600'>來自真實客戶的睡眠體驗分享</p>
    </div>


    <div class='max-w-4xl mx-auto'>
      <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
        {posts.map(post => (
          <BlogPostCard post={post} variant="vertical" />
        ))}
      </div>
      {
        posts.length === 0 && (
          <div class='text-center py-12'>
            <p class='text-gray-500'>目前尚無顧客評價...</p>
          </div>
        )
      }

    </div>
  </main>
  <CTA />
</BaseLayout>