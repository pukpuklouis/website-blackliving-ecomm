---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlockNoteRenderer from '../components/BlockNoteRenderer';
import MarkdownRenderer from '../components/MarkdownRenderer.astro';

const { slug } = Astro.params;
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

let page = null;
let error = null;

try {
  const response = await fetch(`${apiUrl}/api/pages/${slug}`);
  if (!response.ok) {
    if (response.status === 404) {
      return Astro.redirect('/404');
    }
    throw new Error('Failed to fetch page');
  }
  const json = await response.json();
  if (json.success) {
    page = json.data;
  }
} catch (e) {
  console.error('Error fetching page:', e);
  error = e;
}

if (!page) {
  return Astro.redirect('/404');
}

const { title, content, contentMarkdown, seoTitle, seoDescription, featuredImage, publishedAt } =
  page;
---

<BaseLayout
  title={seoTitle || title}
  description={seoDescription || ''}
  image={featuredImage}
  type="article"
  publishedTime={publishedAt}
>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-8 text-center">
      <h1 class="text-4xl font-bold mb-4">{title}</h1>
      {
        publishedAt && (
          <time datetime={publishedAt} class="hidden text-gray-500">
            {new Date(publishedAt).toLocaleDateString('zh-TW')}
          </time>
        )
      }
    </header>

    {
      featuredImage && (
        <div class="mb-8 rounded-lg overflow-hidden">
          <img src={featuredImage} alt={title} class="w-full h-auto object-cover" />
        </div>
      )
    }

    <div class="mx-auto">
      {
        content && content.length > 0 ? (
          <BlockNoteRenderer client:only="react" content={content} />
        ) : (
          <MarkdownRenderer content={contentMarkdown || ''} />
        )
      }
    </div>
  </article>
</BaseLayout>
