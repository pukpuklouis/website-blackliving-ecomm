# Drizzle Kit Best Practices

This document outlines the correct workflow for managing database migrations with Drizzle Kit to prevent migration issues.

## The Problem We Solved

**Issue:** Migration 0006 tried to recreate tables that already existed (`auth_tokens`, `product_categories`, `reservations`).

**Root Cause:** Migrations 0003-0005 were created manually without corresponding snapshots, breaking the snapshot chain. When `drizzle-kit generate` compared the current schema against the last known snapshot (0002), it thought all these tables were new.

**Solution Applied (Option 3 - Hybrid Fix):** 
- Migration 0006 snapshot includes ALL changes from 0003-0005
- The snapshot chain is repaired from 0006 onwards
- Future migrations will diff correctly against 0006
- Historical migrations (0000-0006) remain intact for sequential replay
- No data loss, no history loss, no consolidation needed

---

## âœ… CORRECT Workflow

### 1. Modify Schema First

Edit `/packages/db/schema.ts` to add/modify tables or columns:

```typescript
// packages/db/schema.ts
export const posts = sqliteTable('posts', {
  id: text('id').primaryKey(),
  title: text('title').notNull(),
  overlaySettings: text('overlay_settings').default('{}'), // NEW COLUMN
  // ... other fields
});
```

### 2. Generate Migration

Always use `drizzle-kit generate` - **NEVER write SQL manually:**

```bash
cd packages/db
pnpm db:generate
```

This creates **BOTH**:
- `migrations/000X_name.sql` - The SQL migration file
- `migrations/meta/000X_snapshot.json` - Snapshot of schema state
- **Automatically validates** migration integrity

### 3. Review Generated SQL

Check the generated SQL file to ensure it looks correct:

```bash
cat migrations/0007_new_migration.sql
```

### 4. Apply Migration Locally

```bash
pnpm db:migrate:local
```

### 5. Test Changes

Verify your database structure is correct:

```bash
# Check table structure
cd ../../apps/api
wrangler d1 execute blackliving-db --local --command="PRAGMA table_info(posts);"

# Or use Drizzle Studio
cd ../../packages/db
pnpm db:studio:local
```

### 6. Apply to Remote (Production)

Only after testing locally:

```bash
pnpm db:migrate:remote
```

---

## âŒ NEVER Do This

### 1. Don't Write SQL Migrations Manually

```bash
# âŒ WRONG - Creates SQL without snapshot
touch migrations/0007_my_changes.sql
# Then manually write SQL...
```

**Why it breaks:**
- No snapshot file created
- Breaks the snapshot chain
- Future migrations will fail

### 2. Don't Edit Generated Snapshots Manually

```bash
# âŒ WRONG
vim migrations/meta/0006_snapshot.json
```

Snapshots are auto-generated by Drizzle Kit. Manual edits cause inconsistencies.

### 3. Don't Skip Migration Steps

```bash
# âŒ WRONG - Modifying schema then directly pushing
# (skips migration generation)
pnpm db:push  # Dangerous! No migration history
```

**Use `db:push` ONLY for:**
- Prototyping during development
- Rapid iteration on local database
- **NEVER for production**

---

## Migration Integrity Protection

### Automatic Validation

Every time you run `pnpm db:generate`, a validation script automatically checks:
- âœ… All migrations have corresponding snapshots (except known legacy 0003-0005)
- âœ… No new migrations are missing snapshots
- âŒ Blocks generation if snapshot chain breaks after migration 0006

### Manual Validation

Check migration integrity anytime:

```bash
pnpm db:validate
```

**Example Output:**
```
ğŸ” Validating migration integrity...

Found 7 migration files
Found 4 snapshot files

âœ… 0000_wakeful_vapor.sql â†’ 0000_snapshot.json
âœ… 0001_glorious_luke_cage.sql â†’ 0001_snapshot.json
âœ… 0002_powerful_big_bertha.sql â†’ 0002_snapshot.json
âŒ 0003_cmdk_search_indexes.sql â†’ MISSING SNAPSHOT! (Known legacy issue)
âŒ 0004_magic_link_reservations.sql â†’ MISSING SNAPSHOT! (Known legacy issue)
âŒ 0005_product_categories.sql â†’ MISSING SNAPSHOT! (Known legacy issue)
âœ… 0006_hot_slayback.sql â†’ 0006_snapshot.json

âœ¨ Migration integrity check complete
```

**Note:** Missing snapshots for 0003-0005 are acceptable because migration 0006 snapshot includes all their changes.

---

## Understanding the Migration System

### Directory Structure

```
packages/db/
â”œâ”€â”€ schema.ts                    â† Source of truth
â”œâ”€â”€ drizzle.config.ts            â† Drizzle configuration
â”œâ”€â”€ client.ts                    â† Database client
â”œâ”€â”€ validate-migrations.js       â† Integrity checker
â””â”€â”€ migrations/
    â”œâ”€â”€ 0000_initial.sql         â† Migration SQL files
    â”œâ”€â”€ 0001_add_users.sql
    â”œâ”€â”€ 0002_add_posts.sql
    â””â”€â”€ meta/
        â”œâ”€â”€ _journal.json        â† Migration registry
        â”œâ”€â”€ 0000_snapshot.json   â† Schema snapshots
        â”œâ”€â”€ 0001_snapshot.json
        â””â”€â”€ 0002_snapshot.json
```

### How Drizzle Tracks Changes

1. **schema.ts** - Your current desired schema
2. **Latest snapshot** - Last known schema state
3. **Diff** - Drizzle compares them to generate migration SQL

**The snapshot chain must be complete:**
```
0000 â†’ 0001 â†’ 0002 â†’ 0003 â†’ 0004
  âœ…     âœ…     âœ…     âœ…     âœ…
```

**A broken chain causes issues:**
```
0000 â†’ 0001 â†’ 0002 â†’ 0003 â†’ 0004
  âœ…     âœ…     âœ…     âŒ     âŒ
                    (gaps cause regeneration of existing tables)
```

**Our fixed chain (Option 3 - Hybrid):**
```
0000 â†’ 0001 â†’ 0002 â†’ 0003 â†’ 0004 â†’ 0005 â†’ 0006
  âœ…     âœ…     âœ…     âŒ     âŒ     âŒ     âœ…
                    (0006 includes all changes from 0003-0005)
                    
Future migrations will diff from 0006 onwards âœ…
```

---

## Available Commands Reference

### Development (Local Database)

```bash
# Generate migration from schema changes (with auto-validation)
pnpm db:generate

# Validate migration integrity manually
pnpm db:validate

# Apply migrations to local database
pnpm db:migrate:local

# Open Drizzle Studio (local)
pnpm db:studio:local

# Seed local database with sample data
pnpm db:seed:local

# Reset local database (destructive!)
pnpm db:reset:local

# Check migration status
pnpm db:status
```

### Production (Remote Database)

```bash
# Apply migrations to remote Cloudflare D1
pnpm db:migrate:remote

# Seed remote database
pnpm db:seed:remote

# Initialize remote database (first time)
pnpm db:init:remote

# Open Drizzle Studio (remote)
pnpm db:studio:remote
```

### Prototyping (Use with Caution)

```bash
# Push schema directly without migration (local only!)
pnpm db:push
```

**âš ï¸ Warning:** `db:push` skips migration generation. Only use for rapid prototyping on local database.

---

## Troubleshooting

### "Table already exists" Error

**Symptom:**
```
âœ˜ [ERROR] table `my_table` already exists: SQLITE_ERROR
```

**Solution:**
1. Check if table actually exists in database
2. If yes, add `IF NOT EXISTS` to the migration SQL:
   ```sql
   CREATE TABLE IF NOT EXISTS `my_table` (...)
   ```

### Missing Snapshot Files

**Symptom:**
Gaps in snapshot sequence (e.g., 0002, 0003, 0006 - missing 0004, 0005)

**Solution:**
- This happened if migrations were created manually
- Best approach: Use Option 3 (Hybrid Fix) - let the next complete snapshot repair the chain
- Prevention: Always use `pnpm db:generate`

### "Duplicate column" Error

**Symptom:**
```
âœ˜ [ERROR] duplicate column name: my_column: SQLITE_ERROR
```

**Solution:**
The column already exists. Remove the `ALTER TABLE ADD COLUMN` statement from the migration file.

### Validation Script Fails After Migration 0006

**Symptom:**
```
âŒ CRITICAL: Missing snapshots after migration 0006!
   This will break future migration generation.
```

**Solution:**
Someone created a migration manually. **DO NOT DO THIS!** Always use `pnpm db:generate`.

---

## Key Principles

1. **schema.ts is the source of truth** - All changes start here
2. **Always use `drizzle-kit generate`** - Never write SQL manually
3. **Auto-validation protects you** - Migration integrity is checked automatically
4. **Test locally first** - Apply to local before remote
5. **Keep snapshot chain intact** - Each migration needs a snapshot
6. **Use migrations for production** - Use `db:push` only for prototyping

---

## Summary

âœ… **DO:**
- Edit `schema.ts` first
- Run `pnpm db:generate` to create migrations (auto-validates)
- Run `pnpm db:validate` if you're unsure about integrity
- Test locally before deploying
- Commit both SQL and snapshot files

âŒ **DON'T:**
- Write SQL migrations manually
- Edit snapshot files
- Skip migration generation with `db:push` in production
- Apply migrations without testing locally first
- Ignore validation warnings

---

## Why Option 3 (Hybrid Fix) Works

**Option 3 keeps everything intact while repairing the chain:**

1. **Existing databases** can still apply migrations 0000-0006 sequentially
2. **New databases** get the same result (all tables created correctly)
3. **Future migrations** generate correctly (diff from 0006 snapshot)
4. **Git history** remains intact (no migration consolidation)
5. **Validation** prevents new gaps from forming

**The key insight:** Migration 0006's snapshot is complete - it includes all tables and columns from 0003-0005 plus the new `overlay_settings` column. This effectively "jumps over" the gap and repairs the chain going forward.

---

**Related Files:**
- `/packages/db/schema.ts` - Database schema definitions
- `/packages/db/drizzle.config.ts` - Drizzle configuration
- `/packages/db/db-sync.js` - Migration management script
- `/packages/db/validate-migrations.js` - Migration integrity checker
- `/packages/db/package.json` - Available npm scripts
