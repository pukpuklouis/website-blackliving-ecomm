{
  "id": "snapshot_1764137373105_z0th27gyv",
  "approvalId": "approval_1764137373088_be7ac853q",
  "approvalTitle": "Tasks Document: Dynamic Page CMS Module",
  "version": 1,
  "timestamp": "2025-11-26T06:09:33.105Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: Dynamic Page CMS Module\n\n- [ ] 1. Create pages table migration in packages/db/migrations/\n  - File: packages/db/migrations/0001_create_pages_table.ts\n  - Create migration for pages table with all required fields (id, slug, title, blocks_json, rendered_markdown, status, meta fields, timestamps)\n  - Follow existing migration patterns from other tables\n  - Purpose: Establish database schema for dynamic pages\n  - _Leverage: packages/db/migrations/0001_create_products_table.ts, packages/db/schema.ts_\n  - _Requirements: 4.1_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Developer specializing in Drizzle ORM migrations | Task: Create pages table migration following requirement 4.1, using existing migration patterns from products table and schema conventions | Restrictions: Must follow Drizzle migration format, include all required fields from design, do not modify existing tables | Success: Migration creates pages table correctly, all fields match design specification, migration runs without errors_\n\n- [ ] 2. Update database schema in packages/db/schema.ts\n  - File: packages/db/schema.ts\n  - Add pages table definition with proper types and relationships\n  - Export Page and NewPage types\n  - Purpose: Define TypeScript schema for pages table\n  - _Leverage: existing table definitions in packages/db/schema.ts_\n  - _Requirements: 4.1_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: TypeScript Developer with Drizzle ORM expertise | Task: Add pages table schema to packages/db/schema.ts following requirement 4.1, using existing table patterns and type exports | Restrictions: Must match migration exactly, follow existing naming conventions, export proper types | Success: Schema compiles without errors, types are properly exported, matches migration structure_\n\n- [ ] 3. Create pages API module in apps/api/src/modules/pages.ts\n  - File: apps/api/src/modules/pages.ts\n  - Implement CRUD operations for pages (create, read, update, delete)\n  - Add slug uniqueness validation and reserved route checking\n  - Integrate with existing auth middleware for admin-only access\n  - Purpose: Provide backend API for page management\n  - _Leverage: apps/api/src/modules/products.ts, apps/api/src/middleware/auth.ts_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 4.2_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Cloudflare Workers API Developer | Task: Create pages module with full CRUD operations following requirements 1.1-1.7 and 4.2, leveraging products module patterns and auth middleware | Restrictions: Must validate slugs against reserved routes, implement admin-only access, follow existing API patterns | Success: All CRUD operations work correctly, slug validation prevents conflicts, auth middleware properly integrated_\n\n- [ ] 4. Add page serialization service utility\n  - File: apps/api/src/lib/pageSerialization.ts\n  - Create utility to convert BlockNote blocks to Markdown\n  - Handle image URLs and formatting\n  - Purpose: Enable dual storage of blocks and rendered markdown\n  - _Leverage: BlockNote types, marked library_\n  - _Requirements: 1.5_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: JavaScript Developer specializing in content serialization | Task: Create page serialization utility following requirement 1.5, converting BlockNote blocks to Markdown with proper formatting | Restrictions: Must handle all BlockNote block types, preserve image URLs, ensure clean Markdown output | Success: BlockNote blocks serialize to valid Markdown, images are properly handled, utility is testable and reusable_\n\n- [ ] 5. Add API routes for pages in Cloudflare Workers\n  - File: apps/api/src/routes/pages.ts\n  - Create routes for admin CRUD operations and public read by slug\n  - Integrate with pages module and auth middleware\n  - Purpose: Expose page API endpoints\n  - _Leverage: apps/api/src/routes/products.ts, existing route patterns_\n  - _Requirements: 4.2_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Routing Developer | Task: Create page routes following requirement 4.2, implementing admin CRUD and public read endpoints using existing route patterns | Restrictions: Must separate admin and public routes, apply auth middleware correctly, follow REST conventions | Success: Routes are properly configured, admin endpoints require auth, public endpoints work for published pages_\n\n- [ ] 6. Update wrangler.toml with page routes\n  - File: apps/api/wrangler.toml\n  - Add page route patterns to Cloudflare Workers configuration\n  - Purpose: Enable page API endpoints in deployment\n  - _Leverage: existing route configurations in wrangler.toml_\n  - _Requirements: 4.2_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Cloudflare Developer | Task: Update wrangler.toml to include page routes following requirement 4.2, using existing configuration patterns | Restrictions: Must not break existing routes, follow Cloudflare Workers routing syntax | Success: Page routes are properly configured, deployment includes new endpoints_\n\n- [ ] 7. Create PageList admin component\n  - File: apps/admin/app/routes/dashboard/pages.tsx\n  - Implement page listing with CRUD operations\n  - Add pagination and status filtering\n  - Purpose: Admin interface for managing pages\n  - _Leverage: apps/admin/app/routes/dashboard/products.tsx, BatchOperationsToolbar_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Admin Developer | Task: Create PageList component following requirement 1.1, using products page patterns and BatchOperationsToolbar | Restrictions: Must follow admin UI patterns, implement proper CRUD actions, maintain consistent styling | Success: Page list displays correctly, CRUD operations work, follows admin design patterns_\n\n- [ ] 8. Create PageForm component for metadata\n  - File: apps/admin/app/components/PageForm.tsx\n  - Form for page title, slug, status, and SEO metadata\n  - Include slug validation and auto-generation\n  - Purpose: Handle page metadata input\n  - _Leverage: existing admin form components, ProductEditPage.tsx_\n  - _Requirements: 1.2, 1.6_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Form Developer | Task: Create PageForm component following requirements 1.2 and 1.6, using existing form patterns and validation | Restrictions: Must validate slugs properly, auto-generate slugs from titles, follow form validation patterns | Success: Form validates correctly, slug generation works, integrates with page creation/editing_\n\n- [ ] 9. Create PageEditor component with BlockNote\n  - File: apps/admin/app/components/PageEditor.tsx\n  - Integrate BlockNoteEditor for content editing\n  - Handle image uploads to R2 storage\n  - Implement dual storage (blocks + markdown)\n  - Purpose: Visual page content editor\n  - _Leverage: apps/admin/app/components/editor/BlockNoteEditor.tsx, ImageUploadContext_\n  - _Requirements: 1.3, 1.4, 1.5_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Editor Developer | Task: Create PageEditor component following requirements 1.3-1.5, integrating BlockNoteEditor and R2 image uploads | Restrictions: Must handle image uploads properly, store both blocks and markdown, follow existing editor patterns | Success: Editor loads BlockNote correctly, images upload to R2, dual storage works properly_\n\n- [ ] 10. Add admin routing for pages\n  - File: apps/admin/app/routes.ts\n  - Add page management routes to admin routing\n  - Purpose: Enable navigation to page management\n  - _Leverage: existing admin route patterns_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: React Router Developer | Task: Add page routes to admin routing following requirement 1.1, using existing route patterns | Restrictions: Must follow React Router conventions, integrate with existing admin navigation | Success: Page routes are accessible, navigation works correctly_\n\n- [ ] 11. Create dynamic route handler in web app\n  - File: apps/web/src/pages/[...slug].astro\n  - Implement catch-all route for dynamic pages\n  - Fetch page by slug from API\n  - Render 404 for non-existent pages\n  - Purpose: Dynamic page rendering\n  - _Leverage: existing Astro page patterns, SEO component_\n  - _Requirements: 2.1, 2.2, 2.3, 2.5_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Astro Developer | Task: Create dynamic route handler following requirements 2.1-2.3 and 2.5, using existing page patterns | Restrictions: Must handle SSR properly, implement 404 fallback, follow Astro conventions | Success: Dynamic routes work correctly, published pages render, 404 shows for missing pages_\n\n- [ ] 12. Create Markdown renderer component\n  - File: apps/web/src/components/MarkdownRenderer.astro\n  - Render Markdown content with syntax highlighting\n  - Apply site typography and styling\n  - Purpose: Display page content\n  - _Leverage: marked library, Tailwind Typography_\n  - _Requirements: 2.4, 2.6_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Astro Component Developer | Task: Create Markdown renderer following requirements 2.4 and 2.6, using marked and Tailwind Typography | Restrictions: Must sanitize content for security, apply consistent styling, support GFM | Success: Markdown renders correctly, styling matches site design, content is properly sanitized_\n\n- [ ] 13. Integrate SEO component with dynamic pages\n  - File: apps/web/src/pages/[...slug].astro (modify)\n  - Map page metadata to SEO component props\n  - Handle featured images and descriptions\n  - Purpose: Enable SEO for dynamic pages\n  - _Leverage: apps/web/src/components/SEO.astro_\n  - _Requirements: 3.1, 3.2, 3.3_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: SEO Integration Developer | Task: Integrate SEO component with dynamic pages following requirements 3.1-3.3, mapping metadata correctly | Restrictions: Must handle missing metadata gracefully, use proper Open Graph types, follow existing SEO patterns | Success: SEO metadata renders correctly, Open Graph images work, search engines can index pages_\n\n- [ ] 14. Add comprehensive error handling\n  - Files: apps/api/src/modules/pages.ts, apps/web/src/pages/[...slug].astro\n  - Handle serialization failures, API errors, 404s\n  - Add proper error logging and user feedback\n  - Purpose: Improve system reliability\n  - _Leverage: existing error handling patterns_\n  - _Requirements: NFR Reliability, Security_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Error Handling Developer | Task: Add comprehensive error handling following NFR requirements, handling serialization failures and API errors | Restrictions: Must not expose sensitive information, provide user-friendly error messages, follow existing error patterns | Success: Errors are handled gracefully, users see appropriate messages, system remains stable_\n\n- [ ] 15. Implement caching strategy\n  - Files: apps/api/src/lib/cache.ts (modify), apps/api/src/modules/pages.ts (modify)\n  - Add page response caching with invalidation\n  - Cache published page content\n  - Purpose: Improve performance\n  - _Leverage: existing cache patterns in apps/api/src/lib/cache.ts_\n  - _Requirements: NFR Performance_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Caching Developer | Task: Implement caching strategy following NFR Performance requirements, using existing cache patterns | Restrictions: Must invalidate cache on page updates, follow existing caching conventions, ensure cache consistency | Success: Page responses are cached appropriately, cache invalidates on updates, performance improves_\n\n- [ ] 16. Add unit tests for page serialization\n  - File: apps/api/test/pageSerialization.test.ts\n  - Test BlockNote to Markdown conversion\n  - Test image URL handling\n  - Purpose: Ensure serialization reliability\n  - _Leverage: existing test patterns in apps/api/test/_\n  - _Requirements: Testing Strategy_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Test Developer | Task: Add unit tests for page serialization following testing strategy, covering BlockNote conversion and image handling | Restrictions: Must test edge cases, follow existing test patterns, ensure good coverage | Success: Serialization tests pass, edge cases covered, tests are maintainable_\n\n- [ ] 17. Add integration tests for pages API\n  - File: apps/api/test/pages.integration.test.ts\n  - Test CRUD operations and slug validation\n  - Test auth middleware integration\n  - Purpose: Ensure API reliability\n  - _Leverage: existing integration test patterns_\n  - _Requirements: Testing Strategy_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration Test Developer | Task: Add integration tests for pages API following testing strategy, covering CRUD and auth | Restrictions: Must test real database operations, follow existing test patterns, ensure isolation | Success: API integration tests pass, auth works correctly, tests are reliable_\n\n- [ ] 18. Add E2E tests for admin page management\n  - File: apps/admin/test/pages.e2e.test.ts\n  - Test complete page creation and editing workflow\n  - Test BlockNote editor integration\n  - Purpose: Validate end-to-end functionality\n  - _Leverage: existing E2E test patterns with Playwright_\n  - _Requirements: Testing Strategy_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: E2E Test Developer | Task: Add E2E tests for admin page management following testing strategy, using Playwright for complete workflows | Restrictions: Must test real user interactions, follow existing E2E patterns, ensure test stability | Success: E2E tests validate complete workflows, editor integration works, tests run reliably_\n\n- [ ] 19. Performance optimization and final polish\n  - Files: Various files as needed\n  - Optimize Markdown rendering performance\n  - Add loading states and error boundaries\n  - Final code cleanup and documentation\n  - Purpose: Production readiness\n  - _Leverage: existing performance patterns_\n  - _Requirements: NFR Performance, Implementation Phases 4_\n  - _Prompt: Implement the task for spec dynamic-page-cms, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Performance Optimization Developer | Task: Perform final optimization and polish following NFR Performance and Phase 4 requirements | Restrictions: Must not break existing functionality, focus on performance improvements, ensure production readiness | Success: Performance is optimized, code is clean, system is production-ready_",
  "fileStats": {
    "size": 16059,
    "lines": 174,
    "lastModified": "2025-11-26T06:08:57.711Z"
  },
  "comments": []
}
