{
  "id": "snapshot_1762244715581_p8d588922",
  "approvalId": "approval_1762244715572_md1mxfvqk",
  "approvalTitle": "Admin Settings System Design Document",
  "version": 1,
  "timestamp": "2025-11-04T08:25:15.581Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Admin Settings System will provide a comprehensive interface for Black Living administrators to manage system configuration, user permissions, and operational settings. The system will replace the current placeholder implementation with a robust, secure, and auditable settings management platform that supports the platform's operational excellence goals.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nThe design follows established technical patterns including:\n- **TypeScript-first development** with strict type checking\n- **Zod schema validation** for all data structures\n- **Drizzle ORM** for type-safe database operations\n- **Hono framework** for API development with proper middleware\n- **Better Auth** integration for role-based access control\n- **Cloudflare D1** for reliable data persistence\n\n### Project Structure (structure.md)\nThe implementation follows the project's modular architecture:\n- **Feature-based organization** with clear separation of concerns\n- **Shared packages** for common utilities and types\n- **Environment-specific configuration** management\n- **Consistent naming conventions** and file structure\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n#### SettingsManagement.tsx Component\n- **Current State**: Well-structured React component with tabbed interface\n- **Reuse Strategy**: Extend existing component with full functionality\n- **Integration Points**: Maintain existing API contracts and UI patterns\n- **Enhancements Needed**: Add form validation, error handling, and real-time updates\n\n#### Better Auth Integration\n- **Existing Implementation**: User roles stored in users table\n- **Reuse Strategy**: Extend role system with admin-specific permissions\n- **Integration Points**: Leverage existing session management and RBAC middleware\n\n#### Database Schema Patterns\n- **Existing Tables**: Users, sessions, accounts follow established patterns\n- **Reuse Strategy**: Apply same patterns for settings and audit tables\n- **Integration Points**: Use existing cuid2 ID generation and timestamp handling\n\n### Integration Points\n\n#### Frontend-Backend Communication\n- **API Layer**: Extend existing Hono routes with settings endpoints\n- **State Management**: Leverage existing Zustand patterns in SettingsManagement component\n- **Error Handling**: Use established error response formats and toast notifications\n\n#### Database Integration\n- **Schema Extension**: Add settings and audit tables following existing patterns\n- **Migration Strategy**: Create backward-compatible migrations\n- **Query Optimization**: Implement proper indexing for settings lookups\n\n## Architecture\n\n### Modular Design Principles\n\n#### Single File Responsibility\n- `SettingsManagement.tsx`: Main UI component orchestrating all settings tabs\n- `settingsService.ts`: API communication and data transformation\n- `settingsSchemas.ts`: Zod validation schemas for all settings types\n- `auditService.ts`: Audit logging and retrieval functionality\n- `permissionsService.ts`: User role and permission management\n\n#### Component Isolation\n- **Settings Components**: Each settings domain (website, payments, logistics) in separate components\n- **Form Components**: Reusable form inputs with validation\n- **Modal Components**: Confirmation dialogs and advanced settings\n- **Table Components**: Data display with sorting and filtering\n\n#### Service Layer Separation\n- **API Services**: Handle HTTP communication and response transformation\n- **Business Logic**: Validation, transformation, and business rules\n- **Data Access**: Database queries and mutations\n- **Caching Layer**: Cloudflare KV integration for performance\n\n```mermaid\ngraph TD\n    A[SettingsManagement.tsx] --> B[settingsService.ts]\n    B --> C[API Routes]\n    C --> D[Database Layer]\n    A --> E[permissionsService.ts]\n    E --> F[Better Auth RBAC]\n    B --> G[auditService.ts]\n    G --> H[Audit Database]\n    D --> I[Cloudflare KV Cache]\n```\n\n## Components and Interfaces\n\n### Core Components\n\n#### SettingsManagement Component\n- **Purpose**: Main container component managing all settings tabs and state\n- **Interfaces**:\n  ```typescript\n  interface SettingsManagementProps {\n    initialData?: SettingsData;\n    onSettingsChange?: (changes: SettingsChanges) => void;\n  }\n  ```\n- **Dependencies**: React hooks, UI components, settings services\n- **Reuses**: Existing tab structure and layout patterns\n\n#### WebsiteSettingsForm Component\n- **Purpose**: Manage core website information and branding\n- **Interfaces**:\n  ```typescript\n  interface WebsiteSettings {\n    siteTitle: string;\n    siteDescription: string;\n    contactEmail: string;\n    contactPhone: string;\n    businessHours: string;\n    address: string;\n    socialLinks: SocialLinks;\n  }\n  ```\n- **Dependencies**: Form validation, API services\n- **Reuses**: Existing form input components\n\n#### UserPermissionsManager Component\n- **Purpose**: Admin user role assignment and management\n- **Interfaces**:\n  ```typescript\n  interface AdminUser {\n    id: string;\n    email: string;\n    name: string;\n    role: 'super_admin' | 'admin' | 'editor' | 'viewer';\n    lastLogin?: Date;\n    createdAt: Date;\n  }\n  ```\n- **Dependencies**: Permissions service, audit logging\n- **Reuses**: Existing table components and modal dialogs\n\n#### AuditLogViewer Component\n- **Purpose**: Display and filter settings change history\n- **Interfaces**:\n  ```typescript\n  interface AuditLog {\n    id: string;\n    userId: string;\n    userEmail: string;\n    action: string;\n    resource: string;\n    oldValue?: any;\n    newValue?: any;\n    timestamp: Date;\n    ipAddress: string;\n  }\n  ```\n- **Dependencies**: Audit service, date formatting utilities\n- **Reuses**: Existing table and filter components\n\n### Service Layer Components\n\n#### SettingsService\n- **Purpose**: Centralized API communication for all settings operations\n- **Methods**:\n  - `loadWebsiteSettings()`: Fetch website configuration\n  - `saveWebsiteSettings(data)`: Update website settings with validation\n  - `loadPaymentSettings()`: Fetch payment configuration (placeholder)\n  - `loadLogisticsSettings()`: Fetch logistics configuration (placeholder)\n- **Dependencies**: Fetch API, error handling utilities\n- **Reuses**: Existing API patterns and error handling\n\n#### PermissionsService\n- **Purpose**: User role and permission management\n- **Methods**:\n  - `getAdminUsers()`: Retrieve all admin users with roles\n  - `updateUserRole(userId, role)`: Change user permissions\n  - `removeAdminUser(userId)`: Revoke admin privileges\n- **Dependencies**: Better Auth integration, audit service\n- **Reuses**: Existing authentication patterns\n\n#### AuditService\n- **Purpose**: Settings change tracking and audit log management\n- **Methods**:\n  - `logSettingsChange(change)`: Record settings modifications\n  - `getAuditLogs(filters)`: Retrieve filtered audit history\n  - `exportAuditLogs()`: Generate secure audit exports\n- **Dependencies**: Database layer, encryption utilities\n- **Reuses**: Existing logging patterns\n\n## Data Models\n\n### Settings Tables\n\n#### settings Table\n```typescript\nexport const settings = sqliteTable('settings', {\n  id: text('id').primaryKey().$defaultFn(() => createId()),\n  namespace: text('namespace').notNull(), // 'permissions', 'website', 'payments', 'logistics'\n  key: text('key').notNull(),\n  valueJson: text('value_json').notNull(), // Zod-validated JSON\n  version: integer('version').notNull().default(1),\n  updatedBy: text('updated_by'), // Admin user ID\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n});\n```\n\n#### settings_audit Table\n```typescript\nexport const settingsAudit = sqliteTable('settings_audit', {\n  id: text('id').primaryKey().$defaultFn(() => createId()),\n  namespace: text('namespace').notNull(),\n  key: text('key').notNull(),\n  oldValueJson: text('old_value_json'),\n  newValueJson: text('new_value_json').notNull(),\n  actedBy: text('acted_by').notNull(), // Admin user ID\n  actedAt: integer('acted_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  prevHash: text('prev_hash'), // For integrity chaining\n  hash: text('hash').notNull(), // SHA-256 of record\n});\n```\n\n### API Response Models\n\n#### Unified Settings Response\n```typescript\ninterface SettingsResponse<T = any> {\n  success: boolean;\n  data: T;\n  version: number;\n  lastModified: Date;\n  modifiedBy?: string;\n}\n```\n\n#### Audit Log Response\n```typescript\ninterface AuditLogResponse {\n  logs: AuditLog[];\n  total: number;\n  hasMore: boolean;\n  nextCursor?: string;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### Validation Errors\n- **Scenario**: Invalid email format in contact settings\n- **Handling**: Client-side validation with Zod schemas, server-side re-validation\n- **User Impact**: Inline error messages with specific field highlighting\n\n#### Permission Errors\n- **Scenario**: Non-admin attempts to access settings\n- **Handling**: Better Auth middleware blocks request at API level\n- **User Impact**: Redirect to login or access denied page\n\n#### Network Errors\n- **Scenario**: API request fails due to connectivity issues\n- **Handling**: Retry logic with exponential backoff, offline queue for critical changes\n- **User Impact**: Toast notification with retry option\n\n#### Concurrency Conflicts\n- **Scenario**: Two admins modify same setting simultaneously\n- **Handling**: Optimistic concurrency control with version checking\n- **User Impact**: Conflict resolution dialog with merge options\n\n## Testing Strategy\n\n### Unit Testing\n- **Component Testing**: SettingsManagement tabs render correctly\n- **Service Testing**: API calls return expected data structures\n- **Validation Testing**: Zod schemas reject invalid data\n- **Utility Testing**: Date formatting and encryption functions\n\n### Integration Testing\n- **API Integration**: Full request/response cycles with mock server\n- **Database Integration**: CRUD operations with transaction rollback\n- **Authentication Integration**: Role-based access control enforcement\n- **Caching Integration**: KV cache invalidation and retrieval\n\n### End-to-End Testing\n- **Settings Workflow**: Complete settings modification and audit verification\n- **Permission Management**: Role changes and access control validation\n- **Error Scenarios**: Network failures and conflict resolution\n- **Mobile Responsiveness**: Settings interface works on all device sizes\n\n## Implementation Plan\n\n### Phase 1: Core Infrastructure (Week 1-2)\n1. Create database tables and migrations\n2. Implement basic API endpoints with placeholder responses\n3. Set up Zod validation schemas\n4. Create audit logging infrastructure\n\n### Phase 2: Website Settings (Week 3-4)\n1. Implement website settings CRUD operations\n2. Add form validation and error handling\n3. Integrate caching layer\n4. Add audit logging for changes\n\n### Phase 3: User Permissions (Week 5-6)\n1. Extend Better Auth integration for admin roles\n2. Implement permission management UI\n3. Add role-based access controls\n4. Create permission audit trails\n\n### Phase 4: Payment & Logistics Placeholders (Week 7-8)\n1. Implement feature flag system\n2. Create placeholder UI components\n3. Add proper error responses for disabled features\n4. Document future implementation requirements\n\n### Phase 5: Audit & Security (Week 9-10)\n1. Implement comprehensive audit logging\n2. Add settings export/import functionality\n3. Create security monitoring and alerts\n4. Performance optimization and testing\n",
  "fileStats": {
    "size": 11454,
    "lines": 320,
    "lastModified": "2025-11-04T08:25:10.601Z"
  },
  "comments": []
}