{
  "id": "snapshot_1764357514846_99yyxml41",
  "approvalId": "approval_1764357514818_wyp4fz9gn",
  "approvalTitle": "MeiliSearch Search Integration Design",
  "version": 1,
  "timestamp": "2025-11-28T19:18:34.846Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe MeiliSearch integration replaces the current D1 SQL LIKE queries with a dedicated search engine to provide fast, typo-tolerant, and unified search across Products, Blog Posts, and Static Pages. This feature achieves sub-50ms response times while maintaining the existing Cmd+K modal interface and adding enhanced search capabilities including autocomplete, faceted filtering, and analytics.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nThe design follows established patterns in the Black Living e-commerce platform:\n- **API Architecture**: Hono-based modules with TypeScript interfaces\n- **Data Storage**: Cloudflare D1 with Drizzle ORM for primary data, Cloudflare KV for configuration\n- **Frontend State**: Zustand stores with React hooks\n- **Error Handling**: Centralized error utilities with proper HTTP status codes\n- **Authentication**: Admin-only endpoints using existing auth middleware\n\n### Project Structure (structure.md)\nThe implementation follows the monorepo structure:\n- **Backend**: `apps/api/src/modules/` for business logic, `apps/api/src/routes/` for HTTP endpoints\n- **Frontend**: `apps/web/src/services/` for API clients, `apps/web/src/stores/` for state management\n- **Admin**: `apps/admin/app/routes/` for pages, `apps/admin/app/services/` for API calls\n- **Shared**: Workspace packages for types, database schemas, and UI components\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Hono App Pattern**: `apps/api/src/modules/products.ts` - Reusable for SearchModule structure\n- **KV Storage**: `apps/api/src/lib/storage.ts` - For configuration storage (though we'll use D1/KV for search config)\n- **Cache Layer**: `apps/api/src/lib/cache.ts` - For search result caching\n- **Auth Middleware**: `apps/api/src/middleware/auth.ts` - For admin-only endpoints\n- **Search Store**: `apps/web/src/stores/searchStore.ts` - Will be extended for MeiliSearch results\n- **Search Service**: `apps/web/src/services/searchService.ts` - Will be updated to use MeiliSearch client\n\n### Integration Points\n- **Database**: Products, posts, pages tables via existing Drizzle schemas\n- **Cache**: Cloudflare KV for search configuration and result caching\n- **Storage**: Cloudflare R2 (not directly used but follows same patterns)\n- **Authentication**: Admin routes for configuration management\n- **Frontend**: Existing SearchModal component and Cmd+K shortcut handling\n\n## Architecture\n\nThe design implements a modular search service architecture with clear separation of concerns:\n\n### Modular Design Principles\n- **Single File Responsibility**: Each module handles one aspect (config, indexing, search)\n- **Component Isolation**: SearchModule, sync utilities, and frontend service are independent\n- **Service Layer Separation**: Backend indexing, frontend querying, admin configuration\n- **Utility Modularity**: Content transformation utilities are focused and reusable\n\n```mermaid\ngraph TD\n    A[Frontend SearchModal] --> B[searchService.ts]\n    B --> C[MeiliSearch Client]\n    C --> D[MeiliSearch API]\n\n    E[Admin Settings] --> F[search config API]\n    F --> G[SearchModule.saveConfig]\n\n    H[CRUD Operations] --> I[Sync Hooks]\n    I --> J[SearchModule.indexDocument]\n    J --> C\n\n    K[Admin Reindex] --> L[search reindex API]\n    L --> M[SearchModule.reindexAll]\n    M --> C\n```\n\n## Components and Interfaces\n\n### SearchModule (Backend)\n- **Purpose:** Centralized MeiliSearch client and operations\n- **Interfaces:**\n  - `saveConfig(host: string, masterKey: string): Promise<void>`\n  - `getConfig(): Promise<{host: string, searchKey: string}>`\n  - `reindexAll(): Promise<{indexed: number, errors: string[]}>`\n  - `indexDocument(type: string, data: any): Promise<void>`\n  - `deleteDocument(type: string, id: string): Promise<void>`\n- **Dependencies:** MeiliSearch client, KV/D1 storage, existing cache utilities\n- **Reuses:** Existing error handling patterns, storage abstractions\n\n### Search Sync Utilities\n- **Purpose:** Transform content into MeiliSearch document format\n- **Interfaces:**\n  - `transformProduct(product: Product): SearchDocument`\n  - `transformPost(post: Post): SearchDocument`\n  - `transformPage(page: Page): SearchDocument`\n- **Dependencies:** Existing data models, HTML sanitization utilities\n- **Reuses:** Content processing patterns from existing modules\n\n### Frontend Search Service\n- **Purpose:** Query MeiliSearch with unified search interface\n- **Interfaces:**\n  - `fetchUnifiedSearch(query: string, filters?: any): Promise<SearchResult[]>`\n  - `fetchAutocomplete(query: string): Promise<string[]>`\n- **Dependencies:** MeiliSearch client, existing search store\n- **Reuses:** Existing search service patterns and error handling\n\n### Admin Configuration UI\n- **Purpose:** Manage MeiliSearch settings through admin interface\n- **Interfaces:** Form components for host URL and API keys\n- **Dependencies:** Existing admin UI patterns, API service layer\n- **Reuses:** Settings page structure, form validation patterns\n\n## Data Models\n\n### SearchDocument (MeiliSearch Index)\n```\ninterface SearchDocument {\n  id: string;              // \"product_123\", \"post_456\", \"page_789\"\n  type: \"product\" | \"post\" | \"page\";\n  title: string;           // Product/post/page title\n  slug: string;            // URL slug\n  description: string;     // Truncated description/content\n  content: string;         // Full searchable content (HTML stripped)\n  image?: string;          // Primary image URL\n  category?: string;       // Product category or content category\n  tags: string[];          // Associated tags\n  updatedAt: string;       // ISO timestamp\n  // Product-specific fields\n  price?: number;          // For products\n  inStock?: boolean;       // For products\n  // Content-specific fields\n  published?: boolean;     // For posts/pages\n  author?: string;         // For posts\n}\n```\n\n### Search Configuration\n```\ninterface SearchConfig {\n  host: string;            // \"https://meilisearch.anlstudio.cc\"\n  masterKey: string;       // Admin key for indexing\n  searchKey: string;       // Public key for searching\n  indexName: string;       // \"blackliving_content\"\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **MeiliSearch Unavailable**\n   - **Handling:** Graceful fallback to D1 LIKE search with user notification\n   - **User Impact:** Slower search results with \"Search temporarily limited\" message\n\n2. **Indexing Failures**\n   - **Handling:** Log errors, retry with exponential backoff, alert admin via logs\n   - **User Impact:** Content may not appear in search until next successful sync\n\n3. **Configuration Invalid**\n   - **Handling:** Validate on save, show clear error messages in admin UI\n   - **User Impact:** Admin cannot save invalid configuration\n\n4. **Search Key Missing**\n   - **Handling:** Frontend falls back to cached results or shows error\n   - **User Impact:** Search unavailable until configuration is fixed\n\n## Testing Strategy\n\n### Unit Testing\n- SearchModule methods with mocked MeiliSearch client\n- Content transformation utilities with various input formats\n- Frontend search service with mock responses\n- Configuration validation and error handling\n\n### Integration Testing\n- End-to-end indexing workflow (CRUD â†’ MeiliSearch sync)\n- Search configuration API endpoints\n- Frontend-backend search flow with real MeiliSearch instance\n- Admin configuration UI with API integration\n\n### End-to-End Testing\n- Complete user search journey from Cmd+K to results\n- Admin configuration and reindexing workflow\n- Content creation/update with automatic indexing\n- Search performance validation (response time < 100ms)\n- Graceful degradation when MeiliSearch is unavailable",
  "fileStats": {
    "size": 7684,
    "lines": 178,
    "lastModified": "2025-11-28T19:18:21.690Z"
  },
  "comments": []
}
