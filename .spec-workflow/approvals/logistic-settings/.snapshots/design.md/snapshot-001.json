{
  "id": "snapshot_1764506175575_m3z3stbvf",
  "approvalId": "approval_1764506175535_6dqkdk0a4",
  "approvalTitle": "Logistic Settings Design",
  "version": 1,
  "timestamp": "2025-11-30T12:36:15.575Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Flexible Logistic Settings feature allows administrators to configure shipping fees and free shipping thresholds via the admin panel. This removes the hardcoded values in the frontend, enabling dynamic adjustments based on business needs. The system will persist these settings in a new database table and expose them via an API, which the frontend will consume to calculate shipping costs.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Database**: Uses Drizzle ORM with SQLite, consistent with the existing schema definition in `packages/db/schema.ts`.\n- **API**: Follows the Hono framework pattern used in `apps/api`, with Zod for validation.\n- **Frontend**: Uses React components and Zustand for state management in `apps/web`, aligning with the current architecture.\n\n### Project Structure (structure.md)\n- **Database Schema**: Adds a new table definition in `packages/db/schema.ts`.\n- **API Module**: Adds a new module `apps/api/src/modules/settings.ts`.\n- **Admin UI**: Adds a new route `apps/admin/app/routes/dashboard/settings.tsx`.\n- **Web Store**: Updates `apps/web/src/stores/cartStore.ts`.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`cartStore`**: The existing Zustand store will be extended to fetch and store settings.\n- **`requireAdmin`**: The auth middleware will be used to protect the settings update endpoint.\n- **`Button`, `Input`, `Label`**: UI components from `@blackliving/ui` (or local admin components) will be used for the settings form.\n\n### Integration Points\n- **Database**: A new `settings` table will be added.\n- **API**: New endpoints `/api/settings/:key` will be created.\n\n## Architecture\n\n### Modular Design Principles\n- **Settings Module**: The backend logic for settings is isolated in `modules/settings.ts`.\n- **Store Extension**: The cart logic remains in `cartStore.ts` but is enhanced with async fetching capabilities.\n\n```mermaid\ngraph TD\n    Admin[Admin Panel] -->|PUT /api/settings| API\n    Web[Web App] -->|GET /api/settings| API\n    API -->|Read/Write| DB[(Database)]\n    Web -->|Calculate Fee| CartStore[Cart Store]\n    CartStore -->|Use Settings| Logic[Shipping Logic]\n```\n\n## Components and Interfaces\n\n### Database Schema (`settings`)\n- **Purpose**: Store key-value pairs for global application settings.\n- **Interfaces**:\n  ```typescript\n  export const settings = sqliteTable('settings', {\n    id: text('id').primaryKey(),\n    key: text('key').notNull().unique(), // e.g., 'logistic_settings'\n    value: text('value', { mode: 'json' }).notNull(), // e.g., { shippingFee: 1500, threshold: 30000 }\n    updatedAt: integer('updated_at', { mode: 'timestamp' }),\n  });\n  ```\n\n### API Module (`modules/settings.ts`)\n- **Purpose**: Handle CRUD operations for settings.\n- **Interfaces**:\n  - `GET /:key`: Returns the setting value.\n  - `PUT /:key`: Updates the setting value (Admin only).\n\n### Admin Page (`SettingsPage.tsx`)\n- **Purpose**: UI for administrators to view and edit settings.\n- **Interfaces**:\n  - Form with inputs for `shippingFee` and `freeShippingThreshold`.\n  - `onSubmit`: Calls `PUT /api/settings/logistic_settings`.\n\n### Web Store (`cartStore.ts`)\n- **Purpose**: Manage cart state and business logic.\n- **Updates**:\n  - `fetchSettings()`: Action to load settings from API.\n  - `logisticSettings`: State to hold the fetched values.\n  - `calculateShippingFee()`: Updated to use `logisticSettings` or defaults.\n\n## Data Models\n\n### Logistic Settings Value\n```typescript\ninterface LogisticSettings {\n  shippingFee: number;\n  freeShippingThreshold: number;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **API Failure (Web)**: If fetching settings fails.\n   - **Handling**: Fallback to hardcoded default values (1500/30000).\n   - **User Impact**: User sees standard shipping rates; no disruption to checkout.\n\n2. **Invalid Input (Admin)**: Admin enters negative numbers.\n   - **Handling**: Zod validation rejects the request; UI shows error message.\n   - **User Impact**: Admin cannot save invalid settings.\n\n## Testing Strategy\n\n### Unit Testing\n- Test `calculateShippingFee` with various subtotal values and different setting configurations.\n\n### Integration Testing\n- Verify that updating settings in the Admin panel persists to the DB.\n- Verify that the Web app fetches the new settings and updates the shipping fee calculation.\n\n### End-to-End Testing\n- **Admin Flow**: Login -> Go to Settings -> Change Fee -> Save -> Verify Success.\n- **User Flow**: Add items -> Check Cart -> Verify Shipping Fee matches new setting.\n",
  "fileStats": {
    "size": 4567,
    "lines": 112,
    "lastModified": "2025-11-30T12:36:15.391Z"
  },
  "comments": []
}
