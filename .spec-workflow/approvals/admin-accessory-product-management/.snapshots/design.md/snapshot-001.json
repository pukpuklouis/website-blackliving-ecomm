{
  "id": "snapshot_1762179222113_82vhn1eg4",
  "approvalId": "approval_1762179222101_x9o5xtrxh",
  "approvalTitle": "Admin Accessory Product Management Design",
  "version": 1,
  "timestamp": "2025-11-03T14:13:42.113Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Admin Accessory Product Management Design\n\n## Overview\n\nThis feature extends the Black Living admin backend to support comprehensive accessory-type product management. The implementation adds new UI components, API endpoints, and database operations while maintaining minimal changes to existing schema. The design focuses on creating a dedicated product edit page to replace modal-heavy interactions, implementing product type templates, and supporting batch operations for efficient accessory management.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nThe design follows established Black Living technical patterns:\n- **TypeScript 5.x** for all new code with strict type checking\n- **React 19.x** with modern hooks and functional components\n- **Hono 4.x** for new API endpoints following existing route patterns\n- **Drizzle ORM** for database operations with existing query patterns\n- **Zod schemas** for validation following existing product schema structure\n- **Tailwind CSS** with Shadcn UI components for consistent styling\n\n### Project Structure (structure.md)\nThe implementation follows the established monorepo structure:\n- **Admin routes** in `apps/admin/app/routes/dashboard/` for new product edit page\n- **API modules** in `apps/api/src/modules/` extending existing products module\n- **Shared components** in `packages/ui/` for reusable accessory-specific components\n- **Database schemas** already extended in `packages/db/schema.ts`\n- **Type definitions** in `packages/types/` for new accessory-related types\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **ProductManagement.tsx**: Large existing component (1000+ lines) handling product CRUD in modals - will be refactored to extract shared logic and reduce to <500 lines as specified in requirements\n- **ImageUpload component**: Existing image upload functionality for product images\n- **React Table**: Existing table implementation with sorting, filtering, and pagination\n- **Shadcn UI components**: Button, Dialog, Select, Input, Textarea, Badge, Switch components\n- **Zod validation**: Existing product validation patterns extended for accessory fields\n\n### Integration Points\n\n- **Database Schema**: Products table already includes `accessoryType`, `parentProductId`, and `featuresMarkdown` fields\n- **API Layer**: Extend existing `/api/admin/products` endpoints with new accessory-specific operations\n- **Admin UI**: Integrate new dedicated edit page with existing dashboard navigation\n- **Frontend**: Update product display logic to handle `featuresMarkdown` with fallback to `features[]`\n\n## Architecture\n\n### Modular Design Principles\n\nThe design follows single responsibility principles with clear separation of concerns:\n\n- **Product Edit Page** (`/dashboard/products/{id}/edit`): Dedicated page component handling complex product editing\n- **Accessory Components**: Specialized components for variant matrix generation, batch operations, and template selection\n- **API Extensions**: New endpoints integrated into existing products module\n- **Validation Layer**: Extended Zod schemas for accessory-specific validation\n- **Service Layer**: Business logic separated from UI components\n\n### Component Architecture\n\n```mermaid\ngraph TD\n    A[ProductListPage] --> B[ProductManagement Component]\n    B --> C[ProductTable]\n    B --> D[CategoryManagement]\n\n    E[ProductEditPage] --> F[ProductForm]\n    F --> G[BasicInfoSection]\n    F --> H[MediaSection]\n    F --> I[SpecificationsSection]\n    F --> J[FeaturesSection]\n    F --> K[VariantsSection]\n\n    K --> L[VariantMatrixGenerator]\n    K --> M[BatchOperationsToolbar]\n\n    N[API Layer] --> O[Products Module]\n    O --> P[Accessory Endpoints]\n    O --> Q[Batch Operations]\n    O --> R[CSV Import/Export]\n```\n\n## Components and Interfaces\n\n### Product Edit Page (`/dashboard/products/{id}/edit`)\n\n**Purpose:** Dedicated page for complex product editing, replacing modal-based approach.\n\n**Interfaces:**\n```typescript\ninterface ProductEditPageProps {\n  productId?: string; // undefined for new products\n  mode: 'create' | 'edit';\n}\n\ninterface ProductFormData {\n  // Existing fields...\n  accessoryType: 'standalone' | 'accessory' | 'bundle';\n  parentProductId?: string;\n  featuresMarkdown: string;\n  // Extended variant structure\n  variants: Array<{\n    id: string;\n    name: string;\n    price: number;\n    sku: string;\n    size?: string;\n    color?: string;\n    weight?: string;\n    thickness?: string;\n    loft?: string;\n    stock: number;\n    active: boolean;\n  }>;\n}\n```\n\n**Dependencies:** React Router for routing, React Hook Form for form management, existing API services.\n\n### Variant Matrix Generator Component\n\n**Purpose:** Automatically generates product variants from selected option combinations.\n\n**Interfaces:**\n```typescript\ninterface VariantMatrixProps {\n  productType: ProductType;\n  options: ProductOptions;\n  onVariantsGenerated: (variants: Variant[]) => void;\n  onExcludeVariants: (variantIds: string[]) => void;\n}\n\ninterface ProductOptions {\n  size?: string[];\n  color?: string[];\n  weight?: string[];\n  thickness?: string[];\n  loft?: string[];\n  firmness?: string[];\n}\n```\n\n**Reuses:** Existing option selection UI patterns, SKU generation logic.\n\n### Batch Operations Toolbar\n\n**Purpose:** Provides bulk editing capabilities for pricing, inventory, and images.\n\n**Interfaces:**\n```typescript\ninterface BatchOperationsProps {\n  selectedVariants: string[];\n  onBatchUpdate: (updates: BatchUpdate) => void;\n}\n\ninterface BatchUpdate {\n  mode: 'overwrite' | 'fill-empty' | 'increment';\n  field: 'price' | 'stock' | 'images';\n  value: any;\n  differentialPricing?: Record<string, number>; // For option-based price adjustments\n}\n```\n\n**Reuses:** Existing modal patterns, form validation logic.\n\n### Product Type Templates\n\n**Purpose:** Provides predefined templates for different accessory categories.\n\n**Interfaces:**\n```typescript\ninterface ProductTypeTemplate {\n  type: ProductType;\n  axes: VariantAxis[];\n  defaultOptions: Record<string, string[]>;\n  requiredFields: string[];\n  optionalFields: string[];\n}\n\ntype ProductType = 'mattress' | 'protector' | 'sheet-set' | 'pillow' | 'duvet' | 'topper' | 'adjustable-base' | 'other';\n\ntype VariantAxis = 'size' | 'color' | 'weight' | 'thickness' | 'loft' | 'firmness';\n```\n\n## Data Models\n\n### Extended Product Model\n\n```typescript\ninterface Product {\n  // Existing fields...\n  accessoryType: 'standalone' | 'accessory' | 'bundle';\n  parentProductId?: string;\n  featuresMarkdown: string; // Preferred over features[]\n  features: string[]; // Backward compatibility\n\n  // Enhanced variants with accessory-specific fields\n  variants: Array<{\n    id: string;\n    name: string;\n    price: number;\n    sku: string;\n    barcode?: string;\n    size?: string;\n    color?: string;\n    weight?: string;\n    thickness?: string;\n    loft?: string;\n    firmness?: string;\n    stock: number;\n    active: boolean;\n    images: string[]; // Variant-specific images\n  }>;\n}\n```\n\n### Approval Workflow Model\n\n```typescript\ninterface ProductApproval {\n  id: string;\n  productId: string;\n  status: 'draft' | 'in_review' | 'published' | 'archived';\n  requestedBy: string;\n  approvedBy?: string;\n  approvedAt?: Date;\n  changes: FieldChange[]; // For audit logging\n}\n\ninterface FieldChange {\n  field: string;\n  oldValue: any;\n  newValue: any;\n  timestamp: Date;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Product Type Template**\n   - **Handling:** Display clear error message with valid options\n   - **User Impact:** Form validation prevents submission with invalid templates\n\n2. **SKU Uniqueness Violation**\n   - **Handling:** Validate uniqueness on blur and submission, suggest alternatives\n   - **User Impact:** Inline validation with suggested SKU formats\n\n3. **Batch Operation Conflicts**\n   - **Handling:** Preview changes before applying, allow rollback\n   - **User Impact:** Confirmation dialog with affected variant count\n\n4. **CSV Import Errors**\n   - **Handling:** Detailed error reporting with row numbers and fix suggestions\n   - **User Impact:** Downloadable error report with corrected template\n\n## Testing Strategy\n\n### Unit Testing\n- **Component Testing:** ProductEditPage, VariantMatrixGenerator, BatchOperationsToolbar\n- **Utility Testing:** SKU generation, template validation, CSV parsing\n- **API Testing:** New endpoints for accessory operations\n\n### Integration Testing\n- **Form Workflows:** Complete product creation with variants and batch operations\n- **API Integration:** CRUD operations with database state verification\n- **Template Application:** Product type template selection and variant generation\n\n### End-to-End Testing\n- **Admin Workflows:** Complete product management scenarios from creation to publishing\n- **Batch Operations:** Large-scale variant updates and CSV import/export\n- **Approval Workflow:** Status transitions and audit logging\n\n## Implementation Plan\n\n### Phase 1: Core Infrastructure\n1. Extend Zod schemas for accessory fields\n2. Create product type templates configuration\n3. Implement SKU generation utilities\n4. Add new API endpoints to products module\n\n### Phase 2: UI Components\n1. Create dedicated ProductEditPage component\n2. Implement VariantMatrixGenerator component\n3. Build BatchOperationsToolbar component\n4. Refactor ProductManagement.tsx to reduce complexity\n\n### Phase 3: Integration & Testing\n1. Integrate new components with existing admin UI\n2. Implement approval workflow UI\n3. Add CSV import/export functionality\n4. Comprehensive testing and validation\n\n### Phase 4: Optimization & Polish\n1. Performance optimization for large variant matrices\n2. Enhanced error handling and user feedback\n3. Accessibility improvements\n4. Documentation updates\n",
  "fileStats": {
    "size": 9732,
    "lines": 296,
    "lastModified": "2025-11-03T14:13:28.422Z"
  },
  "comments": []
}
