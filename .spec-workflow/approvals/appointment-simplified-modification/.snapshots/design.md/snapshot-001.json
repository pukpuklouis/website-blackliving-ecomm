{
  "id": "snapshot_1764509258652_mqvq3zpxi",
  "approvalId": "approval_1764509258635_p205c5lav",
  "approvalTitle": "Appointment Simplified Modification Design Document",
  "version": 1,
  "timestamp": "2025-11-30T13:27:38.652Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Appointment Simplified Modification feature adds the ability for customers to modify their existing appointments through a simplified, user-friendly interface. Currently, appointments can only be created and have their status changed by admins. This feature allows customers to update appointment details like date, time, store location, and contact information without needing to cancel and rebook. The modification process includes validation to ensure changes are reasonable and don't conflict with existing bookings.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **API Design**: Follows Hono framework patterns with proper validation using Zod schemas. New endpoints will be added to `apps/api/src/modules/appointments.ts` following existing CRUD patterns.\n- **Database**: Uses Drizzle ORM with existing `appointments` table. No new tables required, but may add modification tracking fields.\n- **Frontend**: Uses React components within Astro pages, maintaining existing state management with Zustand stores.\n\n### Project Structure (structure.md)\n- **API**: New endpoints in `apps/api/src/modules/appointments.ts` for modification operations.\n- **UI**: New components in `apps/web/src/components/appointment/` for modification forms and confirmation dialogs.\n- **State**: Updates to `apps/web/src/stores/appointmentStore.ts` to handle modification workflows.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`MultiStepAppointmentForm.tsx`**: The core appointment form can be adapted for modification with pre-populated data.\n- **`AppointmentCard.tsx`**: Existing appointment display component can be extended with modification actions.\n- **`appointmentStore`**: Existing Zustand store for appointment state management.\n- **`appointments` table**: Existing database schema for storing appointment data.\n\n### Integration Points\n- **`POST /api/appointments`**: Existing creation endpoint for reference.\n- **`PATCH /api/appointments/:id/status`**: Existing status update endpoint as a pattern.\n- **Email/SMS notifications**: Existing notification system for modification confirmations.\n\n## Architecture\n\nThe modification feature follows a client-server architecture where the frontend handles the user interface and validation, while the backend manages business logic and data persistence.\n\n```mermaid\ngraph TD\n    A[Customer Dashboard] -->|View Appointments| B[List Appointments API]\n    B -->|Select to Modify| C[Load Appointment Details API]\n    C -->|Display Form| D[Modification Form]\n    D -->|Submit Changes| E[Validate & Update API]\n    E -->|Success| F[Send Confirmation]\n    E -->|Conflict| G[Show Conflict Resolution]\n```\n\n## Components and Interfaces\n\n### Component 1: Appointment Modification API (`apps/api/src/modules/appointments.ts`)\n- **Purpose**: Handle appointment modification requests with validation and conflict checking.\n- **Interfaces**:\n  - `GET /api/appointments/:id/modification-eligibility`: Check if appointment can be modified\n  - `PUT /api/appointments/:id`: Update appointment details with full validation\n  - `POST /api/appointments/:id/modifications`: Record modification history\n- **Dependencies**: `appointments` table, availability checking logic, notification system.\n\n### Component 2: Appointment Modification Form (`apps/web/src/components/appointment/AppointmentModificationForm.tsx`)\n- **Purpose**: Provide a user-friendly interface for modifying appointment details.\n- **Interfaces**:\n  - Props: `appointmentId`, `onSuccess`, `onCancel`\n  - State: Current appointment data, modification form state\n- **Dependencies**: `appointmentStore`, existing form components, date/time pickers.\n\n### Component 3: Modification Confirmation Dialog (`apps/web/src/components/appointment/ModificationConfirmationDialog.tsx`)\n- **Purpose**: Confirm changes and handle conflict resolution.\n- **Interfaces**:\n  - Props: `originalData`, `modifiedData`, `conflicts`, `onConfirm`, `onCancel`\n- **Dependencies**: Dialog components, conflict display logic.\n\n## Data Models\n\nNo new database tables are required. The existing `appointments` table will be extended with modification tracking.\n\n### Appointment Modifications (Extension to existing table)\n```typescript\n// Additional fields to track modifications\nexport const appointmentModifications = sqliteTable('appointment_modifications', {\n  id: text('id').primaryKey(),\n  appointmentId: text('appointment_id').references(() => appointments.id),\n  modifiedBy: text('modified_by'), // customer_id or 'admin'\n  modificationType: text('modification_type'), // 'customer_self', 'admin', 'system'\n  originalData: text('original_data'), // JSON of original appointment\n  newData: text('new_data'), // JSON of modified appointment\n  reason: text('reason'), // optional reason for modification\n  createdAt: integer('created_at', { mode: 'timestamp' }),\n});\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Modification Not Allowed**: Appointment status doesn't allow modification (e.g., completed, cancelled).\n   - **Handling**: Return 403 with clear message about why modification isn't allowed.\n   - **User Impact**: Show informative message with next steps.\n2. **Schedule Conflict**: New date/time conflicts with existing appointments.\n   - **Handling**: Return 409 with conflict details and suggested alternatives.\n   - **User Impact**: Show conflict resolution options.\n3. **Validation Error**: Invalid data submitted.\n   - **Handling**: Return 400 with field-specific error messages.\n   - **User Impact**: Highlight invalid fields with helpful error messages.\n\n## Testing Strategy\n\n### Unit Testing\n- Test modification eligibility logic.\n- Test validation rules for appointment updates.\n- Test conflict detection algorithms.\n- Test modification history recording.\n\n### Integration Testing\n- Test full modification workflow from form submission to database update.\n- Test conflict resolution scenarios.\n- Test notification sending after successful modification.\n\n### End-to-End Testing\n- Test customer modifying their own appointment through the web interface.\n- Test admin modifying appointments through the admin dashboard.\n- Test edge cases like last-minute modifications and conflict resolution.",
  "fileStats": {
    "size": 6245,
    "lines": 117,
    "lastModified": "2025-11-30T13:20:06.453Z"
  },
  "comments": []
}
