{
  "id": "snapshot_1765876354192_v8ed0enn8",
  "approvalId": "approval_1765876354177_ydhvg4wx2",
  "approvalTitle": "Design Approval: Testimonial API Refactor",
  "version": 1,
  "timestamp": "2025-12-16T09:12:34.190Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design: Testimonial API Refactor\n\n## Overview\n\n### Design Approach\nTransform the static testimonial section into a dynamic, API-driven component that fetches testimonials from blog posts. The design maintains the existing UI/UX while introducing proper error handling, caching, and performance optimizations.\n\n### Architecture Principles\n- **Progressive Enhancement**: Page loads without testimonials if API fails\n- **Performance First**: Asynchronous loading with aggressive caching\n- **Maintainability**: Leverage existing patterns and utilities\n- **Resilience**: Multiple fallback strategies for reliability\n\n## System Architecture\n\n### Component Architecture\n\n```\nTestimonialSection (Astro)\n├── TestimonialCard (Astro) - Existing component, unchanged\n├── API Client (TypeScript) - New utility for testimonial fetching\n├── Cache Manager - Leverage existing KV cache\n└── Error Boundary - Graceful error handling\n```\n\n### Data Flow\n\n```\nHomepage Load → TestimonialSection Mount\n    ↓\nAPI Call: GET /api/posts/public?category=blogger-testimonial&featured=true&limit=4\n    ↓\nCache Check (KV) → Cache Hit: Return cached data\n    ↓\nCache Miss: API Call → Transform Data → Cache Response → Return data\n    ↓\nError Handling → Fallback to static testimonials → Log error\n    ↓\nRender testimonial cards with transformed data\n```\n\n## API Design\n\n### Endpoint Usage\n- **URL**: `/api/posts/public`\n- **Method**: GET\n- **Query Parameters**:\n  - `category=blogger-testimonial`\n  - `featured=true`\n  - `limit=4`\n- **Response Format**: Existing posts API response\n\n### Data Transformation\n\n```typescript\ninterface TestimonialData {\n  rating: number;        // Always 5 for featured testimonials\n  source: string;        // Post title (blogger name)\n  text: string;          // Post excerpt/description\n  image?: string;        // Post featuredImage (optimized)\n}\n\nfunction transformPostToTestimonial(post: Post): TestimonialData {\n  return {\n    rating: 5,\n    source: post.title,\n    text: post.excerpt || post.description,\n    image: post.featuredImage\n  };\n}\n```\n\n## Component Design\n\n### TestimonialSection.astro (Updated)\n\n```astro\n---\n// Remove static collection import\n// import { getCollection } from \"astro:content\";\n\n// Add API client import\nimport { fetchTestimonials } from \"../utils/testimonialApi\";\n\n// Fetch testimonials with error handling\nlet testimonials = [];\ntry {\n  testimonials = await fetchTestimonials();\n} catch (error) {\n  console.error('Failed to fetch testimonials:', error);\n  // Fallback to static testimonials will be handled in component\n}\n---\n\n<section class=\"py-16 bg-gray-50\">\n  <div class=\"container mx-auto px-4\">\n    <h2 class=\"text-3xl font-bold text-center mb-12\">部落格推薦</h2>\n\n    <div class=\"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-8\">\n      {testimonials.map((testimonial, index) => (\n        <TestimonialCard testimonial={testimonial} key={index} />\n      ))}\n    </div>\n\n    <div class=\"text-center mt-8\">\n      <a href=\"/testimonials\" class=\"text-black font-semibold hover:underline\">\n        查看更多好評 →\n      </a>\n    </div>\n  </div>\n</section>\n```\n\n### API Client (New)\n\n```typescript\n// utils/testimonialApi.ts\ninterface TestimonialApiResponse {\n  success: boolean;\n  data: Post[];\n  pagination: {\n    total: number;\n    page: number;\n    limit: number;\n  };\n}\n\nexport async function fetchTestimonials(): Promise<TestimonialData[]> {\n  const cacheKey = 'testimonials:featured';\n  const cache = await getCache();\n\n  // Check cache first\n  const cached = await cache.get(cacheKey);\n  if (cached) {\n    return JSON.parse(cached);\n  }\n\n  // Fetch from API\n  const response = await fetch('/api/posts/public?category=blogger-testimonial&featured=true&limit=4');\n  const data: TestimonialApiResponse = await response.json();\n\n  if (!data.success) {\n    throw new Error('Failed to fetch testimonials');\n  }\n\n  // Transform data\n  const testimonials = data.data.map(transformPostToTestimonial);\n\n  // Cache for 5 minutes\n  await cache.set(cacheKey, JSON.stringify(testimonials), { ttl: 300 });\n\n  return testimonials;\n}\n```\n\n## Error Handling & Resilience\n\n### Fallback Strategy\n\n1. **API Failure**: Show static testimonials from content collection\n2. **Partial Data**: Filter out invalid testimonials, show remaining\n3. **Image Failure**: Show testimonials without images\n4. **Complete Failure**: Show generic \"Loading testimonials...\" message\n\n### Error Logging\n\n```typescript\n// Log errors for monitoring\nif (error) {\n  console.error('Testimonial fetch failed:', {\n    error: error.message,\n    timestamp: new Date().toISOString(),\n    userAgent: navigator.userAgent,\n    url: window.location.href\n  });\n}\n```\n\n## Performance Optimization\n\n### Caching Strategy\n\n- **Browser Cache**: 5 minutes for testimonial data\n- **Server Cache**: Leverage existing KV cache in API\n- **Image Cache**: Use existing image optimization pipeline\n\n### Loading Strategy\n\n- **Asynchronous**: Non-blocking page load\n- **Lazy Images**: Progressive image loading\n- **Skeleton Loading**: Placeholder while loading\n\n## Security Considerations\n\n### Input Validation\n- Validate API response structure\n- Sanitize testimonial text content\n- Validate image URLs before rendering\n\n### Rate Limiting\n- API calls are client-side, leverage existing API rate limiting\n- Cache reduces API call frequency\n\n## Testing Strategy\n\n### Unit Tests\n- Data transformation functions\n- Error handling scenarios\n- Cache operations\n\n### Integration Tests\n- API client functionality\n- Component rendering with mock data\n- Error boundary behavior\n\n### E2E Tests\n- Homepage loads with testimonials\n- Fallback behavior when API fails\n- Image loading and optimization\n\n## Deployment Strategy\n\n### Feature Flag Implementation\n\n```typescript\n// Allow gradual rollout\nconst ENABLE_DYNAMIC_TESTIMONIALS = import.meta.env.VITE_ENABLE_DYNAMIC_TESTIMONIALS;\n\n// Conditional loading\nif (ENABLE_DYNAMIC_TESTIMONIALS) {\n  testimonials = await fetchTestimonials();\n} else {\n  testimonials = await getCollection('testimonials');\n}\n```\n\n### Rollback Plan\n- Feature flag allows instant rollback\n- Static testimonials always available as fallback\n- Monitor error rates and performance metrics\n\n## Monitoring & Analytics\n\n### Key Metrics\n- API response time\n- Cache hit rate\n- Error rate\n- Testimonial load success rate\n- User engagement with testimonial section\n\n### Logging\n- API call success/failure\n- Cache performance\n- Error details with context\n- Performance timings\n\n## Migration Plan\n\n### Phase 1: Development\n- Implement API client\n- Update TestimonialSection component\n- Add error handling and fallbacks\n- Comprehensive testing\n\n### Phase 2: Testing\n- Unit and integration tests\n- Performance testing\n- Error scenario testing\n- Cross-browser testing\n\n### Phase 3: Deployment\n- Feature flag rollout (10% traffic)\n- Monitor metrics and errors\n- Gradual traffic increase\n- Full rollout after 24 hours stable\n\n### Phase 4: Cleanup\n- Remove feature flag\n- Update documentation\n- Remove old static testimonial files (after confirmation)\n\n## Change Log\n\n| Date | Version | Author | Changes |\n|------|---------|--------|---------|\n| 2025-12-16 | 1.0 | Architect | Initial design document |",
  "fileStats": {
    "size": 7225,
    "lines": 286,
    "lastModified": "2025-12-16T09:08:09.494Z"
  },
  "comments": []
}
