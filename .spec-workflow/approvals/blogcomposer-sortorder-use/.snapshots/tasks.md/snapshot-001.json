{
  "id": "snapshot_1761927196102_661jb1j3h",
  "approvalId": "approval_1761927196053_naxp1hrxb",
  "approvalTitle": "Blog Composer Sort Order Use - Tasks Document",
  "version": 1,
  "timestamp": "2025-10-31T16:13:16.102Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Verify and optimize database schema for sort order functionality\n  - File: packages/db/schema.ts (verify existing), packages/db/migrations/ (if needed)\n  - Verify existing sortOrder field in posts table schema\n  - Add database indexes for efficient three-layer sorting queries\n  - Purpose: Ensure database foundation supports sort order operations\n  - _Leverage: packages/db/schema.ts, packages/db/client.ts\n  - _Requirements: 1.1, 1.4\n  - _Prompt: Role: Database Engineer with expertise in SQLite and Drizzle ORM | Task: Verify the existing sortOrder field in posts table and add composite indexes for three-layer sorting (sort_order = 0, sort_order ASC, updated_at DESC) following requirements 1.1 and 1.4 | Restrictions: Do not modify existing schema unnecessarily, ensure backward compatibility, create migration if indexes are added | Success: Database schema supports sort order operations, indexes improve query performance, existing data remains intact\n\n- [ ] 2. Update API routes to implement three-layer sorting logic\n  - File: apps/api/src/routes/posts.ts (modify existing)\n  - Modify GET /api/posts endpoint to apply three-layer sorting\n  - Add sort order validation to POST/PUT endpoints\n  - Purpose: Enable API to return posts in correct sort order\n  - _Leverage: apps/api/src/routes/posts.ts, packages/db/schema.ts\n  - _Requirements: 5.1, 5.2, 5.3\n  - _Prompt: Role: Backend API Developer with expertise in Hono and database queries | Task: Update posts API routes to implement three-layer sorting logic (ORDER BY sort_order = 0, sort_order ASC, updated_at DESC) and add sort order validation following requirements 5.1, 5.2, and 5.3 | Restrictions: Maintain existing API contract, do not break existing functionality, ensure proper error handling for invalid sort orders | Success: API returns posts in correct order, sort order validation prevents invalid data, existing endpoints remain functional\n\n- [ ] 3. Create batch sort order update API endpoint\n  - File: apps/api/src/routes/posts.ts (add new endpoint)\n  - Implement POST /api/posts/batch-sort-order endpoint\n  - Add transaction handling for atomic updates\n  - Purpose: Support drag-and-drop reordering operations\n  - _Leverage: apps/api/src/routes/posts.ts, packages/db/client.ts\n  - _Requirements: 5.4\n  - _Prompt: Role: Backend API Developer with expertise in batch operations and transactions | Task: Create new POST /api/posts/batch-sort-order endpoint to handle drag-and-drop reordering with atomic transaction updates following requirement 5.4 | Restrictions: Must use database transactions for consistency, validate all sort order values, handle concurrent update conflicts | Success: Batch updates work atomically, drag-and-drop operations are reliable, proper error handling for conflicts\n\n- [ ] 4. Create SortOrderField component for blog composer\n  - File: apps/admin/app/components/SortOrderField.tsx (new)\n  - Implement form field with validation for sort order input\n  - Add user-friendly display for sort order = 0 as \"自動排序\"\n  - Purpose: Provide UI for manual sort order input in blog composer\n  - _Leverage: packages/ui/, apps/admin/app/components/BlogComposer.tsx\n  - _Requirements: 2.1, 2.2, 4.1, 4.2\n  - _Prompt: Role: React Frontend Developer with expertise in form components and validation | Task: Create SortOrderField component with numeric input validation, user-friendly display for sort_order = 0, and proper error handling following requirements 2.1, 2.2, 4.1, and 4.2 | Restrictions: Must integrate with existing form validation, follow UI component patterns, provide clear user feedback | Success: Component validates input correctly, displays sort order intuitively, integrates seamlessly with blog composer form\n\n- [ ] 5. Integrate SortOrderField into BlogComposer component\n  - File: apps/admin/app/components/BlogComposer.tsx (modify existing)\n  - Add SortOrderField to the basic information section\n  - Update form schema to include sort order validation\n  - Purpose: Enable sort order input in blog post creation/editing\n  - _Leverage: apps/admin/app/components/BlogComposer.tsx, apps/admin/app/components/SortOrderField.tsx\n  - _Requirements: 2.3, 2.4\n  - _Prompt: Role: React Frontend Developer with expertise in form integration and Zod validation | Task: Integrate SortOrderField into BlogComposer form, update Zod schema for sort order validation, and handle form submission with sort order data following requirements 2.3 and 2.4 | Restrictions: Do not break existing form functionality, maintain form validation flow, ensure sort order saves correctly | Success: Sort order field appears in blog composer, form validates sort order input, data saves to database properly\n\n- [ ] 6. Add sort order column to PostManagement table\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Add sort order column to display current sort order values\n  - Show \"自動排序\" for sort_order = 0 values\n  - Purpose: Display current sort order status in admin interface\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, @tanstack/react-table\n  - _Requirements: 3.4, 3.5\n  - _Prompt: Role: React Frontend Developer with expertise in TanStack Table | Task: Add sort order column to PostManagement table displaying current values with user-friendly labels for sort_order = 0 following requirements 3.4 and 3.5 | Restrictions: Do not break existing table functionality, maintain table performance, follow existing column patterns | Success: Sort order column displays correctly, table remains performant, users can see current sort order values\n\n- [ ] 7. Create DragHandle component for dnd-kit integration\n  - File: apps/admin/app/components/DragHandle.tsx (new)\n  - Implement visual drag handle with grip icon\n  - Add dnd-kit listeners and accessibility attributes\n  - Purpose: Provide visual drag activation point for table rows\n  - _Leverage: @dnd-kit/core, packages/ui/\n  - _Requirements: 5.1, 5.2, 5.3\n  - _Prompt: Role: React Frontend Developer with expertise in dnd-kit and accessibility | Task: Create DragHandle component with visual grip icon, dnd-kit integration, and proper ARIA attributes following requirements 5.1, 5.2, and 5.3 | Restrictions: Must work with dnd-kit's drag activation, provide proper accessibility, follow existing UI patterns | Success: Drag handle is visually clear, integrates with dnd-kit properly, accessible for keyboard navigation\n\n- [ ] 8. Integrate dnd-kit into PostManagement component\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Add dnd-kit providers and sensors to table\n  - Implement drag start/end event handlers\n  - Purpose: Enable drag-and-drop functionality for table rows\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, @dnd-kit/core, @dnd-kit/sortable\n  - _Requirements: 5.4, 5.5, 5.6\n  - _Prompt: Role: React Frontend Developer with expertise in dnd-kit integration | Task: Integrate dnd-kit into PostManagement table with proper providers, sensors, and event handling for drag-and-drop reordering following requirements 5.4, 5.5, and 5.6 | Restrictions: Do not break existing table functionality, maintain table sorting and filtering, handle drag conflicts properly | Success: Drag and drop works smoothly, table maintains other functionality, visual feedback is clear during drag operations\n\n- [ ] 9. Implement sort order update logic for drag-and-drop\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Add logic to calculate new sort orders after drag operations\n  - Implement optimistic UI updates with error handling\n  - Purpose: Update sort orders when posts are reordered via drag-and-drop\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, apps/api/src/routes/posts.ts\n  - _Requirements: 5.4, 5.5, 5.6\n  - _Prompt: Role: React Frontend Developer with expertise in state management and API integration | Task: Implement sort order recalculation logic after drag operations, add optimistic updates with rollback on errors, and call batch sort order API following requirements 5.4, 5.5, and 5.6 | Restrictions: Must handle concurrent updates properly, provide user feedback for errors, maintain data consistency | Success: Drag operations update sort orders correctly, UI provides feedback, errors are handled gracefully with rollback\n\n- [ ] 10. Add DragHandle to table rows conditionally\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Show DragHandle only for posts with sort_order > 0\n  - Add visual indicators for draggable vs non-draggable rows\n  - Purpose: Provide clear drag activation points for sortable posts\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, apps/admin/app/components/DragHandle.tsx\n  - _Requirements: 5.1, 5.2\n  - _Prompt: Role: React Frontend Developer with expertise in conditional rendering and UI states | Task: Add DragHandle component to table rows conditionally for posts with sort_order > 0, with clear visual indicators following requirements 5.1 and 5.2 | Restrictions: Only show drag handles for sortable posts, maintain table layout, provide clear visual hierarchy | Success: Drag handles appear only where appropriate, UI is clear about draggable items, table layout remains intact\n\n- [ ] 11. Update PostManagement sorting to use three-layer logic\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Modify table sorting to use three-layer sorting by default\n  - Ensure sorting works with drag-and-drop operations\n  - Purpose: Display posts in correct order according to business logic\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, @tanstack/react-table\n  - _Requirements: 3.1, 3.2, 3.3\n  - _Prompt: Role: React Frontend Developer with expertise in table sorting and data manipulation | Task: Update PostManagement table to use three-layer sorting (sort_order = 0, sort_order ASC, updated_at DESC) as default, ensuring compatibility with drag-and-drop following requirements 3.1, 3.2, and 3.3 | Restrictions: Maintain existing filter and search functionality, ensure sorting works with drag operations, preserve user sorting preferences | Success: Table displays posts in correct order, sorting works with drag-and-drop, existing functionality remains intact\n\n- [ ] 12. Add comprehensive error handling and user feedback\n  - File: apps/admin/app/components/PostManagement.tsx (modify existing)\n  - Add error handling for drag operations and API failures\n  - Implement loading states and success notifications\n  - Purpose: Provide clear user feedback for all operations\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, sonner (toast library)\n  - _Requirements: All error handling requirements\n  - _Prompt: Role: React Frontend Developer with expertise in error handling and user experience | Task: Add comprehensive error handling for drag operations, API failures, and loading states with clear user notifications following all error handling requirements | Restrictions: Provide helpful error messages, maintain optimistic updates, don't block user interactions unnecessarily | Success: Users receive clear feedback for all operations, errors are handled gracefully, loading states are appropriate\n\n- [ ] 13. Create unit tests for SortOrderField component\n  - File: apps/admin/app/components/SortOrderField.test.tsx (new)\n  - Test input validation and display logic\n  - Test error states and user interactions\n  - Purpose: Ensure SortOrderField component reliability\n  - _Leverage: apps/admin/app/components/SortOrderField.tsx, vitest\n  - _Requirements: 2.1, 2.2, 4.1, 4.2\n  - _Prompt: Role: QA Engineer with expertise in React component testing | Task: Create comprehensive unit tests for SortOrderField component covering validation, display logic, and user interactions following requirements 2.1, 2.2, 4.1, and 4.2 | Restrictions: Test component in isolation, cover edge cases, ensure tests are maintainable | Success: Component behavior is well-tested, edge cases covered, tests provide confidence in component reliability\n\n- [ ] 14. Create unit tests for DragHandle component\n  - File: apps/admin/app/components/DragHandle.test.tsx (new)\n  - Test dnd-kit integration and accessibility features\n  - Test visual states and user interactions\n  - Purpose: Ensure DragHandle component works correctly with dnd-kit\n  - _Leverage: apps/admin/app/components/DragHandle.tsx, vitest, @testing-library/react\n  - _Requirements: 5.1, 5.2, 5.3\n  - _Prompt: Role: QA Engineer with expertise in accessibility testing and dnd-kit | Task: Create unit tests for DragHandle component covering dnd-kit integration, accessibility features, and visual states following requirements 5.1, 5.2, and 5.3 | Restrictions: Mock dnd-kit dependencies appropriately, test accessibility compliance, ensure tests are reliable | Success: DragHandle integrates properly with dnd-kit, accessibility features work correctly, component is thoroughly tested\n\n- [ ] 15. Create integration tests for drag-and-drop functionality\n  - File: apps/admin/app/components/PostManagement.test.tsx (modify/add)\n  - Test complete drag-and-drop workflows\n  - Test sort order updates and API integration\n  - Purpose: Ensure drag-and-drop feature works end-to-end\n  - _Leverage: apps/admin/app/components/PostManagement.tsx, vitest, @testing-library/react\n  - _Requirements: 5.4, 5.5, 5.6\n  - _Prompt: Role: QA Engineer with expertise in integration testing and user workflows | Task: Create integration tests for drag-and-drop functionality covering complete user workflows, sort order updates, and API integration following requirements 5.4, 5.5, and 5.6 | Restrictions: Test realistic user scenarios, mock API calls appropriately, ensure tests are maintainable | Success: Drag-and-drop workflows work correctly, integration points are tested, user experience is validated\n\n- [ ] 16. Create API integration tests for sort order endpoints\n  - File: apps/api/src/routes/posts.test.ts (modify/add)\n  - Test three-layer sorting API responses\n  - Test batch sort order update endpoint\n  - Purpose: Ensure API endpoints work correctly with sort order functionality\n  - _Leverage: apps/api/src/routes/posts.ts, vitest\n  - _Requirements: 5.1, 5.2, 5.3, 5.4\n  - _Prompt: Role: QA Engineer with expertise in API testing and database integration | Task: Create API integration tests for sort order functionality covering three-layer sorting responses and batch update operations following requirements 5.1, 5.2, 5.3, and 5.4 | Restrictions: Test with real database operations, ensure data consistency, cover error scenarios | Success: API endpoints return correct data, sort order operations work reliably, error handling is comprehensive\n\n- [ ] 17. Perform end-to-end testing and final integration\n  - File: Multiple files (integration testing)\n  - Test complete user workflows from blog composer to drag-and-drop\n  - Verify data consistency across all components\n  - Purpose: Ensure complete feature works correctly end-to-end\n  - _Leverage: All implemented components and API endpoints\n  - _Requirements: All requirements\n  - _Prompt: Role: QA Engineer with expertise in end-to-end testing and system integration | Task: Perform comprehensive end-to-end testing of the complete sort order feature covering all user workflows, data consistency, and integration points following all requirements | Restrictions: Test in realistic environments, verify cross-browser compatibility, ensure performance meets requirements | Success: Complete feature works correctly, all user workflows succeed, system is ready for production\n\n- [ ] 18. Update documentation and cleanup\n  - File: README files, inline code comments\n  - Add documentation for new sort order functionality\n  - Clean up temporary code and add final comments\n  - Purpose: Ensure codebase is well-documented and maintainable\n  - _Leverage: All modified files\n  - _Requirements: All requirements\n  - _Prompt: Role: Technical Writer and Senior Developer with expertise in documentation | Task: Update all relevant documentation, add comprehensive code comments, and perform final cleanup following all requirements | Restrictions: Maintain existing documentation standards, ensure comments are helpful and accurate, do not leave debug code | Success: Codebase is well-documented, new functionality is clearly explained, code is clean and maintainable\n",
  "fileStats": {
    "size": 16392,
    "lines": 164,
    "lastModified": "2025-10-31T16:13:05.820Z"
  },
  "comments": []
}
