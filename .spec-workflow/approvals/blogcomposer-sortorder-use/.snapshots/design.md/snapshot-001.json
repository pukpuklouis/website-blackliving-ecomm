{
  "id": "snapshot_1761926625635_87kbfptyw",
  "approvalId": "approval_1761926625609_5dzrl9l5r",
  "approvalTitle": "Blog Composer Sort Order Use - Design Document",
  "version": 1,
  "timestamp": "2025-10-31T16:03:45.635Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Blog Composer Sort Order Use feature implements comprehensive sort order functionality for blog posts in the Black Living e-commerce platform. This feature enables content creators to manually control the display order of blog posts through drag-and-drop reordering and manual sort order input, while maintaining a three-layer sorting system that prioritizes manually ordered content over system-sorted content.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **TypeScript 5.x**: All new code will use strict TypeScript with proper type definitions\n- **React 19.x**: Component development follows React best practices with hooks\n- **Tailwind CSS**: Utility-first styling with consistent design tokens\n- **Drizzle ORM**: Database operations use type-safe queries\n- **Cloudflare D1**: SQLite-compatible database for data persistence\n- **Astro.js**: Server-side rendering for optimal performance\n\n### Project Structure (structure.md)\n- **Modular Components**: Sort order logic separated from core post functionality\n- **Feature-based Organization**: Related components and utilities grouped together\n- **Type Safety**: Comprehensive TypeScript interfaces for all data structures\n- **Consistent Naming**: kebab-case for files, PascalCase for components\n- **Import Patterns**: Barrel exports for clean public APIs\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **BlogComposer** (`apps/admin/app/components/BlogComposer.tsx`): Admin form component to extend with sort order field\n- **PostManagement** (`apps/admin/app/components/PostManagement.tsx`): Posts list component to extend with drag-and-drop sorting\n- **UI Components** (`packages/ui/`): Button, Input, Select, Dialog components for admin interface\n- **Database Schema** (`packages/db/schema.ts`): Posts table already includes sortOrder field\n\n### Integration Points\n\n- **Database Schema** (`packages/db/schema.ts`): Extend posts table sortOrder field usage\n- **API Routes** (`apps/api/src/routes/`): Update posts CRUD operations to handle three-layer sorting\n- **Type Definitions** (`packages/types/`): Extend blog post types with sort order properties\n- **Admin Dashboard** (`apps/admin/`): Integrate sort order controls and drag-and-drop functionality\n\n## Architecture\n\n### Component Architecture\n\n```mermaid\ngraph TD\n    A[PostManagement] --> B[SortablePostsTable]\n    B --> C[DragHandle]\n    B --> D[SortOrderBadge]\n\n    E[BlogComposer] --> F[SortOrderField]\n    F --> G[SortOrderInput]\n    F --> H[SortOrderValidation]\n\n    I[API Layer] --> J[PostsController]\n    J --> K[ThreeLayerSorting]\n    K --> L[D1QueryBuilder]\n```\n\n### Data Flow Architecture\n\n```mermaid\ngraph TD\n    A[Admin Interface] --> B[PostManagement Component]\n    B --> C[Drag & Drop Events]\n    C --> D[Sort Order Updates]\n    D --> E[API Request]\n    E --> F[Cloudflare Worker]\n    F --> G[Drizzle ORM]\n    G --> H[Cloudflare D1]\n    H --> I[Response]\n    I --> J[UI Update]\n\n    K[Blog Composer] --> L[Sort Order Input]\n    L --> M[Form Validation]\n    M --> N[API Save]\n    N --> O[D1 Update]\n```\n\n## Components and Interfaces\n\n### SortablePostsTable Component (New)\n\n**Purpose:** Enhanced posts table with drag-and-drop sorting capabilities\n**Location:** `apps/admin/app/components/SortablePostsTable.tsx`\n\n**Props:**\n```typescript\ninterface SortablePostsTableProps {\n  posts: Post[];\n  onSortOrderUpdate: (postId: string, newSortOrder: number) => Promise<void>;\n  onPostSelect: (post: Post) => void;\n  loading?: boolean;\n}\n```\n\n**Key Methods:**\n- `handleDragStart()`: Initialize drag operation\n- `handleDragOver()`: Handle drag preview and drop zones\n- `handleDrop()`: Process drop event and update sort orders\n- `updateSortOrders()`: Batch update sort orders after drag operation\n\n### SortOrderField Component (New)\n\n**Purpose:** Form field component for sort order input in blog composer\n**Location:** `apps/admin/app/components/SortOrderField.tsx`\n\n**Props:**\n```typescript\ninterface SortOrderFieldProps {\n  value: number;\n  onChange: (value: number) => void;\n  error?: string;\n  disabled?: boolean;\n}\n```\n\n**Key Methods:**\n- `validateSortOrder()`: Client-side validation for sort order input\n- `formatSortOrder()`: Display formatting for sort order values\n\n### DragHandle Component (New)\n\n**Purpose:** Visual drag handle for sortable table rows\n**Location:** `apps/admin/app/components/DragHandle.tsx`\n\n**Props:**\n```typescript\ninterface DragHandleProps {\n  isDragging?: boolean;\n  disabled?: boolean;\n  onDragStart?: () => void;\n  onDragEnd?: () => void;\n}\n```\n\n## Data Models\n\n### Extended BlogPost Model\n\n```typescript\ninterface BlogPost {\n  // Existing fields...\n  id: string;\n  title: string;\n  slug: string;\n  description: string;\n  content: string;\n  // ... other existing fields\n\n  // Sort order field (already exists in schema)\n  sortOrder: number; // Default: 0\n\n  // Metadata\n  createdAt: Date;\n  updatedAt: Date;\n}\n```\n\n### SortOrderUpdate Model\n\n```typescript\ninterface SortOrderUpdate {\n  postId: string;\n  sortOrder: number;\n  updatedAt: Date;\n}\n\ninterface BatchSortOrderUpdate {\n  updates: SortOrderUpdate[];\n  updatedBy: string;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Drag & Drop Operation Failure:**\n   - **Handling:** Revert UI to previous state, show error notification\n   - **User Impact:** Visual feedback with clear error message\n\n2. **Sort Order Validation Failure:**\n   - **Handling:** Form validation with inline error messages\n   - **User Impact:** Cannot save invalid sort order values\n\n3. **API Update Failure:**\n   - **Handling:** Rollback optimistic updates, show retry option\n   - **User Impact:** Temporary UI inconsistency resolved automatically\n\n4. **Concurrent Edit Conflict:**\n   - **Handling:** Server-side conflict detection with merge resolution\n   - **User Impact:** Clear notification of conflicting changes\n\n## Testing Strategy\n\n### Unit Testing\n- **SortablePostsTable Component:** Test drag-and-drop event handling\n- **SortOrderField Component:** Test input validation and formatting\n- **API Sorting Logic:** Test three-layer sorting algorithm\n- **Utility Functions:** Test sort order calculation and validation helpers\n\n### Integration Testing\n- **Drag & Drop Workflow:** Test complete reorder operation from UI to database\n- **Form Submission:** Test sort order saving in blog composer\n- **API Integration:** Test sorted data retrieval and updates\n\n### End-to-End Testing\n- **Admin Sort Order Management:** Create, edit, and reorder posts\n- **Data Persistence:** Verify sort orders survive page refreshes\n- **Multi-user Scenarios:** Test concurrent editing scenarios\n\n## Implementation Plan\n\n### Phase 1: Database & API Foundation\n1. Verify existing sortOrder field in posts table schema\n2. Update API routes to implement three-layer sorting logic\n3. Add sort order validation in API endpoints\n4. Create database migration if needed (though field already exists)\n\n### Phase 2: Admin Interface - Sort Order Input\n1. Add SortOrderField component to BlogComposer\n2. Integrate form validation for sort order input\n3. Update blog post form submission to handle sort order\n4. Add sort order display in post management table\n\n### Phase 3: Drag & Drop Sorting Implementation\n1. Create SortablePostsTable component with drag-and-drop\n2. Implement drag handle UI and interaction logic\n3. Add batch sort order update functionality\n4. Integrate optimistic UI updates with error handling\n\n### Phase 4: Integration & Testing\n1. End-to-end testing of complete sort order workflow\n2. Performance testing for drag-and-drop operations\n3. Accessibility testing for keyboard navigation\n4. Cross-browser compatibility testing\n\n## Database Schema Changes\n\nThe posts table already includes the sortOrder field:\n\n```sql\nsortOrder: integer('sort_order').default(0), // For manual ordering\n```\n\n### Index Optimization\n\nAdd database index for efficient sorting queries:\n\n```sql\n-- Composite index for three-layer sorting\nCREATE INDEX idx_posts_sort_order ON posts(sort_order = 0, sort_order, updated_at DESC);\n\n-- Additional index for admin queries\nCREATE INDEX idx_posts_admin_sort ON posts(status, sort_order = 0, sort_order, updated_at DESC);\n```\n\n## API Changes\n\n### GET /api/posts (Admin)\n\n**Current:** Returns posts without specific ordering\n**Updated:** Returns posts with three-layer sorting applied\n\n**Query Logic:**\n```sql\nORDER BY (sort_order = 0), sort_order ASC, updated_at DESC\n```\n\n### POST /api/posts (Create)\n\n**Current:** Creates post with default sortOrder = 0\n**Updated:** Accepts sortOrder in request body, defaults to 0\n\n### PUT /api/posts/:id (Update)\n\n**Current:** Updates post fields\n**Updated:** Includes sortOrder validation and update\n\n### New Endpoint: POST /api/posts/batch-sort-order\n\n**Purpose:** Batch update sort orders after drag-and-drop operations\n\n**Request Body:**\n```json\n{\n  \"updates\": [\n    { \"postId\": \"uuid\", \"sortOrder\": 1 },\n    { \"postId\": \"uuid\", \"sortOrder\": 2 }\n  ]\n}\n```\n\n## UI/UX Considerations\n\n### Drag & Drop Visual Feedback\n- Highlight drop zones during drag operations\n- Show drag preview with semi-transparent styling\n- Display loading states during sort order updates\n- Provide clear error states with retry options\n\n### Sort Order Input Design\n- Clear labeling: \"排序順序\" with helper text\n- Default value display: \"0 (自動排序)\"\n- Input validation with real-time feedback\n- Consistent styling with existing form fields\n\n### Accessibility Features\n- Keyboard navigation for drag-and-drop operations\n- Screen reader announcements for sort order changes\n- High contrast visual indicators for drag states\n- Alternative text for all interactive elements\n",
  "fileStats": {
    "size": 9660,
    "lines": 313,
    "lastModified": "2025-10-31T16:03:34.126Z"
  },
  "comments": []
}